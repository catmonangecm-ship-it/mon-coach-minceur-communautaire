<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Coach Minceur - Le Secret du Poids</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
    
    <!-- Firebase SDK - Version compatible -->
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 25px;
            background: #f0f0f0;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab:hover {
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .result-box {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .result-box.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        .result-box h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .weight-entry {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .weight-history {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .weight-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .weight-item .date {
            font-weight: 600;
            color: #667eea;
        }

        .weight-item .weight {
            font-size: 1.2em;
            font-weight: bold;
        }

        .weight-item .delete {
            background: #ff4757;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        canvas {
            max-width: 100%;
            margin-top: 20px;
        }

        .conseil-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .conseil-card h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .conseil-card p {
            color: #555;
            line-height: 1.6;
        }

        .motivation-box {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-top: 20px;
        }

        .motivation-box .quote {
            font-size: 1.3em;
            font-style: italic;
            color: #333;
            margin-bottom: 10px;
        }

        .motivation-box .author {
            color: #666;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .menu-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .menu-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .menu-card ul {
            list-style: none;
            padding-left: 0;
        }

        .menu-card li {
            padding: 5px 0;
            color: #555;
        }

        .menu-card li:before {
            content: "‚úì ";
            color: #4caf50;
            font-weight: bold;
        }

        #scannerContainer, #scannerFrigoContainer {
            position: relative;
            max-width: 100%;
            margin: 0 auto;
        }

        #interactive, #interactiveFrigo {
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
        }

        #interactive video, #interactiveFrigo video {
            width: 100%;
            height: auto;
            border-radius: 10px;
        }

        #interactive canvas, #interactiveFrigo canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .drawingBuffer {
            display: none;
        }

        .scan-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 100px;
            border: 3px solid #4caf50;
            border-radius: 10px;
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .scan-guide::after {
            content: "Placez le code-barres ici";
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            white-space: nowrap;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        /* Modal de connexion */
        #authModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10001;
            backdrop-filter: blur(5px);
        }

        #authModal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .auth-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: scaleIn 0.3s ease;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .auth-header p {
            color: #666;
            font-size: 0.95em;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: #f0f0f0;
            padding: 5px;
            border-radius: 10px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-input-group {
            margin-bottom: 20px;
        }

        .auth-input-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .auth-input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border 0.3s;
        }

        .auth-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .auth-error {
            background: #fee;
            color: #c00;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
            display: none;
        }

        .auth-success {
            background: #efe;
            color: #060;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .user-badge {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            color: white;
            font-size: 0.9em;
        }

        .notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
            z-index: 10002;
            font-size: 1em;
            font-weight: 600;
            animation: slideInRight 0.3s;
            opacity: 1;
            transition: opacity 0.3s;
        }

        @keyframes slideInRight {
            0% {
                transform: translateX(100px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 3px 15px rgba(76, 175, 80, 0.4);
            display: none;
            z-index: 9999;
            animation: fadeIn 0.3s;
        }

        .telegram-float {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #0088cc 0%, #006699 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            box-shadow: 0 5px 20px rgba(0, 136, 204, 0.4);
            cursor: pointer;
            z-index: 9998;
            transition: all 0.3s;
            text-decoration: none;
        }

        .telegram-float:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 136, 204, 0.6);
        }

        .telegram-float::after {
            content: "Rejoignez-nous !";
            position: absolute;
            right: 70px;
            background: #333;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            white-space: nowrap;
            font-size: 0.5em;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .telegram-float:hover::after {
            opacity: 1;
        }

        /* PLANIFICATEUR DE REPAS */
        .planning-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .planning-day {
            background: white;
            border-radius: 15px;
            padding: 15px;
            min-height: 400px;
        }

        .day-header {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1em;
        }

        .meal-slot {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            min-height: 80px;
            transition: all 0.3s;
        }

        .meal-slot.drag-over {
            background: #e3f2fd;
            border-color: #667eea;
        }

        .meal-slot-title {
            font-size: 0.85em;
            color: #999;
            margin-bottom: 5px;
        }

        .planned-meal {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 8px;
            border-radius: 8px;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .delete-btn {
            background: #f5576c;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .recipes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .recipe-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            cursor: grab;
            transition: transform 0.3s;
        }

        .recipe-card:hover {
            transform: translateY(-5px);
        }

        .recipe-card:active {
            cursor: grabbing;
        }

        .recipe-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .recipe-content {
            padding: 15px;
        }

        .recipe-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .recipe-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #666;
            align-items: center;
        }

        .recipe-calories {
            color: #667eea;
            font-weight: bold;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            margin-left: 5px;
            font-weight: 600;
        }

        .badge-scanne {
            background: #4caf50;
            color: white;
        }

        .badge-frigo {
            background: #2196f3;
            color: white;
        }

        .badge-perso {
            background: #ff6b6b;
            color: white;
        }

        .meal-entry {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }

        .meal-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .meal-time {
            font-weight: bold;
            color: #667eea;
        }

        .meal-calories {
            font-size: 1.2em;
            font-weight: bold;
            color: #764ba2;
        }

        .meal-items {
            font-size: 0.9em;
            color: #666;
        }

        @media (max-width: 1200px) {
            .planning-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }

            .weight-entry {
                grid-template-columns: 1fr;
            }

            .planning-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="syncIndicator" class="sync-indicator">
        ‚úÖ Synchronis√© !
    </div>

    <!-- Bouton flottant Telegram -->
    <a href="https://t.me/+GYg6ymUmOu01M2Nk" target="_blank" rel="noopener noreferrer" class="telegram-float" title="Rejoignez notre communaut√© Telegram">
        ‚úàÔ∏è
    </a>

    <!-- Modal de connexion/inscription -->
    <div id="authModal">
        <div class="auth-container">
            <div class="auth-header">
                <div style="font-size: 3em; margin-bottom: 15px;">üîê</div>
                <h2>Mon Coach Minceur</h2>
                <p>Connectez-vous pour acc√©der √† toutes les fonctionnalit√©s</p>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Connexion</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">Inscription</button>
            </div>

            <div id="authError" class="auth-error"></div>
            <div id="authSuccess" class="auth-success"></div>

            <!-- Formulaire de connexion -->
            <form id="loginForm" class="auth-form active" onsubmit="connexion(event)">
                <div class="auth-input-group">
                    <label>üìß Email</label>
                    <input type="email" id="loginEmail" placeholder="votre@email.com" required>
                </div>
                <div class="auth-input-group">
                    <label>üîí Mot de passe</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="auth-btn" id="loginBtn">
                    Se connecter
                </button>
            </form>

            <!-- Formulaire d'inscription -->
            <form id="registerForm" class="auth-form" onsubmit="inscription(event)">
                <div class="auth-input-group">
                    <label>üë§ Nom d'utilisateur</label>
                    <input type="text" id="registerName" placeholder="Votre nom" required>
                </div>
                <div class="auth-input-group">
                    <label>üìß Email</label>
                    <input type="email" id="registerEmail" placeholder="votre@email.com" required>
                </div>
                <div class="auth-input-group">
                    <label>üîí Mot de passe</label>
                    <input type="password" id="registerPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" required>
                    <small style="color: #999; font-size: 0.85em;">Minimum 6 caract√®res</small>
                </div>
                <div class="auth-input-group">
                    <label>üîí Confirmer le mot de passe</label>
                    <input type="password" id="registerPasswordConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" required>
                </div>
                <button type="submit" class="auth-btn" id="registerBtn">
                    Cr√©er mon compte
                </button>
            </form>

            <div style="text-align: center; margin-top: 20px; color: #999; font-size: 0.85em;">
                üåç Rejoignez la communaut√© Mon Coach Minceur
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div style="background: linear-gradient(135deg, #ff006e 0%, #ff6ec7 100%); padding: 15px 30px; border-radius: 25px; margin-bottom: 20px; box-shadow: 0 8px 25px rgba(255, 0, 110, 0.4); display: inline-block;">
                <h3 style="color: white; font-size: 1.8em; text-shadow: 3px 3px 6px rgba(0,0,0,0.3); letter-spacing: 2px; margin: 0;">
                    üê± CATJER LA CHATTE QUI RUGIT EN CUISINE üê±
                </h3>
            </div>
            <h1>üí™ Mon Coach Minceur</h1>
            <div id="userBadgeContainer" style="margin: 10px 0;"></div>
            <p>Votre programme personnalis√© pour atteindre vos objectifs</p>
        </div>

        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="showTab('profil')">üìä Mon Profil</button>
                <button class="tab" onclick="showTab('suivi')">üìà Suivi du Poids</button>
                <button class="tab" onclick="showTab('calculateur')">üßÆ Calculateur Calories</button>
                <button class="tab" onclick="showTab('planning')">üìÖ Planning Repas</button>
                <button class="tab" onclick="showTab('historique')">üìä Historique Repas</button>
                <button class="tab" onclick="showTab('scanner')">üì∑ Scanner Produit</button>
                <button class="tab" onclick="showTab('frigo')">üç≥ Frigo & Recettes</button>
                <button class="tab" onclick="showTab('baseperso')">üìù Ma Base Perso</button>
                <button class="tab" onclick="showTab('telegram')">üí¨ Communaut√©</button>
                <button class="tab" onclick="showTab('coachai')">ü§ñ Coach IA</button>
                <button class="tab" onclick="showTab('conseils')">ü•ó Conseils Nutrition</button>
                <button class="tab" onclick="showTab('motivation')">üí™ Motivation</button>
            </div>

            <!-- Onglet Profil -->
            <div id="profil" class="tab-content active">
                <h2>Cr√©ez votre profil personnalis√©</h2>
                
                <div class="form-group">
                    <label>Nom / Pr√©nom</label>
                    <input type="text" id="nom" placeholder="Entrez votre nom">
                </div>

                <div class="form-group">
                    <label>Sexe</label>
                    <select id="sexe">
                        <option value="femme">Femme</option>
                        <option value="homme">Homme</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>√Çge (ann√©es)</label>
                    <input type="number" id="age" placeholder="25" min="10" max="100">
                </div>

                <div class="form-group">
                    <label>Taille (cm)</label>
                    <input type="number" id="taille" placeholder="170" min="100" max="250">
                </div>

                <div class="form-group">
                    <label>Poids actuel (kg)</label>
                    <input type="number" id="poids" placeholder="70" step="0.1" min="30" max="300">
                </div>

                <div class="form-group">
                    <label>Poids objectif (kg)</label>
                    <input type="number" id="objectif" placeholder="65" step="0.1" min="30" max="300">
                </div>

                <div class="form-group">
                    <label>Niveau d'activit√©</label>
                    <select id="activite">
                        <option value="1.2">S√©dentaire (peu ou pas d'exercice)</option>
                        <option value="1.375">L√©g√®rement actif (exercice 1-3 jours/semaine)</option>
                        <option value="1.55">Mod√©r√©ment actif (exercice 3-5 jours/semaine)</option>
                        <option value="1.725">Tr√®s actif (exercice 6-7 jours/semaine)</option>
                        <option value="1.9">Extr√™mement actif (exercice intense quotidien)</option>
                    </select>
                </div>

                <button class="btn" onclick="calculerProfil()">Calculer mon programme</button>

                <div id="resultatProfil" class="result-box">
                    <h3>Votre bilan personnalis√©</h3>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="value" id="imcValue">-</div>
                            <div class="label">IMC</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="poidsIdealValue">-</div>
                            <div class="label">Poids id√©al (kg)</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="aPerdrValue">-</div>
                            <div class="label">√Ä perdre (kg)</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="caloriesValue">-</div>
                            <div class="label">Calories/jour</div>
                        </div>
                    </div>
                    <div id="imcCategorie" style="margin-top: 15px; font-size: 1.1em;"></div>
                    <div id="dureeProgramme" style="margin-top: 10px;"></div>
                    
                    <button class="btn" onclick="scrollToGraphiques()" style="margin-top: 20px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">
                        üìä Voir mon programme d√©taill√©
                    </button>
                </div>

                <!-- NOUVEAU GRAPHIQUE DE PROGRESSION -->
                <div id="graphiqueProgression" style="display: none; margin-top: 30px;">
                    <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                        <h2 style="color: #667eea; margin-bottom: 25px; text-align: center;">üìä Votre Programme de Perte de Poids</h2>
                        
                        <!-- Statistiques actuelles -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;" id="progressPoidsActuel">-</div>
                                <div style="opacity: 0.9; margin-top: 5px;">Poids actuel</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;" id="progressPoidsPerdu">0 kg</div>
                                <div style="opacity: 0.9; margin-top: 5px;">D√©j√† perdu</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;" id="progressPoidsRestant">-</div>
                                <div style="opacity: 0.9; margin-top: 5px;">Reste √† perdre</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold;" id="progressIMCActuel">-</div>
                                <div style="opacity: 0.9; margin-top: 5px;">IMC actuel</div>
                            </div>
                        </div>

                        <!-- Graphique calories -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                            <h3 style="color: #667eea; margin-bottom: 15px;">üî• D√©ficit calorique pour atteindre votre objectif</h3>
                            <canvas id="graphiqueCalories" width="400" height="150"></canvas>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 20px; text-align: center;">
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: #667eea;" id="caloriesJournalieres">-</div>
                                    <div style="font-size: 0.9em; color: #666;">Calories/jour</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: #f5576c;" id="deficitJour">-</div>
                                    <div style="font-size: 0.9em; color: #666;">D√©ficit/jour</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: #4caf50;" id="caloriesTotales">-</div>
                                    <div style="font-size: 0.9em; color: #666;">Total √† br√ªler</div>
                                </div>
                            </div>
                        </div>

                        <!-- Graphique progression poids -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                            <h3 style="color: #667eea; margin-bottom: 15px;">‚öñÔ∏è Progression du poids</h3>
                            <canvas id="graphiqueProgressionPoids" width="400" height="200"></canvas>
                        </div>

                        <!-- Timeline -->
                        <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 20px; border-radius: 10px;">
                            <h3 style="color: #333; margin-bottom: 15px;">üìÖ Votre timeline</h3>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="flex: 1; text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                    <div style="font-weight: bold; color: #667eea; font-size: 1.1em;">Aujourd'hui</div>
                                    <div id="timelineDebut" style="color: #666; margin-top: 5px;">-</div>
                                </div>
                                <div style="flex: 2; height: 4px; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 2px; position: relative;">
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 8px 15px; border-radius: 20px; border: 2px solid #667eea; white-space: nowrap; font-weight: bold; color: #667eea;" id="timelineDuree">
                                        - semaines
                                    </div>
                                </div>
                                <div style="flex: 1; text-align: center; padding: 15px; background: white; border-radius: 8px;">
                                    <div style="font-weight: bold; color: #4caf50; font-size: 1.1em;">Objectif atteint !</div>
                                    <div id="timelineFin" style="color: #666; margin-top: 5px;">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglet Suivi -->
            <div id="suivi" class="tab-content">
                <h2>Suivez votre progression</h2>
                
                <div class="weight-entry">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Date</label>
                        <input type="date" id="datePesee">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Poids (kg)</label>
                        <input type="number" id="poidsPesee" step="0.1" placeholder="70.5">
                    </div>
                    <button class="btn" onclick="ajouterPesee()" style="margin-top: 0;">Ajouter</button>
                </div>

                <div id="progressionActuelle"></div>

                <canvas id="graphiquePoids" width="400" height="200"></canvas>

                <div class="weight-history">
                    <h3 style="margin-bottom: 15px;">Historique des pes√©es</h3>
                    <div id="listePesees"></div>
                </div>
            </div>

            <!-- Onglet Calculateur de Calories -->
            <div id="calculateur" class="tab-content">
                <h2>Calculateur de Calories</h2>
                
                <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="text-align: center; color: #333; font-size: 1.1em; margin-bottom: 10px;">
                        üî¢ Calculez automatiquement les calories de vos aliments
                    </p>
                    <p style="text-align: center; color: #555; font-size: 0.95em;">
                        Tapez le nom d'un aliment, entrez la quantit√© en grammes, et obtenez instantan√©ment les informations nutritionnelles !
                    </p>
                    <p style="text-align: center; color: #667eea; font-size: 0.9em; margin-top: 10px; font-weight: 600;">
                        ‚ú® Tous vos produits scann√©s et enregistr√©s sont automatiquement disponibles ici !
                    </p>
                </div>

                <div style="background: white; border: 2px solid #667eea; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üîç Rechercher un aliment</h3>
                    
                    <!-- Boutons Scanner -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <button onclick="demarrerScannerCalculateur()" class="btn" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #ff6ec7 0%, #ff006e 100%); display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <span style="font-size: 1.2em;">üìä</span>
                            <span>Code-barres</span>
                        </button>
                        <button onclick="demarrerPhotoCalculateur()" class="btn" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <span style="font-size: 1.2em;">üì∑</span>
                            <span>Photo aliment</span>
                        </button>
                    </div>
                    
                    <!-- Zone de scanner code-barres -->
                    <div id="scannerCalculateur" style="display: none; margin-bottom: 15px;">
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 10px; text-align: center;">
                            <p style="margin: 0 0 10px 0; color: #666;">üìä Scannez le code-barres du produit</p>
                            <div id="videoCalculateur" style="position: relative; width: 100%; max-width: 400px; height: 300px; margin: 0 auto; background: #000; border-radius: 10px; overflow: hidden;"></div>
                        </div>
                        <button onclick="arreterScannerCalculateur()" class="btn" style="background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); width: 100%;">
                            üõë Arr√™ter
                        </button>
                    </div>

                    <!-- Zone de photo aliment -->
                    <div id="photoCalculateur" style="display: none; margin-bottom: 15px;">
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 10px; text-align: center;">
                            <p style="margin: 0 0 10px 0; color: #666;">üì∏ Prenez une photo claire de l'aliment</p>
                            <video id="videoPhotoCalculateur" style="width: 100%; max-width: 400px; border-radius: 10px; background: #000;" autoplay playsinline></video>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="capturerPhotoCalculateur()" class="btn" style="flex: 1; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">
                                üì∏ Capturer
                            </button>
                            <button onclick="arreterPhotoCalculateur()" class="btn" style="flex: 1; background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);">
                                üõë Annuler
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Nom de l'aliment</label>
                        <input type="text" id="searchAliment" placeholder="Ex: poulet, pomme, riz..." oninput="rechercherAliment()">
                        <div id="suggestionsAliments" style="background: white; border: 1px solid #e0e0e0; border-radius: 5px; margin-top: 5px; max-height: 300px; overflow-y: auto; display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label>Quantit√© (grammes)</label>
                        <input type="number" id="quantiteAliment" placeholder="100" min="1" step="1">
                    </div>

                    <button class="btn" onclick="ajouterAlimentCalcul()">‚ûï Ajouter √† mon repas</button>
                </div>

                <div id="repasActuel" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">üçΩÔ∏è Votre repas actuel</h3>
                    
                    <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="text-align: center; font-size: 0.9em; margin: 0;">
                            üí° <strong>Astuce :</strong> Sauvegardez ce repas pour pouvoir le glisser-d√©poser directement dans votre planning hebdomadaire !
                        </p>
                    </div>
                    
                    <div id="listeAlimentsRepas" style="margin-bottom: 15px;"></div>

                    <div class="stats" style="margin-top: 15px;">
                        <div class="stat-card" style="background: rgba(255, 255, 255, 0.2);">
                            <div class="value" id="totalCalories">0</div>
                            <div class="label">Calories totales (kcal)</div>
                        </div>
                        <div class="stat-card" style="background: rgba(255, 255, 255, 0.2);">
                            <div class="value" id="totalProteines">0</div>
                            <div class="label">Prot√©ines (g)</div>
                        </div>
                        <div class="stat-card" style="background: rgba(255, 255, 255, 0.2);">
                            <div class="value" id="totalGlucides">0</div>
                            <div class="label">Glucides (g)</div>
                        </div>
                        <div class="stat-card" style="background: rgba(255, 255, 255, 0.2);">
                            <div class="value" id="totalLipides">0</div>
                            <div class="label">Lipides (g)</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="sauvegarderRepas()" style="flex: 1; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">üíæ Sauvegarder ce repas</button>
                        <button class="btn" onclick="reinitialiserRepas()" style="flex: 1; background: linear-gradient(135deg, #ff4757 0%, #e84118 100%);">üóëÔ∏è Vider</button>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìÖ Historique de mes repas</h3>
                    
                    <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;">
                        <p style="color: #333; font-size: 1.1em; font-weight: bold; margin-bottom: 5px;">
                            Calories du jour : <span id="caloriesJour">0</span> kcal
                        </p>
                        <p id="objectifCaloriesMsg" style="color: #666; font-size: 0.9em; display: none;">
                            Objectif : <span id="objectifCaloriesValue">0</span> kcal
                        </p>
                        <div class="progress-bar" id="progressCaloriesJour" style="margin-top: 10px; display: none;">
                            <div class="progress-fill" id="progressCaloriesFill" style="width: 0%"></div>
                        </div>
                    </div>

                    <div id="historiqueRepas"></div>
                </div>
            </div>

            <!-- Onglet Planning Repas -->
            <div id="planning" class="tab-content">
                <h2>üìÖ Planning de la Semaine</h2>
                
                <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="text-align: center; color: #333; font-size: 1.1em; margin-bottom: 10px;">
                        üóìÔ∏è Planifiez vos repas de la semaine avec vos recettes
                    </p>
                    <p style="text-align: center; color: #555; font-size: 0.95em;">
                        <strong>‚ú® Simple et intuitif :</strong> Cr√©ez des recettes compl√®tes dans le Calculateur, puis glissez-d√©posez les dans votre planning hebdomadaire !
                    </p>
                </div>

                <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #333; margin-bottom: 15px;">üí° Comment √ßa marche ?</h3>
                    <ol style="color: #555; line-height: 2; margin-left: 20px;">
                        <li>üßÆ Allez dans <strong>Calculateur de Calories</strong></li>
                        <li>‚ûï Ajoutez plusieurs aliments pour cr√©er votre recette (ex: Poulet + Riz + L√©gumes)</li>
                        <li>üíæ Cliquez sur <strong>"Sauvegarder ce repas"</strong> et donnez un nom (ex: "Mon Poulet Complet")</li>
                        <li>üçΩÔ∏è Revenez ici et cliquez sur <strong>"Voir mes recettes"</strong></li>
                        <li>üéØ Glissez-d√©posez vos recettes dans les cases du planning !</li>
                    </ol>
                    <div style="background: rgba(255,255,255,0.7); padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <p style="color: #667eea; font-weight: bold; text-align: center; margin: 0;">
                            üé® Toutes vos recettes apparaissent en rose avec l'ic√¥ne üçΩÔ∏è
                        </p>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn" onclick="afficherRecettesPlanning()" style="width: auto; margin: 0;">
                        üç≥ Voir mes recettes
                    </button>
                    <button class="btn" onclick="showTab('calculateur')" style="width: auto; margin: 0; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">
                        ‚ûï Cr√©er une recette
                    </button>
                    <button class="btn" onclick="viderPlanning()" style="width: auto; margin: 0; background: linear-gradient(135deg, #ff4757 0%, #e84118 100%);">
                        üóëÔ∏è Vider le planning
                    </button>
                </div>

                <div id="recettes-planning-container" style="display: none; margin-bottom: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Mes Recettes Disponibles</h3>
                    <div class="recipes-grid" id="recipes-planning"></div>
                </div>

                <div class="planning-grid" id="planning-container"></div>
            </div>

            <!-- Onglet Historique Repas -->
            <div id="historique" class="tab-content">
                <h2>üìà Historique des 7 derniers jours</h2>
                
                <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="text-align: center; color: #333; font-size: 1.1em;">
                        üìä Visualisez vos repas et calories des derniers jours
                    </p>
                </div>

                <div id="history-container"></div>
            </div>

            <!-- Onglet Scanner (code existant) -->
            <div id="scanner" class="tab-content">
                <h2>Scanner un produit alimentaire</h2>
                
                <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="text-align: center; color: #333; font-size: 1.1em; margin-bottom: 15px;">
                        üì± Trouvez les informations nutritionnelles de vos produits
                    </p>
                    <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 8px;">
                        <p style="color: #1565c0; font-weight: bold; margin-bottom: 10px;">üóÑÔ∏è 4 Bases de donn√©es disponibles :</p>
                        <ol style="color: #555; font-size: 0.9em; line-height: 1.8; margin-left: 20px;">
                            <li><strong>Base locale</strong> - ${baseProduitsCourants.length} produits fran√ßais courants ‚ö°</li>
                            <li><strong>Votre base perso</strong> - Vos produits personnalis√©s (<span id="compteurProduitsScannerPerso">0</span>) üìù</li>
                            <li><strong>Base communautaire</strong> - Partag√©e par tous les utilisateurs (<span id="compteurBaseScannerCommunautaire">${baseCommunautaire.length.toLocaleString()}</span>) üåç</li>
                            <li><strong>OpenFoodFacts</strong> - Base mondiale collaborative (2 millions+ produits) üåê</li>
                        </ol>
                        <p style="color: #666; font-size: 0.85em; margin-top: 10px; text-align: center;">
                            üí° La recherche se fait automatiquement dans cet ordre jusqu'√† trouver votre produit
                        </p>
                    </div>
                </div>

                <div style="margin-bottom: 30px; padding: 25px; background: linear-gradient(135deg, #e3f2fd 0%, #e1bee7 100%); border-radius: 10px; border: 3px solid #667eea;">
                    <h3 style="margin-bottom: 15px; color: #667eea; text-align: center;">‚å®Ô∏è M√©thode 1 : Saisie manuelle</h3>
                    <p style="text-align: center; color: #666; margin-bottom: 15px; font-size: 0.95em;">
                        ‚ú® <strong>Recommand√©e sur mobile</strong> - Plus rapide, plus fiable, pas de permission cam√©ra !
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="text" id="manualBarcode" placeholder="Saisissez les 13 chiffres du code-barres" style="flex: 1; padding: 15px; border: 3px solid #667eea; border-radius: 12px; font-size: 18px; min-width: 250px; font-weight: 500;" inputmode="numeric" pattern="[0-9]*">
                        <button class="btn" onclick="rechercherCodeBarre()" style="width: auto; margin: 0; padding: 15px 35px; font-size: 18px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">üîç Rechercher</button>
                    </div>
                    <p style="margin-top: 12px; color: #666; font-size: 0.9em; text-align: center;">
                        üí° Le code-barres se trouve au dos du produit (13 chiffres)<br>
                        Exemple : 3017620422003
                    </p>
                    <div style="background: rgba(255,255,255,0.8); padding: 12px; border-radius: 8px; margin-top: 12px;">
                        <p style="text-align: center; color: #1565c0; font-weight: bold; margin: 0;">
                            ‚ö° Sur Android : Utilisez cette m√©thode pour √©viter les probl√®mes de cam√©ra !
                        </p>
                    </div>
                </div>

                <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #fff9e6 0%, #ffe6f0 100%); border-radius: 10px; border: 2px solid #ffc107;">
                    <h3 style="margin-bottom: 15px; color: #f57c00; text-align: center;">üì∑ M√©thode 2 : Scanner avec la cam√©ra</h3>
                    <p style="text-align: center; color: #666; margin-bottom: 15px; font-size: 0.9em;">
                        Scannez directement le code-barres du produit
                    </p>

                    <div style="text-align: center; margin-bottom: 15px;">
                        <button class="btn" id="startScanBtn" onclick="demarrerScanner()" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">
                            üì∑ Activer le scanner
                        </button>
                        <button class="btn" id="stopScanBtn" onclick="arreterScanner()" style="display: none; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);">
                            ‚èπÔ∏è Arr√™ter le scanner
                        </button>
                    </div>

                    <div id="scannerContainer" style="max-width: 640px; margin: 0 auto; position: relative; background: #000; border-radius: 10px; overflow: hidden;">
                        <div id="scanPlaceholder" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 60px 20px; text-align: center;">
                            <div style="font-size: 4em; margin-bottom: 15px;">üì∑</div>
                            <p style="color: white; font-size: 1.1em; line-height: 1.6;">
                                Cliquez sur "Activer le scanner" pour utiliser votre cam√©ra<br>
                                <span style="font-size: 0.9em; opacity: 0.9;">Assurez-vous d'autoriser l'acc√®s √† la cam√©ra</span>
                            </p>
                        </div>
                        <div id="interactive" style="display: none; position: relative;">
                            <div class="scan-guide"></div>
                        </div>
                    </div>
                </div>

                <div id="loadingScanner" style="display: none; text-align: center; padding: 40px;">
                    <div style="font-size: 3em; animation: spin 1s linear infinite;">‚åõ</div>
                    <p style="color: #667eea; font-size: 1.2em; margin-top: 10px;">Recherche en cours...</p>
                </div>

                <div id="resultatScanner" style="display: none;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üì¶ Informations du produit</h3>
                    
                    <div style="background: white; border: 2px solid #667eea; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 20px; align-items: start; flex-wrap: wrap;">
                            <img id="productImage" src="" alt="Produit" style="width: 150px; height: 150px; object-fit: contain; border-radius: 8px; background: #f8f9fa;">
                            <div style="flex: 1; min-width: 200px;">
                                <h4 id="productName" style="color: #333; margin-bottom: 10px; font-size: 1.3em;"></h4>
                                <p id="productBrand" style="color: #667eea; font-weight: 600; margin-bottom: 5px;"></p>
                                <p id="productQuantity" style="color: #666; margin-bottom: 10px;"></p>
                                <p id="productBarcode" style="color: #999; font-size: 0.9em;"></p>
                            </div>
                        </div>
                    </div>

                    <div class="stats">
                        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div class="value" id="productCalories">-</div>
                            <div class="label">Calories (kcal/100g)</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <div class="value" id="productProteines">-</div>
                            <div class="label">Prot√©ines (g/100g)</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <div class="value" id="productGlucides">-</div>
                            <div class="label">Glucides (g/100g)</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <div class="value" id="productLipides">-</div>
                            <div class="label">Lipides (g/100g)</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                        <button class="btn" onclick="ajouterProduitScanneAuCalculateur()" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">
                            üßÆ Ajouter au Calculateur
                        </button>
                        <button class="btn" onclick="sauvegarderProduit()" style="flex: 1; min-width: 200px;">
                            üíæ Sauvegarder ce produit
                        </button>
                    </div>
                </div>

                <div id="erreurScanner" style="display: none; background: #ffebee; color: #c62828; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h4 style="margin-bottom: 10px;">‚ùå Produit non trouv√©</h4>
                    <p>Ce code-barres n'a pas √©t√© trouv√© dans notre base de donn√©es. Essayez avec un autre produit ou v√©rifiez le code saisi.</p>
                </div>

                <div id="erreurPermission" style="display: none; background: #fff3cd; border: 2px solid #ffc107; color: #856404; padding: 25px; border-radius: 10px; margin-top: 20px;">
                    <h4 style="margin-bottom: 15px; font-size: 1.2em;">üö´ Acc√®s cam√©ra refus√© ou non disponible</h4>
                    <p style="margin-bottom: 15px; line-height: 1.6;">Le navigateur n'a pas pu acc√©der √† la cam√©ra. Voici comment le r√©soudre :</p>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h5 style="color: #667eea; margin-bottom: 10px;">üì± Sur Android (Chrome/Firefox) :</h5>
                        <ol style="line-height: 2; margin-left: 20px;">
                            <li><strong>V√©rifier les permissions Android :</strong>
                                <ul style="margin-left: 20px; margin-top: 5px;">
                                    <li>Param√®tres ‚Üí Applications</li>
                                    <li>Cherchez votre navigateur (Chrome, Firefox...)</li>
                                    <li>Permissions ‚Üí Appareil photo ‚Üí Autoriser</li>
                                </ul>
                            </li>
                            <li><strong>Dans le navigateur :</strong>
                                <ul style="margin-left: 20px; margin-top: 5px;">
                                    <li>Cliquez sur le cadenas üîí √† c√¥t√© de l'URL</li>
                                    <li>Autorisations ‚Üí Appareil photo ‚Üí Autoriser</li>
                                    <li>Rechargez la page</li>
                                </ul>
                            </li>
                        </ol>
                    </div>

                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h5 style="color: #667eea; margin-bottom: 10px;">üíª Sur ordinateur :</h5>
                        <ol style="line-height: 2; margin-left: 20px;">
                            <li>Cliquez sur l'ic√¥ne üîí ou üîì dans la barre d'adresse</li>
                            <li>Autorisez l'acc√®s √† la cam√©ra</li>
                            <li>Rechargez la page et r√©essayez</li>
                        </ol>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <p style="color: #1565c0; font-weight: bold; margin-bottom: 10px;">üí° Solution alternative imm√©diate :</p>
                        <p style="margin-bottom: 10px;">Utilisez la <strong>saisie manuelle</strong> du code-barres en haut de cette page :</p>
                        <ul style="line-height: 1.8; margin-left: 20px;">
                            <li>‚úÖ Plus rapide et plus fiable</li>
                            <li>‚úÖ Pas besoin de cam√©ra</li>
                            <li>‚úÖ Fonctionne √† tous les coups</li>
                        </ul>
                    </div>
                </div>

                <div id="historiqueProduits" style="margin-top: 40px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìö Mes produits scann√©s</h3>
                    <div id="listeProduits"></div>
                </div>
            </div>

            <!-- Onglet Frigo (code existant minimal) -->
            <div id="frigo" class="tab-content">
                <h2>üç≥ Mon Frigo Virtuel & Suggestions de Recettes</h2>
                
                <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="text-align: center; color: #333; font-size: 1.1em; margin-bottom: 10px;">
                        üì± Scannez vos produits pour remplir votre frigo virtuel
                    </p>
                    <p style="text-align: center; color: #555; font-size: 0.95em;">
                        L'app vous sugg√©rera automatiquement des recettes adapt√©es √† vos ingr√©dients disponibles !
                    </p>
                </div>

                <!-- Scanner pour le frigo -->
                <div style="background: white; border: 3px solid #4caf50; border-radius: 10px; padding: 25px; margin-bottom: 20px;">
                    <h3 style="color: #4caf50; margin-bottom: 20px;">üì∑ Scanner vos produits pour le frigo</h3>
                    
                    <!-- M√©thode 1 : Scanner cam√©ra -->
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #e1bee7 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #667eea; margin-bottom: 15px; text-align: center;">üì∏ M√©thode 1 : Scanner avec la cam√©ra</h4>
                        <p style="text-align: center; color: #666; margin-bottom: 15px;">
                            Activez la cam√©ra pour scanner automatiquement les codes-barres de vos produits
                        </p>
                        
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
                            <button id="startScanBtnFrigo" class="btn" onclick="demarrerScannerFrigo()" style="margin: 0; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); flex: 1; min-width: 150px;">
                                üìä Scanner code-barres
                            </button>
                            <button class="btn" onclick="demarrerPhotoFrigo()" style="margin: 0; background: linear-gradient(135deg, #ff6ec7 0%, #ff006e 100%); flex: 1; min-width: 150px;">
                                üì∑ Photo aliment
                            </button>
                            <button id="stopScanBtnFrigo" class="btn" onclick="arreterScannerFrigo()" style="margin: 0; display: none; background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);">
                                ‚èπÔ∏è Arr√™ter
                            </button>
                        </div>

                        <!-- Zone de photo aliment -->
                        <div id="photoFrigo" style="display: none; margin-bottom: 15px;">
                            <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 10px; text-align: center;">
                                <p style="margin: 0 0 10px 0; color: #666;">üì∏ Prenez une photo claire de l'aliment</p>
                                <video id="videoPhotoFrigo" style="width: 100%; max-width: 400px; border-radius: 10px; background: #000;" autoplay playsinline></video>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="capturerPhotoFrigo()" class="btn" style="flex: 1; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">
                                    üì∏ Capturer
                                </button>
                                <button onclick="arreterPhotoFrigo()" class="btn" style="flex: 1; background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);">
                                    üõë Annuler
                                </button>
                            </div>
                        </div>

                        <!-- Zone de scan -->
                        <div id="scanPlaceholderFrigo" style="background: #f0f0f0; height: 300px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 1.2em; text-align: center; padding: 20px;">
                            üëÜ Cliquez sur "Activer le scanner" pour commencer
                        </div>
                        <div id="interactiveFrigo" style="display: none; position: relative; width: 100%; max-width: 640px; height: 480px; margin: 0 auto; border-radius: 10px; overflow: hidden;"></div>

                        <!-- Messages -->
                        <div id="loadingScannerFrigo" style="display: none; text-align: center; padding: 15px; background: #e3f2fd; border-radius: 8px; margin-top: 15px;">
                            <p style="color: #1565c0; margin: 0;">üîç Recherche du produit en cours...</p>
                        </div>

                        <div id="erreurPermissionFrigo" style="display: none; background: #fff3cd; border: 2px solid #ffc107; color: #856404; padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <h4 style="margin-bottom: 10px;">üö´ Acc√®s cam√©ra refus√©</h4>
                            <p style="margin: 0; font-size: 0.9em;">
                                Veuillez autoriser l'acc√®s √† la cam√©ra dans les param√®tres de votre navigateur, puis r√©essayez.
                                Sur Android : Param√®tres ‚Üí Applications ‚Üí Navigateur ‚Üí Permissions ‚Üí Cam√©ra ‚Üí Autoriser
                            </p>
                        </div>

                        <div id="produitScanneFrigo" style="display: none; background: #e8f5e9; border: 2px solid #4caf50; padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 2em;">‚úÖ</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; color: #2e7d32; font-size: 1.1em;" id="nomProduitScanneFrigo"></div>
                                    <div style="color: #666; font-size: 0.9em; margin-top: 5px;" id="infoProduitScanneFrigo"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- M√©thode 2 : Saisie manuelle -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 10px; text-align: center;">‚å®Ô∏è M√©thode 2 : Saisie manuelle</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <input type="text" id="scanFrigoManual" placeholder="Saisissez le code-barres (13 chiffres)" style="flex: 1; padding: 12px; border: 2px solid #4caf50; border-radius: 8px; min-width: 200px;" inputmode="numeric">
                            <button class="btn" onclick="scannerPourFrigoManuel()" style="margin: 0; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">
                                üîç Rechercher
                            </button>
                        </div>
                        <p style="color: #666; font-size: 0.85em; text-align: center; margin-top: 10px;">
                            üí° Le code-barres se trouve au dos du produit
                        </p>
                    </div>
                </div>

                <!-- Mon Frigo -->
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #667eea; margin: 0;">üßä Mon Frigo (<span id="compteurFrigo">0</span> produits)</h3>
                        <button class="btn" onclick="viderFrigo()" style="margin: 0; background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); padding: 10px 20px; font-size: 0.9em;">
                            üóëÔ∏è Vider le frigo
                        </button>
                    </div>

                    <div id="listeFrigo" style="min-height: 100px;"></div>

                    <button class="btn" onclick="suggererRecettes()" style="margin-top: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 1.1em; padding: 15px;">
                        üéØ Sugg√©rer des recettes avec mes ingr√©dients
                    </button>
                </div>

                <!-- R√©sultat suggestions -->
                <div id="suggestionRecettes" style="display: none; margin-top: 30px;"></div>

                <!-- Produits disponibles pour ajout rapide -->
                <div style="margin-top: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">‚ö° Ajouter rapidement au frigo</h3>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                        <p style="color: #856404; font-size: 0.95em; margin: 0;">
                            üí° <strong>Astuce :</strong> Cliquez sur un produit scann√© pr√©c√©demment pour l'ajouter rapidement √† votre frigo !
                        </p>
                    </div>

                    <div id="produitsDisponiblesFrigo"></div>
                </div>
            </div>

            <!-- Onglet Ma Base Perso (code existant) -->
            <div id="baseperso" class="tab-content">
                <h2>Ma Base de Donn√©es Personnelle</h2>
                
                <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="text-align: center; color: #333; font-size: 1.1em; margin-bottom: 10px;">
                        üìù Cr√©ez votre propre base de produits avec codes-barres
                    </p>
                    <p style="text-align: center; color: #555; font-size: 0.95em;">
                        Ajoutez des produits qui ne sont pas dans OpenFoodFacts et retrouvez-les instantan√©ment lors du scan !
                    </p>
                    <p style="text-align: center; color: #667eea; font-size: 0.9em; margin-top: 10px; font-weight: 600;">
                        ‚ú® Vos produits perso sont automatiquement disponibles partout dans l'app !
                    </p>
                </div>

                <div style="background: white; border: 3px solid #667eea; border-radius: 10px; padding: 25px; margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">‚ûï Ajouter un nouveau produit</h3>
                    
                    <div class="form-group">
                        <label>üì¶ Nom du produit *</label>
                        <input type="text" id="nomProduitPerso" placeholder="Ex: Mon yaourt maison, Pizza du restaurant..." required>
                    </div>

                    <div class="form-group">
                        <label>üè∑Ô∏è Marque (optionnel)</label>
                        <input type="text" id="marqueProduitPerso" placeholder="Ex: Marque maison">
                    </div>

                    <div class="form-group">
                        <label>üìä Code-barres (13 chiffres) *</label>
                        <input type="text" id="codebarreProduitPerso" placeholder="3017620422003" maxlength="13" pattern="[0-9]{13}">
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            üí° Si le produit n'a pas de code-barres, vous pouvez en g√©n√©rer un fictif (ex: 9999999999901)
                        </p>
                    </div>

                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #e1bee7 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">üìä Valeurs nutritionnelles pour 100g *</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>üî• Calories (kcal)</label>
                                <input type="number" id="caloriesProduitPerso" placeholder="250" min="0" step="1" required>
                            </div>

                            <div class="form-group" style="margin-bottom: 0;">
                                <label>üí™ Prot√©ines (g)</label>
                                <input type="number" id="proteinesProduitPerso" placeholder="10" min="0" step="0.1" required>
                            </div>

                            <div class="form-group" style="margin-bottom: 0;">
                                <label>üçû Glucides (g)</label>
                                <input type="number" id="glucidesProduitPerso" placeholder="30" min="0" step="0.1" required>
                            </div>

                            <div class="form-group" style="margin-bottom: 0;">
                                <label>üßà Lipides (g)</label>
                                <input type="number" id="lipidesProduitPerso" placeholder="5" min="0" step="0.1" required>
                            </div>
                        </div>
                    </div>

                    <button class="btn" onclick="ajouterProduitPerso()">üíæ Enregistrer ce produit</button>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìö Mes produits personnalis√©s (<span id="compteurProduitsPerso">0</span>)</h3>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                        <p style="color: #856404; font-size: 0.95em; margin: 0;">
                            üí° <strong>Astuce :</strong> Quand vous scannerez un code-barres, l'application cherchera d'abord dans votre base personnelle avant d'interroger OpenFoodFacts !
                        </p>
                    </div>

                    <div id="listeProduitsPerso"></div>
                </div>
            </div>

            <!-- Onglet Ma Base Perso (code existant) -->
            <div id="baseperso" class="tab-content">
                <h2>Ma Base de Donn√©es Personnelle</h2>
                
                <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="text-align: center; color: #333; font-size: 1.1em; margin-bottom: 10px;">
                        üìù Cr√©ez votre propre base de produits avec codes-barres
                    </p>
                    <p style="text-align: center; color: #555; font-size: 0.95em;">
                        Ajoutez des produits qui ne sont pas dans OpenFoodFacts et retrouvez-les instantan√©ment lors du scan !
                    </p>
                    <p style="text-align: center; color: #667eea; font-size: 0.9em; margin-top: 10px; font-weight: 600;">
                        ‚ú® Vos produits perso sont automatiquement disponibles partout dans l'app !
                    </p>
                </div>

                <div style="background: white; border: 3px solid #667eea; border-radius: 10px; padding: 25px; margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">‚ûï Ajouter un nouveau produit</h3>
                    
                    <div class="form-group">
                        <label>üì¶ Nom du produit *</label>
                        <input type="text" id="nomProduitPerso" placeholder="Ex: Mon yaourt maison, Pizza du restaurant..." required>
                    </div>

                    <div class="form-group">
                        <label>üè∑Ô∏è Marque (optionnel)</label>
                        <input type="text" id="marqueProduitPerso" placeholder="Ex: Marque maison">
                    </div>

                    <div class="form-group">
                        <label>üìä Code-barres (13 chiffres) *</label>
                        <input type="text" id="codebarreProduitPerso" placeholder="3017620422003" maxlength="13" pattern="[0-9]{13}">
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            üí° Si le produit n'a pas de code-barres, vous pouvez en g√©n√©rer un fictif (ex: 9999999999901)
                        </p>
                    </div>

                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #e1bee7 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">üìä Valeurs nutritionnelles pour 100g *</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>üî• Calories (kcal)</label>
                                <input type="number" id="caloriesProduitPerso" placeholder="250" min="0" step="1" required>
                            </div>

                            <div class="form-group" style="margin-bottom: 0;">
                                <label>üí™ Prot√©ines (g)</label>
                                <input type="number" id="proteinesProduitPerso" placeholder="10" min="0" step="0.1" required>
                            </div>

                            <div class="form-group" style="margin-bottom: 0;">
                                <label>üçû Glucides (g)</label>
                                <input type="number" id="glucidesProduitPerso" placeholder="30" min="0" step="0.1" required>
                            </div>

                            <div class="form-group" style="margin-bottom: 0;">
                                <label>üßà Lipides (g)</label>
                                <input type="number" id="lipidesProduitPerso" placeholder="5" min="0" step="0.1" required>
                            </div>
                        </div>
                    </div>

                    <button class="btn" onclick="ajouterProduitPerso()">üíæ Enregistrer ce produit</button>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìö Mes produits personnalis√©s (<span id="compteurProduitsPerso">0</span>)</h3>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                        <p style="color: #856404; font-size: 0.95em; margin: 0;">
                            üí° <strong>Astuce :</strong> Quand vous scannerez un code-barres, l'application cherchera d'abord dans votre base personnelle avant d'interroger OpenFoodFacts !
                        </p>
                    </div>

                    <div id="listeProduitsPerso"></div>
                </div>
            </div>

            <!-- Onglet Communaut√© Telegram -->
            <div id="telegram" class="tab-content">
                <h2>üí¨ Rejoignez la Communaut√© Telegram</h2>
                
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center;">
                    <div style="font-size: 4em; margin-bottom: 15px;">‚úàÔ∏è</div>
                    <h3 style="font-size: 1.8em; margin-bottom: 15px;">Rejoignez-nous sur Telegram !</h3>
                    <p style="font-size: 1.1em; opacity: 0.95; line-height: 1.6;">
                        Partagez votre progression, √©changez des recettes, posez vos questions et restez motiv√©(e) avec la communaut√© !
                    </p>
                </div>

                <!-- Canal principal -->
                <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                        <div style="font-size: 3em;">üì¢</div>
                        <div style="flex: 1;">
                            <h3 style="color: #667eea; margin-bottom: 5px;">Communaut√© Coach Minceur</h3>
                            <p style="color: #666; margin: 0;">Rejoignez notre groupe pour partager, √©changer et progresser ensemble !</p>
                        </div>
                    </div>
                    <a href="https://t.me/+GYg6ymUmOu01M2Nk" target="_blank" rel="noopener noreferrer" class="btn" style="display: inline-block; text-decoration: none; background: linear-gradient(135deg, #0088cc 0%, #006699 100%);">
                        ‚úàÔ∏è Rejoindre la communaut√©
                    </a>
                </div>

                <!-- Groupe d'entraide -->
                <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                        <div style="font-size: 3em;">üë•</div>
                        <div style="flex: 1;">
                            <h3 style="color: #667eea; margin-bottom: 5px;">Entraide & Motivation</h3>
                            <p style="color: #666; margin: 0;">√âchangez avec la communaut√©, partagez vos r√©ussites et d√©fis quotidiens</p>
                        </div>
                    </div>
                    <a href="https://t.me/+GYg6ymUmOu01M2Nk" target="_blank" rel="noopener noreferrer" class="btn" style="display: inline-block; text-decoration: none; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">
                        üí¨ Rejoindre le groupe
                    </a>
                </div>

                <!-- Recettes -->
                <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                        <div style="font-size: 3em;">üç≥</div>
                        <div style="flex: 1;">
                            <h3 style="color: #667eea; margin-bottom: 5px;">Recettes & Astuces</h3>
                            <p style="color: #666; margin: 0;">Des centaines de recettes saines et d√©licieuses partag√©es par la communaut√©</p>
                        </div>
                    </div>
                    <a href="https://t.me/+GYg6ymUmOu01M2Nk" target="_blank" rel="noopener noreferrer" class="btn" style="display: inline-block; text-decoration: none; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        üçΩÔ∏è Voir les recettes
                    </a>
                </div>

                <!-- Support technique -->
                <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                        <div style="font-size: 3em;">üõ†Ô∏è</div>
                        <div style="flex: 1;">
                            <h3 style="color: #667eea; margin-bottom: 5px;">Support & Aide</h3>
                            <p style="color: #666; margin: 0;">Besoin d'aide ? Contactez la communaut√© directement</p>
                        </div>
                    </div>
                    <a href="https://t.me/+GYg6ymUmOu01M2Nk" target="_blank" rel="noopener noreferrer" class="btn" style="display: inline-block; text-decoration: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        üÜò Obtenir de l'aide
                    </a>
                </div>

                <!-- Avantages -->
                <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 25px; border-radius: 15px;">
                    <h3 style="color: #333; margin-bottom: 20px; text-align: center;">üéÅ Avantages de rejoindre la communaut√©</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div class="conseil-card" style="background: white; padding: 15px; border-radius: 10px;">
                            <h4 style="color: #667eea; margin-bottom: 10px;">üí™ Motivation</h4>
                            <p style="color: #555; margin: 0;">Restez motiv√©(e) gr√¢ce au soutien de la communaut√©</p>
                        </div>
                        <div class="conseil-card" style="background: white; padding: 15px; border-radius: 10px;">
                            <h4 style="color: #667eea; margin-bottom: 10px;">üçΩÔ∏è Recettes</h4>
                            <p style="color: #555; margin: 0;">D√©couvrez de nouvelles recettes saines chaque jour</p>
                        </div>
                        <div class="conseil-card" style="background: white; padding: 15px; border-radius: 10px;">
                            <h4 style="color: #667eea; margin-bottom: 10px;">üìä Conseils</h4>
                            <p style="color: #555; margin: 0;">Des conseils d'experts en nutrition et fitness</p>
                        </div>
                        <div class="conseil-card" style="background: white; padding: 15px; border-radius: 10px;">
                            <h4 style="color: #667eea; margin-bottom: 10px;">üéØ D√©fis</h4>
                            <p style="color: #555; margin: 0;">Participez √† des d√©fis communautaires</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglet Coach IA (simplifi√©) -->
            <div id="coachai" class="tab-content">
                <h2>ü§ñ Votre Coach Personnel Intelligent</h2>
                
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; text-align: center;">
                    <h3 style="font-size: 1.5em; margin-bottom: 10px;">üëã Bonjour <span id="nomCoachIA">Champion</span> !</h3>
                    <p style="font-size: 1.1em; opacity: 0.95;">Votre coach personnel analyse vos donn√©es pour vous accompagner vers votre objectif</p>
                </div>

                <!-- Chat IA Gratuit -->
                <div style="background: white; border: 3px solid #667eea; border-radius: 15px; padding: 25px; margin-bottom: 25px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <div style="font-size: 3em;">ü§ñ</div>
                        <div>
                            <h3 style="color: #667eea; margin: 0;">Coach IA en Direct</h3>
                            <p style="color: #666; margin: 5px 0 0 0; font-size: 0.9em;">Posez-moi toutes vos questions sur la nutrition, le sport, la motivation...</p>
                        </div>
                    </div>

                    <!-- Configuration de la cl√© API -->
                    <div id="configCleAPI" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 2em;">üîë</span>
                            <h4 style="color: white; margin: 0;">Configuration de votre cl√© API Groq</h4>
                        </div>
                        
                        <p style="color: rgba(255,255,255,0.9); font-size: 0.9em; margin-bottom: 15px;">
                            Pour utiliser le Coach IA, vous avez besoin d'une <strong>cl√© API Groq gratuite</strong> (100% gratuit, 2 minutes pour l'obtenir)
                        </p>

                        <!-- Instructions rapides -->
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <p style="color: white; font-weight: bold; margin: 0 0 10px 0;">üìã Comment obtenir votre cl√© (2 minutes) :</p>
                            <ol style="color: white; font-size: 0.9em; margin: 0; padding-left: 20px;">
                                <li>Ouvrir <a href="https://console.groq.com/" target="_blank" style="color: #ffd700; text-decoration: underline;">console.groq.com</a></li>
                                <li>Cr√©er un compte gratuit (email + mot de passe)</li>
                                <li>Aller dans "API Keys" ‚Üí "Create API Key"</li>
                                <li>Copier la cl√© (commence par <code style="background: rgba(0,0,0,0.2); padding: 2px 5px; border-radius: 3px;">gsk_...</code>)</li>
                                <li>Coller la cl√© ci-dessous et sauvegarder</li>
                            </ol>
                        </div>

                        <!-- Champ de saisie de la cl√© -->
                        <div style="margin-bottom: 15px;">
                            <label style="color: white; font-weight: bold; display: block; margin-bottom: 5px;">
                                üîê Votre cl√© API Groq :
                            </label>
                            <input 
                                type="text" 
                                id="cleAPIGroq" 
                                placeholder="gsk_..." 
                                style="
                                    width: calc(100% - 30px);
                                    padding: 12px 15px;
                                    border: 2px solid white;
                                    border-radius: 8px;
                                    font-size: 0.95em;
                                    font-family: monospace;
                                    background: rgba(255,255,255,0.9);
                                "
                            />
                        </div>

                        <!-- Boutons -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button 
                                onclick="sauvegarderCleAPI()" 
                                style="
                                    flex: 1;
                                    min-width: 150px;
                                    padding: 12px 20px;
                                    background: #4caf50;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    font-size: 1em;
                                "
                            >
                                üíæ Sauvegarder la cl√©
                            </button>
                            <button 
                                onclick="testerCleAPI()" 
                                style="
                                    flex: 1;
                                    min-width: 150px;
                                    padding: 12px 20px;
                                    background: #ffc107;
                                    color: #333;
                                    border: none;
                                    border-radius: 8px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    font-size: 1em;
                                "
                            >
                                üß™ Tester la cl√©
                            </button>
                        </div>

                        <!-- Statut -->
                        <div id="statutCleAPI" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;">
                        </div>
                    </div>

                    <!-- Zone de conversation -->
                    <div id="chatIA" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; min-height: 200px;">
                        <div style="text-align: center; padding: 40px 20px; color: #999;">
                            <div style="font-size: 3em; margin-bottom: 10px;">üí¨</div>
                            <p>Configurez votre cl√© API ci-dessus pour commencer !</p>
                            <p style="font-size: 0.85em; margin-top: 10px;">Une fois la cl√© configur√©e, posez toutes vos questions au Coach IA !</p>
                        </div>
                    </div>

                    <!-- Zone de saisie -->
                    <div style="display: flex; gap: 10px; background: white; padding: 10px; border-radius: 10px;">
                        <input 
                            type="text"
                            id="questionIA" 
                            autocomplete="off"
                            placeholder="Tapez votre question ici..." 
                            style="
                                width: 100%;
                                padding: 15px; 
                                border: 3px solid #667eea; 
                                border-radius: 10px; 
                                font-size: 16px; 
                                background: #ffffff;
                                color: #000000;
                            " 
                            onkeypress="if(event.key === 'Enter') { envoyerQuestionIA(); }"
                            disabled
                        />
                        <button 
                            id="btnEnvoyerIA"
                            onclick="envoyerQuestionIA()" 
                            style="
                                background: #667eea; 
                                color: white;
                                padding: 15px 30px; 
                                border: none;
                                border-radius: 10px;
                                font-size: 16px;
                                font-weight: bold;
                                cursor: pointer;
                            "
                            disabled
                        >
                            üì§ Envoyer
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 15px;">
                        <small style="color: #999;">‚ú® IA gratuite et illimit√©e ‚Ä¢ R√©ponses en quelques secondes</small>
                    </div>
                </div>

                <div id="tableauBordIA" style="margin-bottom: 25px;"></div>
                <div id="suggestionsCollations" style="margin-bottom: 25px;"></div>
                <div id="conseilsPersonnalises" style="margin-bottom: 25px;"></div>
                <div id="motivationAdaptee" style="margin-bottom: 25px;"></div>

                <button class="btn" onclick="actualiserCoachIA()" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">
                    üîÑ Actualiser mes recommandations
                </button>
            </div>

            <!-- Onglet Conseils (simplifi√©) -->
            <div id="conseils" class="tab-content">
                <h2>Conseils Nutrition & Bien-√™tre</h2>
                
                <div class="conseil-card">
                    <h4>ü•ó R√®gle n¬∞1 : L'√©quilibre alimentaire</h4>
                    <p>Privil√©giez une alimentation vari√©e et √©quilibr√©e. Chaque repas devrait contenir des prot√©ines, des glucides complexes, des l√©gumes et de bonnes graisses. Ne sautez jamais de repas !</p>
                </div>

                <div class="conseil-card">
                    <h4>üíß R√®gle n¬∞2 : L'hydratation</h4>
                    <p>Buvez au moins 1,5 √† 2 litres d'eau par jour. L'eau aide √† √©liminer les toxines, favorise la digestion et peut r√©duire la sensation de faim. Commencez votre journ√©e avec un grand verre d'eau.</p>
                </div>

                <div class="conseil-card">
                    <h4>‚è∞ R√®gle n¬∞3 : Les horaires r√©guliers</h4>
                    <p>Mangez √† heures fixes pour r√©guler votre m√©tabolisme. Id√©alement : petit-d√©jeuner avant 9h, d√©jeuner entre 12h et 13h, d√Æner avant 20h. √âvitez de grignoter entre les repas.</p>
                </div>
            </div>

            <!-- Onglet Motivation (simplifi√©) -->
            <div id="motivation" class="tab-content">
                <h2>Votre dose de motivation quotidienne</h2>
                
                <div class="motivation-box">
                    <div class="quote" id="citationJour"></div>
                    <div class="author" id="auteurCitation"></div>
                </div>

                <!-- Section Telegram dans Motivation -->
                <div style="background: linear-gradient(135deg, #0088cc 0%, #006699 100%); padding: 25px; border-radius: 15px; margin-top: 30px; text-align: center;">
                    <div style="font-size: 3em; margin-bottom: 15px;">‚úàÔ∏è</div>
                    <h3 style="color: white; font-size: 1.5em; margin-bottom: 15px;">Rejoignez notre communaut√© Telegram !</h3>
                    <p style="color: rgba(255,255,255,0.95); font-size: 1.1em; line-height: 1.6; margin-bottom: 20px;">
                        Partagez votre motivation avec des milliers de personnes qui poursuivent le m√™me objectif que vous !
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <a href="https://t.me/+GYg6ymUmOu01M2Nk" target="_blank" rel="noopener noreferrer" class="btn" style="display: inline-block; text-decoration: none; background: white; color: #0088cc; margin: 0; width: auto; padding: 15px 30px; font-weight: bold;">
                            üí¨ Rejoindre maintenant
                        </a>
                        <button class="btn" onclick="showTab('telegram')" style="background: rgba(255,255,255,0.2); color: white; margin: 0; width: auto; padding: 15px 30px;">
                            üì± En savoir plus
                        </button>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üéØ Vos objectifs de la semaine</h3>
                    
                    <div class="conseil-card">
                        <h4>Lundi : D√©marrage en douceur</h4>
                        <p>Commencez la semaine du bon pied ! Buvez un grand verre d'eau au r√©veil et prenez un petit-d√©jeuner complet. Fixez-vous 3 objectifs pour la semaine.</p>
                    </div>

                    <div class="conseil-card">
                        <h4>Mardi : Jour des prot√©ines</h4>
                        <p>Assurez-vous d'avoir des prot√©ines √† chaque repas aujourd'hui. Elles vous aideront √† vous sentir rassasi√© plus longtemps et √† maintenir votre masse musculaire.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==============================================
        // CONFIGURATION FIREBASE
        // ==============================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyAVsE39uVXpYQy_aehNS8f_bo94U-NWI28",
            authDomain: "moncoachminceurcatjer.firebaseapp.com",
            projectId: "moncoachminceurcatjer",
            storageBucket: "moncoachminceurcatjer.firebasestorage.app",
            messagingSenderId: "441403074242",
            appId: "1:441403074242:web:b38009005e7fa4e012bd5b",
            measurementId: "G-M2JY1PDKQW"
        };

        // Variables Firebase
        let db = null;
        let auth = null;
        let firebaseInitialized = false;
        let currentUser = null;
        let firebaseLoadAttempts = 0;
        const MAX_FIREBASE_ATTEMPTS = 50; // 5 secondes max

        // Fonction d'initialisation Firebase am√©lior√©e
        function initialiserFirebase() {
            firebaseLoadAttempts++;
            
            // V√©rifier que Firebase est charg√©
            if (typeof firebase === 'undefined') {
                if (firebaseLoadAttempts >= MAX_FIREBASE_ATTEMPTS) {
                    console.log('‚ùå Firebase n\'a pas pu se charger apr√®s 5 secondes. Mode local activ√©.');
                    firebaseInitialized = false;
                    const authModal = document.getElementById('authModal');
                    if (authModal) authModal.style.display = 'none';
                    return;
                }
                console.log('‚è≥ Chargement Firebase... Tentative', firebaseLoadAttempts);
                setTimeout(initialiserFirebase, 100);
                return;
            }

            try {
                // Initialiser Firebase
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                firebaseInitialized = true;
                
                console.log('‚úÖ Firebase initialis√© avec succ√®s !');
                console.log('üåç Base collaborative activ√©e !');
                console.log('üîê Authentification activ√©e !');
                
                // Observer l'√©tat de connexion
                auth.onAuthStateChanged(function(user) {
                    if (user) {
                        currentUser = user;
                        console.log('üë§ Utilisateur connect√©:', user.email);
                        
                        // Mettre √† jour le nom dans userData
                        if (user.displayName) {
                            userData.nom = user.displayName;
                            sauvegarderUserData();
                        }
                        
                        // Masquer le modal de connexion
                        const modal = document.getElementById('authModal');
                        if (modal) modal.classList.remove('active');
                        
                        // Afficher le badge utilisateur
                        afficherBadgeUtilisateur();
                        
                    } else {
                        currentUser = null;
                        console.log('üë§ Aucun utilisateur connect√©');
                        
                        // Afficher le modal de connexion
                        const modal = document.getElementById('authModal');
                        if (modal) modal.classList.add('active');
                    }
                });

                // Synchroniser la base communautaire
                setTimeout(() => {
                    synchroniserBaseCommunautaire();
                }, 2000);
                
                // Synchroniser toutes les heures
                setInterval(() => {
                    synchroniserBaseCommunautaire();
                }, 60 * 60 * 1000);

            } catch (error) {
                console.log('‚ö†Ô∏è Erreur Firebase:', error);
                firebaseInitialized = false;
                const authModal = document.getElementById('authModal');
                if (authModal) authModal.style.display = 'none';
            }
        }

        // ==============================================
        // FONCTIONS D'AUTHENTIFICATION
        // ==============================================

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelector('.auth-tab:first-child').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelector('.auth-tab:last-child').classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
            
            hideAuthMessages();
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
            const successDiv = document.getElementById('authSuccess');
            if (successDiv) successDiv.style.display = 'none';
        }

        function showAuthSuccess(message) {
            const successDiv = document.getElementById('authSuccess');
            if (successDiv) {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
            }
            const errorDiv = document.getElementById('authError');
            if (errorDiv) errorDiv.style.display = 'none';
        }

        function hideAuthMessages() {
            const errorDiv = document.getElementById('authError');
            const successDiv = document.getElementById('authSuccess');
            if (errorDiv) errorDiv.style.display = 'none';
            if (successDiv) successDiv.style.display = 'none';
        }

        async function inscription(event) {
            event.preventDefault();
            
            if (!firebaseInitialized || !auth) {
                showAuthError('Firebase n\'est pas encore initialis√©. Veuillez patienter...');
                return;
            }
            
            hideAuthMessages();

            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            if (password !== passwordConfirm) {
                showAuthError('Les mots de passe ne correspondent pas');
                return;
            }

            const btn = document.getElementById('registerBtn');
            btn.disabled = true;
            btn.textContent = 'Cr√©ation en cours...';

            try {
                // Cr√©er l'utilisateur
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Mettre √† jour le profil avec le nom
                await userCredential.user.updateProfile({
                    displayName: name
                });

                // Sauvegarder les infos suppl√©mentaires dans Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    nom: name,
                    email: email,
                    dateInscription: firebase.firestore.FieldValue.serverTimestamp(),
                    produitsPartages: 0
                });

                showAuthSuccess('‚úÖ Compte cr√©√© avec succ√®s ! Connexion...');
                
                setTimeout(() => {
                    document.getElementById('authModal').classList.remove('active');
                    afficherNotification('üéâ Bienvenue ' + name + ' !', 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)');
                }, 1500);

            } catch (error) {
                console.error('Erreur inscription:', error);
                let message = 'Erreur lors de l\'inscription';
                
                if (error.code === 'auth/email-already-in-use') {
                    message = 'Cet email est d√©j√† utilis√©';
                } else if (error.code === 'auth/weak-password') {
                    message = 'Le mot de passe est trop faible';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'Email invalide';
                }
                
                showAuthError(message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Cr√©er mon compte';
            }
        }

        async function connexion(event) {
            event.preventDefault();
            
            if (!firebaseInitialized || !auth) {
                showAuthError('Firebase n\'est pas encore initialis√©. Veuillez patienter...');
                return;
            }
            
            hideAuthMessages();

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            btn.textContent = 'Connexion...';

            try {
                await auth.signInWithEmailAndPassword(email, password);
                
                showAuthSuccess('‚úÖ Connexion r√©ussie !');
                
                setTimeout(() => {
                    document.getElementById('authModal').classList.remove('active');
                }, 1000);

            } catch (error) {
                console.error('Erreur connexion:', error);
                let message = 'Erreur lors de la connexion';
                
                if (error.code === 'auth/user-not-found') {
                    message = 'Aucun compte avec cet email';
                } else if (error.code === 'auth/wrong-password') {
                    message = 'Mot de passe incorrect';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'Email invalide';
                } else if (error.code === 'auth/too-many-requests') {
                    message = 'Trop de tentatives. R√©essayez plus tard';
                }
                
                showAuthError(message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Se connecter';
            }
        }

        async function deconnexion() {
            if (!confirm('Voulez-vous vraiment vous d√©connecter ?')) {
                return;
            }

            try {
                await auth.signOut();
                afficherNotification('üëã √Ä bient√¥t !', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');
                
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('Erreur d√©connexion:', error);
                afficherNotification('‚ùå Erreur lors de la d√©connexion', 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)');
            }
        }

        function afficherBadgeUtilisateur() {
            const container = document.getElementById('userBadgeContainer');
            if (container && currentUser) {
                container.innerHTML = `
                    <div class="user-badge">
                        <span>üë§ ${currentUser.displayName || currentUser.email}</span>
                        <button onclick="deconnexion()" style="background: rgba(255,255,255,0.3); border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; color: white; font-size: 0.9em;">
                            üö™ D√©connexion
                        </button>
                    </div>
                `;
            }
        }

        // ==============================================
        // VARIABLES POUR LA BASE COLLABORATIVE
        // ==============================================
        
        let baseCommunautaire = [];
        let statsGlobales = {
            totalProduits: 0,
            produitsAujourdhui: 0,
            derniereSync: null
        };

        // ==============================================
        // BASE DE DONN√âES PRODUITS LOCAUX
        // ==============================================
        
        const baseProduitsCourants = [
            // Produits laitiers
            { barcode: "3228021170004", nom: "Pr√©sident Beurre Doux", marque: "Pr√©sident", calories: 745, proteines: 0.7, glucides: 0.6, lipides: 82, image: "https://images.openfoodfacts.org/images/products/322/802/117/0004/front_fr.3.400.jpg" },
            { barcode: "3228021000004", nom: "Pr√©sident Camembert", marque: "Pr√©sident", calories: 297, proteines: 19.5, glucides: 0.5, lipides: 24, image: "" },
            { barcode: "3033710065912", nom: "Danone Activia Nature", marque: "Danone", calories: 67, proteines: 4.4, glucides: 5.6, lipides: 2.9, image: "" },
            { barcode: "3033490002107", nom: "Danone Yaourt Nature", marque: "Danone", calories: 46, proteines: 3.6, glucides: 5.1, lipides: 1.2, image: "" },
            
            // Pains et viennoiseries
            { barcode: "3250391753550", nom: "Pain de Mie Complet", marque: "Harry's", calories: 247, proteines: 8.9, glucides: 41, lipides: 4.1, image: "" },
            { barcode: "3250391409181", nom: "Brioche Tranch√©e", marque: "Harry's", calories: 351, proteines: 8.8, glucides: 49, lipides: 12, image: "" },
            
            // Viandes et charcuteries
            { barcode: "3250391409150", nom: "Jambon Blanc 4 Tranches", marque: "Fleury Michon", calories: 115, proteines: 20, glucides: 1, lipides: 3.5, image: "" },
            { barcode: "3302740132001", nom: "Jambon de Paris", marque: "Herta", calories: 125, proteines: 19, glucides: 1.5, lipides: 5, image: "" },
            
            // P√¢tes et riz
            { barcode: "3228857000166", nom: "Panzani P√¢tes Spaghetti", marque: "Panzani", calories: 359, proteines: 12, glucides: 72, lipides: 1.5, image: "" },
            { barcode: "8076809513463", nom: "Barilla Penne Rigate", marque: "Barilla", calories: 359, proteines: 12.5, glucides: 71, lipides: 1.5, image: "" },
            { barcode: "3502110004383", nom: "Taureau Ail√© Riz Long Grain", marque: "Taureau Ail√©", calories: 349, proteines: 7.2, glucides: 78, lipides: 0.6, image: "" },
            
            // Conserves
            { barcode: "3222475787560", nom: "Thon Naturel", marque: "Saupiquet", calories: 110, proteines: 25, glucides: 0, lipides: 1, image: "" },
            { barcode: "3502110005557", nom: "Cassoulet", marque: "William Saurin", calories: 115, proteines: 6.5, glucides: 8.5, lipides: 6, image: "" },
            
            // Huiles
            { barcode: "3123930010003", nom: "Huile d'Olive", marque: "Puget", calories: 900, proteines: 0, glucides: 0, lipides: 100, image: "" },
            { barcode: "3274080005003", nom: "Huile de Tournesol", marque: "Lesieur", calories: 900, proteines: 0, glucides: 0, lipides: 100, image: "" },
            
            // Boissons
            { barcode: "5449000000996", nom: "Coca-Cola", marque: "Coca-Cola", calories: 42, proteines: 0, glucides: 10.6, lipides: 0, image: "" },
            { barcode: "5449000017871", nom: "Coca-Cola Zero", marque: "Coca-Cola", calories: 0.3, proteines: 0, glucides: 0, lipides: 0, image: "" },
            { barcode: "3124480191717", nom: "Evian 1.5L", marque: "Evian", calories: 0, proteines: 0, glucides: 0, lipides: 0, image: "" },
            
            // Chocolat et confiseries
            { barcode: "7622300489434", nom: "Milka Chocolat au Lait", marque: "Milka", calories: 530, proteines: 7, glucides: 59, lipides: 29, image: "" },
            { barcode: "80176732", nom: "Nutella", marque: "Ferrero", calories: 539, proteines: 6.3, glucides: 57.5, lipides: 30.9, image: "" },
            { barcode: "3017620422003", nom: "Nutella 400g", marque: "Ferrero", calories: 539, proteines: 6.3, glucides: 57.5, lipides: 30.9, image: "" },
            
            // C√©r√©ales
            { barcode: "5410188031317", nom: "Corn Flakes", marque: "Kellogg's", calories: 360, proteines: 7.5, glucides: 84, lipides: 0.9, image: "" },
            { barcode: "3228857001019", nom: "Chocapic", marque: "Nestl√©", calories: 377, proteines: 7.3, glucides: 74, lipides: 4.5, image: "" },
            
            // Biscuits
            { barcode: "3017760000000", nom: "Prince Chocolat", marque: "LU", calories: 458, proteines: 6.7, glucides: 65, lipides: 18, image: "" },
            { barcode: "3017760735001", nom: "Petit Beurre", marque: "LU", calories: 432, proteines: 7.3, glucides: 75, lipides: 11, image: "" },
            { barcode: "7622210701087", nom: "Or√©o", marque: "Mondelez", calories: 480, proteines: 5, glucides: 68, lipides: 20, image: "" },
            
            // Compotes et fruits
            { barcode: "3033490002824", nom: "Compote Pomme Nature", marque: "Andros", calories: 63, proteines: 0.3, glucides: 14, lipides: 0.2, image: "" },
            { barcode: "3270190207658", nom: "Compote Pomme-Poire", marque: "Materne", calories: 78, proteines: 0.3, glucides: 18, lipides: 0.1, image: "" },
            
            // Plats pr√©par√©s
            { barcode: "3760074380015", nom: "Taboul√© Oriental", marque: "Carrefour", calories: 158, proteines: 3.4, glucides: 20, lipides: 6.8, image: "" },
            { barcode: "3228857000234", nom: "Ravioli Pur B≈ìuf", marque: "Panzani", calories: 89, proteines: 4.5, glucides: 12, lipides: 2.5, image: "" },
            
            // Fromages
            { barcode: "3029330003502", nom: "Kiri 8 portions", marque: "Kiri", calories: 270, proteines: 8.5, glucides: 4, lipides: 24, image: "" },
            { barcode: "3073780970068", nom: "Babybel Original", marque: "Babybel", calories: 313, proteines: 22, glucides: 1, lipides: 25, image: "" },
            { barcode: "3222472560609", nom: "Emmental R√¢p√©", marque: "Pr√©sident", calories: 392, proteines: 28, glucides: 1.6, lipides: 30, image: "" },
            
            // Sauces
            { barcode: "8712100641060", nom: "Ketchup", marque: "Heinz", calories: 112, proteines: 1.2, glucides: 25, lipides: 0.1, image: "" },
            { barcode: "3250391493197", nom: "Mayonnaise", marque: "Amora", calories: 680, proteines: 1.2, glucides: 2.5, lipides: 74, image: "" },
            
            // Surgel√©s
            { barcode: "3228857001521", nom: "Pizza 4 Fromages", marque: "Buitoni", calories: 261, proteines: 11, glucides: 27, lipides: 11, image: "" },
            { barcode: "5410063018759", nom: "Frites Allumettes", marque: "Lutosa", calories: 172, proteines: 2.7, glucides: 27, lipides: 5.7, image: "" }
        ];
        
        // ==============================================
        // SYST√àME DE SYNCHRONISATION GLOBALE
        // ==============================================

        // Citations motivantes
        const citations = [
            { texte: "Le succ√®s, c'est la somme de petits efforts r√©p√©t√©s jour apr√®s jour.", auteur: "Robert Collier" },
            { texte: "Votre corps peut tout faire, c'est votre esprit qu'il faut convaincre.", auteur: "Anonyme" },
            { texte: "La motivation vous fait d√©marrer, l'habitude vous fait continuer.", auteur: "Jim Ryun" }
        ];

        // Donn√©es utilisateur
        let userData = JSON.parse(localStorage.getItem('userData')) || {};
        let pesees = JSON.parse(localStorage.getItem('pesees')) || [];
        let produitsSauvegardes = JSON.parse(localStorage.getItem('produits')) || [];
        let produitsPerso = JSON.parse(localStorage.getItem('produitsPerso')) || [];
        let produitsFrigo = JSON.parse(localStorage.getItem('produitsFrigo')) || [];
        let repasActuel = [];
        let repasSauvegardes = JSON.parse(localStorage.getItem('repas')) || [];
        let scannerActif = false;
        let dernierProduit = null;
        let dernierCodeDetecte = null;
        let timeoutDetection = null;

        // Fonctions de gestion des donn√©es utilisateur
        function sauvegarderUserData() {
            localStorage.setItem('userData', JSON.stringify(userData));
        }

        function chargerUserData() {
            const data = localStorage.getItem('userData');
            if (data) {
                userData = JSON.parse(data);
            }
            return userData;
        }

        // Planning hebdomadaire
        let planningHebdo = JSON.parse(localStorage.getItem('planningHebdo')) || {};
        let historiqueRepasHebdo = JSON.parse(localStorage.getItem('historiqueRepasHebdo')) || {};

        // ==============================================
        // BASE DE RECETTES AVEC INGR√âDIENTS
        // ==============================================
        
        const baseRecettes = [
            {
                nom: "Poulet R√¥ti & L√©gumes",
                ingredients: ["poulet", "brocoli", "carotte", "pomme de terre", "huile"],
                calories: 450,
                proteines: 35,
                glucides: 30,
                lipides: 18,
                difficulte: "Facile",
                temps: "45 min"
            },
            {
                nom: "P√¢tes Carbonara Light",
                ingredients: ["pates", "oeuf", "lardons", "parmesan"],
                calories: 520,
                proteines: 22,
                glucides: 65,
                lipides: 15,
                difficulte: "Facile",
                temps: "20 min"
            },
            {
                nom: "Salade C√©sar au Poulet",
                ingredients: ["poulet", "salade", "parmesan", "pain"],
                calories: 380,
                proteines: 30,
                glucides: 25,
                lipides: 16,
                difficulte: "Tr√®s Facile",
                temps: "15 min"
            },
            {
                nom: "Saumon Grill√© & Riz",
                ingredients: ["saumon", "riz", "citron", "brocoli"],
                calories: 480,
                proteines: 35,
                glucides: 45,
                lipides: 14,
                difficulte: "Facile",
                temps: "30 min"
            },
            {
                nom: "Omelette aux L√©gumes",
                ingredients: ["oeuf", "tomate", "poivron", "fromage"],
                calories: 280,
                proteines: 18,
                glucides: 10,
                lipides: 18,
                difficulte: "Tr√®s Facile",
                temps: "10 min"
            },
            {
                nom: "Soupe de L√©gumes Maison",
                ingredients: ["carotte", "pomme de terre", "poireau", "courgette"],
                calories: 150,
                proteines: 4,
                glucides: 28,
                lipides: 2,
                difficulte: "Facile",
                temps: "40 min"
            },
            {
                nom: "Burger Maison Healthy",
                ingredients: ["pain", "steak", "tomate", "salade", "fromage"],
                calories: 550,
                proteines: 32,
                glucides: 45,
                lipides: 22,
                difficulte: "Facile",
                temps: "25 min"
            },
            {
                nom: "Wrap Thon & L√©gumes",
                ingredients: ["pain", "thon", "tomate", "concombre"],
                calories: 380,
                proteines: 25,
                glucides: 38,
                lipides: 12,
                difficulte: "Tr√®s Facile",
                temps: "10 min"
            },
            {
                nom: "Riz Saut√© aux L√©gumes",
                ingredients: ["riz", "carotte", "poivron", "oignon"],
                calories: 320,
                proteines: 8,
                glucides: 58,
                lipides: 6,
                difficulte: "Facile",
                temps: "20 min"
            },
            {
                nom: "Pizza Margherita Maison",
                ingredients: ["pain", "tomate", "mozzarella", "fromage"],
                calories: 620,
                proteines: 24,
                glucides: 75,
                lipides: 22,
                difficulte: "Moyen",
                temps: "35 min"
            },
            {
                nom: "Steak Frites Maison",
                ingredients: ["steak", "pomme de terre", "salade", "beurre"],
                calories: 680,
                proteines: 38,
                glucides: 55,
                lipides: 32,
                difficulte: "Facile",
                temps: "30 min"
            },
            {
                nom: "Quiche Lorraine",
                ingredients: ["oeuf", "lardons", "creme", "fromage"],
                calories: 580,
                proteines: 20,
                glucides: 35,
                lipides: 38,
                difficulte: "Moyen",
                temps: "50 min"
            },
            {
                nom: "Salade de P√¢tes Compl√®te",
                ingredients: ["pates", "tomate", "mozzarella", "huile"],
                calories: 420,
                proteines: 15,
                glucides: 52,
                lipides: 16,
                difficulte: "Tr√®s Facile",
                temps: "15 min"
            },
            {
                nom: "Poulet Curry & Riz",
                ingredients: ["poulet", "riz", "lait", "curry", "oignon"],
                calories: 520,
                proteines: 32,
                glucides: 55,
                lipides: 16,
                difficulte: "Facile",
                temps: "35 min"
            },
            {
                nom: "Gratin Dauphinois",
                ingredients: ["pomme de terre", "creme", "ail", "fromage", "lait"],
                calories: 480,
                proteines: 12,
                glucides: 42,
                lipides: 28,
                difficulte: "Moyen",
                temps: "60 min"
            },
            {
                nom: "Taboul√© Libanais",
                ingredients: ["semoule", "tomate", "concombre", "menthe", "citron"],
                calories: 220,
                proteines: 6,
                glucides: 38,
                lipides: 5,
                difficulte: "Tr√®s Facile",
                temps: "15 min"
            },
            {
                nom: "Cr√™pes Sucr√©es",
                ingredients: ["farine", "oeuf", "lait", "sucre", "beurre"],
                calories: 380,
                proteines: 10,
                glucides: 52,
                lipides: 14,
                difficulte: "Facile",
                temps: "25 min"
            },
            {
                nom: "Smoothie Bowl Fruits Rouges",
                ingredients: ["banane", "fraise", "yaourt", "miel", "granola"],
                calories: 320,
                proteines: 12,
                glucides: 52,
                lipides: 8,
                difficulte: "Tr√®s Facile",
                temps: "5 min"
            }
        ];


        // Base de donn√©es d'aliments (calories pour 100g)
        const baseAliments = [
            { nom: "Poulet", categorie: "Viande", calories: 165, proteines: 31, glucides: 0, lipides: 3.6 },
            { nom: "B≈ìuf", categorie: "Viande", calories: 250, proteines: 26, glucides: 0, lipides: 17 },
            { nom: "Porc", categorie: "Viande", calories: 242, proteines: 27, glucides: 0, lipides: 14 },
            { nom: "Dinde", categorie: "Viande", calories: 135, proteines: 29, glucides: 0, lipides: 1.5 },
            { nom: "Jambon blanc", categorie: "Charcuterie", calories: 145, proteines: 21, glucides: 1, lipides: 6 },
            { nom: "Saumon", categorie: "Poisson", calories: 208, proteines: 20, glucides: 0, lipides: 13 },
            { nom: "Thon", categorie: "Poisson", calories: 130, proteines: 29, glucides: 0, lipides: 1 },
            { nom: "Cabillaud", categorie: "Poisson", calories: 82, proteines: 18, glucides: 0, lipides: 0.7 },
            { nom: "≈íuf", categorie: "≈íuf", calories: 155, proteines: 13, glucides: 1.1, lipides: 11 },
            { nom: "Lait entier", categorie: "Laitier", calories: 61, proteines: 3.2, glucides: 4.8, lipides: 3.3 },
            { nom: "Yaourt nature", categorie: "Laitier", calories: 59, proteines: 3.5, glucides: 4, lipides: 3.3 },
            { nom: "Fromage blanc 0%", categorie: "Laitier", calories: 44, proteines: 7.5, glucides: 4, lipides: 0.2 },
            { nom: "Riz blanc cuit", categorie: "F√©culent", calories: 130, proteines: 2.7, glucides: 28, lipides: 0.3 },
            { nom: "Riz complet cuit", categorie: "F√©culent", calories: 112, proteines: 2.6, glucides: 24, lipides: 0.9 },
            { nom: "P√¢tes cuites", categorie: "F√©culent", calories: 131, proteines: 5, glucides: 25, lipides: 1.1 },
            { nom: "Quinoa cuit", categorie: "F√©culent", calories: 120, proteines: 4.4, glucides: 21, lipides: 1.9 },
            { nom: "Pain blanc", categorie: "Pain", calories: 265, proteines: 9, glucides: 49, lipides: 3.2 },
            { nom: "Pomme de terre cuite", categorie: "F√©culent", calories: 77, proteines: 2, glucides: 17, lipides: 0.1 },
            { nom: "Lentilles cuites", categorie: "L√©gumineuse", calories: 116, proteines: 9, glucides: 20, lipides: 0.4 },
            { nom: "Pois chiches cuits", categorie: "L√©gumineuse", calories: 164, proteines: 8.9, glucides: 27, lipides: 2.6 },
            { nom: "Tomate", categorie: "L√©gume", calories: 18, proteines: 0.9, glucides: 3.9, lipides: 0.2 },
            { nom: "Carotte", categorie: "L√©gume", calories: 41, proteines: 0.9, glucides: 10, lipides: 0.2 },
            { nom: "Brocoli", categorie: "L√©gume", calories: 34, proteines: 2.8, glucides: 7, lipides: 0.4 },
            { nom: "Courgette", categorie: "L√©gume", calories: 17, proteines: 1.2, glucides: 3.1, lipides: 0.3 },
            { nom: "Salade verte", categorie: "L√©gume", calories: 15, proteines: 1.4, glucides: 2.9, lipides: 0.2 },
            { nom: "√âpinards", categorie: "L√©gume", calories: 23, proteines: 2.9, glucides: 3.6, lipides: 0.4 },
            { nom: "Pomme", categorie: "Fruit", calories: 52, proteines: 0.3, glucides: 14, lipides: 0.2 },
            { nom: "Banane", categorie: "Fruit", calories: 89, proteines: 1.1, glucides: 23, lipides: 0.3 },
            { nom: "Orange", categorie: "Fruit", calories: 47, proteines: 0.9, glucides: 12, lipides: 0.1 },
            { nom: "Fraise", categorie: "Fruit", calories: 32, proteines: 0.7, glucides: 7.7, lipides: 0.3 },
            { nom: "Kiwi", categorie: "Fruit", calories: 61, proteines: 1.1, glucides: 15, lipides: 0.5 },
            { nom: "Amande", categorie: "Noix", calories: 579, proteines: 21, glucides: 22, lipides: 50 },
            { nom: "Noix", categorie: "Noix", calories: 654, proteines: 15, glucides: 14, lipides: 65 }
        ];

        // ==============================================
        // FONCTION DE BASE UNIFI√âE
        // ==============================================
        
        function obtenirBaseTotale() {
            let baseTotale = [...baseAliments];
            
            produitsSauvegardes.forEach(p => {
                if (!baseTotale.find(a => a.nom === p.nom)) {
                    baseTotale.push({
                        nom: p.nom,
                        categorie: "Produit scann√©",
                        calories: p.calories,
                        proteines: p.proteines,
                        glucides: p.glucides,
                        lipides: p.lipides,
                        source: 'scanne'
                    });
                }
            });
            
            produitsFrigo.forEach(p => {
                if (!baseTotale.find(a => a.nom === p.nom)) {
                    baseTotale.push({
                        nom: p.nom,
                        categorie: "Frigo",
                        calories: p.calories,
                        proteines: p.proteines,
                        glucides: p.glucides,
                        lipides: p.lipides,
                        source: 'frigo'
                    });
                }
            });
            
            produitsPerso.forEach(p => {
                if (!baseTotale.find(a => a.nom === p.nom)) {
                    baseTotale.push({
                        nom: p.nom,
                        categorie: "Personnel",
                        calories: p.calories,
                        proteines: p.proteines,
                        glucides: p.glucides,
                        lipides: p.lipides,
                        source: 'perso'
                    });
                }
            });
            
            // Ajouter la base communautaire
            baseCommunautaire.forEach(p => {
                if (!baseTotale.find(a => a.nom === p.nom)) {
                    baseTotale.push({
                        nom: p.nom,
                        categorie: "Base communautaire",
                        calories: p.calories,
                        proteines: p.proteines,
                        glucides: p.glucides,
                        lipides: p.lipides,
                        source: 'communaute'
                    });
                }
            });
            
            return baseTotale;
        }

        // ==============================================
        // FONCTIONS DE NOTIFICATION
        // ==============================================
        
        function afficherSyncIndicator(message = "‚úÖ Synchronis√© !") {
            const indicator = document.getElementById('syncIndicator');
            indicator.textContent = message;
            indicator.style.display = 'block';
            
            setTimeout(() => {
                indicator.style.opacity = '0';
                setTimeout(() => {
                    indicator.style.display = 'none';
                    indicator.style.opacity = '1';
                }, 300);
            }, 2000);
        }

        function afficherNotification(message, couleur = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = couleur;
            notification.innerHTML = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // ==============================================
        // RECHERCHE D'ALIMENT AM√âLIOR√âE
        // ==============================================
        
        function rechercherAliment() {
            const recherche = document.getElementById('searchAliment').value.toLowerCase();
            const suggestions = document.getElementById('suggestionsAliments');

            if (recherche.length < 2) {
                suggestions.style.display = 'none';
                return;
            }

            const baseTotale = obtenirBaseTotale();
            
            const resultats = baseTotale.filter(aliment => 
                aliment.nom.toLowerCase().includes(recherche)
            ).slice(0, 15);

            if (resultats.length === 0) {
                suggestions.style.display = 'none';
                return;
            }

            suggestions.innerHTML = resultats.map(aliment => {
                const badgeSource = aliment.source ? 
                    `<span style="background: ${aliment.source === 'scanne' ? '#4caf50' : aliment.source === 'frigo' ? '#2196f3' : '#ff6b6b'}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75em; margin-left: 5px;">${aliment.source === 'scanne' ? 'üì∑ Scann√©' : aliment.source === 'frigo' ? 'üßä Frigo' : 'üìù Perso'}</span>` 
                    : '';
                
                return `
                <div style="padding: 12px; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; display: flex; justify-content: space-between; align-items: center; gap: 10px; cursor: pointer;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'" onclick="selectionnerAliment('${aliment.nom.replace(/'/g, "\\'")}')">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 3px;">${aliment.nom} ${badgeSource}</div>
                        <div style="font-size: 0.85em; color: #666;">
                            ${Math.round(aliment.calories)} kcal ‚Ä¢ ${aliment.proteines.toFixed(1)}g prot ‚Ä¢ ${aliment.glucides.toFixed(1)}g gluc ‚Ä¢ ${aliment.lipides.toFixed(1)}g lip
                            <span style="color: #667eea; margin-left: 8px;">(100g)</span>
                        </div>
                    </div>
                    <button onclick="ajouterAlimentRapide('${aliment.nom.replace(/'/g, "\\'")}'); event.stopPropagation();" 
                            style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85em; white-space: nowrap;">
                        ‚ûï 100g
                    </button>
                </div>
            `;
            }).join('');

            suggestions.style.display = 'block';
        }

        function selectionnerAliment(nom) {
            document.getElementById('searchAliment').value = nom;
            document.getElementById('suggestionsAliments').style.display = 'none';
            document.getElementById('quantiteAliment').focus();
        }

        // ==============================================
        // AJOUT D'ALIMENT AU CALCULATEUR
        // ==============================================
        
        function ajouterAlimentCalcul() {
            const nomAliment = document.getElementById('searchAliment').value.trim();
            const quantite = parseFloat(document.getElementById('quantiteAliment').value);

            if (!nomAliment) {
                alert('Veuillez saisir un aliment');
                return;
            }

            if (!quantite || quantite <= 0) {
                alert('Veuillez saisir une quantit√© valide en grammes');
                return;
            }

            const baseTotale = obtenirBaseTotale();
            let aliment = baseTotale.find(a => a.nom.toLowerCase() === nomAliment.toLowerCase());
            
            if (!aliment) {
                const correspondances = baseTotale.filter(a => 
                    a.nom.toLowerCase().includes(nomAliment.toLowerCase()) ||
                    nomAliment.toLowerCase().includes(a.nom.toLowerCase())
                );
                
                if (correspondances.length === 1) {
                    aliment = correspondances[0];
                } else if (correspondances.length > 1) {
                    const choix = correspondances.map((a, i) => `${i + 1}. ${a.nom}${a.source ? ' (' + (a.source === 'scanne' ? 'Scann√©' : a.source === 'frigo' ? 'Frigo' : 'Perso') + ')' : ''}`).join('\n');
                    const selection = prompt(`Plusieurs aliments correspondent :\n\n${choix}\n\nEntrez le num√©ro de votre choix (ou annuler):`);
                    
                    if (selection && !isNaN(selection)) {
                        const index = parseInt(selection) - 1;
                        if (index >= 0 && index < correspondances.length) {
                            aliment = correspondances[index];
                        }
                    }
                    
                    if (!aliment) return;
                }
            }

            if (!aliment) {
                alert('‚ùå Aliment non trouv√©.\n\nüí° Utilisez les suggestions ou cliquez sur "‚ûï 100g"');
                document.getElementById('searchAliment').focus();
                rechercherAliment();
                return;
            }

            const facteur = quantite / 100;
            const alimentCalcule = {
                nom: aliment.nom,
                quantite: quantite,
                calories: Math.round(aliment.calories * facteur * 10) / 10,
                proteines: Math.round(aliment.proteines * facteur * 10) / 10,
                glucides: Math.round(aliment.glucides * facteur * 10) / 10,
                lipides: Math.round(aliment.lipides * facteur * 10) / 10
            };

            repasActuel.push(alimentCalcule);
            afficherRepasActuel();

            document.getElementById('searchAliment').value = '';
            document.getElementById('quantiteAliment').value = '';
            document.getElementById('searchAliment').focus();
            
            afficherNotification(`‚úÖ ${aliment.nom} ajout√© (${quantite}g)`);
        }

        function ajouterAlimentRapide(nomAliment) {
            const baseTotale = obtenirBaseTotale();
            const aliment = baseTotale.find(a => a.nom === nomAliment);
            
            if (!aliment) {
                alert('‚ö†Ô∏è Aliment introuvable');
                return;
            }

            const alimentCalcule = {
                nom: aliment.nom,
                quantite: 100,
                calories: aliment.calories,
                proteines: aliment.proteines,
                glucides: aliment.glucides,
                lipides: aliment.lipides
            };

            repasActuel.push(alimentCalcule);
            afficherRepasActuel();
            
            document.getElementById('suggestionsAliments').style.display = 'none';
            document.getElementById('searchAliment').value = '';

            afficherNotification(`‚úÖ ${aliment.nom} ajout√© (100g)`);
        }

        // ==============================================
        // GESTION DES REPAS
        // ==============================================
        
        function afficherRepasActuel() {
            if (repasActuel.length === 0) {
                document.getElementById('repasActuel').style.display = 'none';
                return;
            }

            document.getElementById('repasActuel').style.display = 'block';

            const liste = document.getElementById('listeAlimentsRepas');
            liste.innerHTML = repasActuel.map((aliment, index) => `
                <div style="background: rgba(255, 255, 255, 0.15); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 5px;">
                            ${aliment.nom} (${aliment.quantite}g)
                        </div>
                        <div style="font-size: 0.9em; opacity: 0.9;">
                            ${Math.round(aliment.calories)} kcal ‚Ä¢ 
                            ${aliment.proteines.toFixed(1)}g prot ‚Ä¢ 
                            ${aliment.glucides.toFixed(1)}g gluc ‚Ä¢ 
                            ${aliment.lipides.toFixed(1)}g lip
                        </div>
                    </div>
                    <button onclick="retirerAliment(${index})" style="background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 18px;">
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');

            const totaux = repasActuel.reduce((acc, aliment) => ({
                calories: acc.calories + aliment.calories,
                proteines: acc.proteines + aliment.proteines,
                glucides: acc.glucides + aliment.glucides,
                lipides: acc.lipides + aliment.lipides
            }), { calories: 0, proteines: 0, glucides: 0, lipides: 0 });

            document.getElementById('totalCalories').textContent = Math.round(totaux.calories);
            document.getElementById('totalProteines').textContent = Math.round(totaux.proteines * 10) / 10;
            document.getElementById('totalGlucides').textContent = Math.round(totaux.glucides * 10) / 10;
            document.getElementById('totalLipides').textContent = Math.round(totaux.lipides * 10) / 10;
        }

        function retirerAliment(index) {
            repasActuel.splice(index, 1);
            afficherRepasActuel();
        }

        function reinitialiserRepas() {
            if (repasActuel.length === 0) return;
            
            if (confirm('Voulez-vous vraiment vider ce repas ?')) {
                repasActuel = [];
                afficherRepasActuel();
            }
        }

        function sauvegarderRepas() {
            if (repasActuel.length === 0) {
                alert('Ajoutez des aliments avant de sauvegarder');
                return;
            }

            const nomRepas = prompt('Donnez un nom √† ce repas (ex: Petit-d√©jeuner, D√©jeuner, Collation...)', '');
            
            if (!nomRepas) return;

            const totaux = repasActuel.reduce((acc, aliment) => ({
                calories: acc.calories + aliment.calories,
                proteines: acc.proteines + aliment.proteines,
                glucides: acc.glucides + aliment.glucides,
                lipides: acc.lipides + aliment.lipides
            }), { calories: 0, proteines: 0, glucides: 0, lipides: 0 });

            const repas = {
                id: Date.now(),
                nom: nomRepas,
                date: new Date().toISOString(),
                aliments: [...repasActuel],
                totaux: {
                    calories: Math.round(totaux.calories),
                    proteines: Math.round(totaux.proteines * 10) / 10,
                    glucides: Math.round(totaux.glucides * 10) / 10,
                    lipides: Math.round(totaux.lipides * 10) / 10
                }
            };

            repasSauvegardes.unshift(repas);
            localStorage.setItem('repas', JSON.stringify(repasSauvegardes));

            // Sauvegarder aussi dans l'historique hebdomadaire
            const aujourdhui = new Date().toDateString();
            if (!historiqueRepasHebdo[aujourdhui]) {
                historiqueRepasHebdo[aujourdhui] = {
                    calories: 0,
                    proteines: 0,
                    glucides: 0,
                    lipides: 0,
                    repas: []
                };
            }
            historiqueRepasHebdo[aujourdhui].calories += repas.totaux.calories;
            historiqueRepasHebdo[aujourdhui].proteines += repas.totaux.proteines;
            historiqueRepasHebdo[aujourdhui].glucides += repas.totaux.glucides;
            historiqueRepasHebdo[aujourdhui].lipides += repas.totaux.lipides;
            historiqueRepasHebdo[aujourdhui].repas.push(repas);
            localStorage.setItem('historiqueRepasHebdo', JSON.stringify(historiqueRepasHebdo));

            afficherHistoriqueRepas();
            repasActuel = [];
            afficherRepasActuel();

            afficherNotification('‚úÖ Recette sauvegard√©e avec succ√®s !');
            afficherSyncIndicator('‚úÖ Recette disponible dans le Planning !');
            
            // Proposer d'aller au planning
            setTimeout(() => {
                if (confirm(`‚úÖ Recette "${nomRepas}" cr√©√©e !\n\nüóìÔ∏è Voulez-vous l'ajouter maintenant √† votre planning hebdomadaire ?`)) {
                    showTab('planning');
                    setTimeout(() => {
                        afficherRecettesPlanning();
                    }, 300);
                }
            }, 500);
        }

        function afficherHistoriqueRepas() {
            const historique = document.getElementById('historiqueRepas');

            if (repasSauvegardes.length === 0) {
                historique.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Aucun repas sauvegard√©</p>';
                calculerCaloriesJour();
                return;
            }

            historique.innerHTML = repasSauvegardes.map((repas, index) => {
                const date = new Date(repas.date);
                const dateFormatee = date.toLocaleDateString('fr-FR', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                const heureFormatee = date.toLocaleTimeString('fr-FR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <div class="weight-item" style="flex-direction: column; align-items: stretch; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #667eea; font-size: 1.2em; margin-bottom: 5px;">
                                    ${repas.nom}
                                </div>
                                <div style="color: #999; font-size: 0.9em;">
                                    ${dateFormatee} √† ${heureFormatee}
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="ajouterRepasAuPlanning(${index})" style="background: #4caf50; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
                                    ‚ûï Au Planning
                                </button>
                                <button class="delete" onclick="supprimerRepas(${index})">Supprimer</button>
                            </div>
                        </div>

                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center;">
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold;">${repas.totaux.calories}</div>
                                    <div style="font-size: 0.85em; opacity: 0.9;">kcal</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold;">${repas.totaux.proteines}g</div>
                                    <div style="font-size: 0.85em; opacity: 0.9;">prot√©ines</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold;">${repas.totaux.glucides}g</div>
                                    <div style="font-size: 0.85em; opacity: 0.9;">glucides</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold;">${repas.totaux.lipides}g</div>
                                    <div style="font-size: 0.85em; opacity: 0.9;">lipides</div>
                                </div>
                            </div>
                        </div>

                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 8px;">D√©tail des aliments :</div>
                            ${repas.aliments.map(aliment => `
                                <div style="padding: 6px 0; border-bottom: 1px solid #e0e0e0; font-size: 0.95em; color: #555;">
                                    ‚Ä¢ ${aliment.nom} (${aliment.quantite}g) - ${Math.round(aliment.calories)} kcal
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            calculerCaloriesJour();
        }

        function ajouterRepasAuPlanning(index) {
            const repas = repasSauvegardes[index];
            
            const jours = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            const moments = ['Petit-d√©jeuner', 'D√©jeuner', 'D√Æner'];
            
            let choixJour = prompt(`Quel jour de la semaine ?\n${jours.map((j, i) => `${i}: ${j}`).join('\n')}`);
            if (choixJour === null) return;
            
            let jourIndex = parseInt(choixJour);
            if (isNaN(jourIndex) || jourIndex < 0 || jourIndex >= jours.length) {
                alert('‚ùå Choix invalide');
                return;
            }
            
            let choixMoment = prompt(`Quel moment ?\n${moments.map((m, i) => `${i}: ${m}`).join('\n')}`);
            if (choixMoment === null) return;
            
            let momentIndex = parseInt(choixMoment);
            if (isNaN(momentIndex) || momentIndex < 0 || momentIndex >= moments.length) {
                alert('‚ùå Choix invalide');
                return;
            }
            
            const jour = jours[jourIndex];
            const moment = moments[momentIndex];
            const key = `${jour}-${moment}`;
            
            planningHebdo[key] = {
                nom: repas.nom,
                calories: repas.totaux.calories,
                proteines: repas.totaux.proteines,
                glucides: repas.totaux.glucides,
                lipides: repas.totaux.lipides,
                type: 'repas-complet',
                repasId: repas.id
            };
            
            localStorage.setItem('planningHebdo', JSON.stringify(planningHebdo));
            afficherNotification(`‚úÖ "${repas.nom}" ajout√© au planning !`);
            afficherSyncIndicator('‚úÖ Planning mis √† jour !');
            
            // Aller au planning si on veut
            if (confirm('Voulez-vous voir le planning ?')) {
                showTab('planning');
            }
        }

        function supprimerRepas(index) {
            if (confirm('Voulez-vous vraiment supprimer ce repas ?')) {
                repasSauvegardes.splice(index, 1);
                localStorage.setItem('repas', JSON.stringify(repasSauvegardes));
                afficherHistoriqueRepas();
            }
        }

        function calculerCaloriesJour() {
            const aujourdhui = new Date().toDateString();
            
            const repasAujourdhui = repasSauvegardes.filter(repas => {
                const dateRepas = new Date(repas.date).toDateString();
                return dateRepas === aujourdhui;
            });

            const caloriesJour = repasAujourdhui.reduce((total, repas) => total + repas.totaux.calories, 0);
            
            document.getElementById('caloriesJour').textContent = Math.round(caloriesJour);

            if (userData.calories) {
                const objectif = userData.calories;
                const pourcentage = Math.min(100, (caloriesJour / objectif) * 100);
                
                document.getElementById('objectifCaloriesMsg').style.display = 'block';
                document.getElementById('objectifCaloriesValue').textContent = objectif;
                document.getElementById('progressCaloriesJour').style.display = 'block';
                
                const progressFill = document.getElementById('progressCaloriesFill');
                progressFill.style.width = pourcentage + '%';
                
                let couleur;
                if (pourcentage < 80) {
                    couleur = 'linear-gradient(90deg, #4caf50 0%, #45a049 100%)';
                } else if (pourcentage < 100) {
                    couleur = 'linear-gradient(90deg, #ffc107 0%, #ff9800 100%)';
                } else {
                    couleur = 'linear-gradient(90deg, #ff4757 0%, #e84118 100%)';
                }
                
                progressFill.style.background = couleur;
                progressFill.textContent = Math.round(pourcentage) + '%';
            }
        }

        // ==============================================
        // PLANNING HEBDOMADAIRE
        // ==============================================
        
        function afficherPlanning() {
            const jours = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            const moments = ['Petit-d√©jeuner', 'D√©jeuner', 'D√Æner'];
            const container = document.getElementById('planning-container');
            
            container.innerHTML = jours.map(jour => `
                <div class="planning-day">
                    <div class="day-header">${jour}</div>
                    ${moments.map(moment => {
                        const key = `${jour}-${moment}`;
                        const repas = planningHebdo[key];
                        
                        return `
                            <div class="meal-slot" 
                                 data-jour="${jour}" 
                                 data-moment="${moment}"
                                 ondragover="dragOver(event)"
                                 ondragleave="dragLeave(event)"
                                 ondrop="drop(event)">
                                <div class="meal-slot-title">${moment}</div>
                                ${repas ? `
                                    <div class="planned-meal" style="background: linear-gradient(45deg, #f093fb, #f5576c);">
                                        <div style="font-weight: bold; margin-bottom: 5px;">üçΩÔ∏è ${repas.nom}</div>
                                        <div style="font-size: 0.9em; opacity: 0.95;">${Math.round(repas.calories)} kcal</div>
                                        <button class="delete-btn" onclick="supprimerDuPlanning('${key}')">√ó</button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                    <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 8px; text-align: center; font-weight: bold; color: #667eea;">
                        Total: ${calculerCaloriesJourPlanning(jour)} cal
                    </div>
                </div>
            `).join('');
        }

        function calculerCaloriesJourPlanning(jour) {
            const moments = ['Petit-d√©jeuner', 'D√©jeuner', 'D√Æner'];
            return moments.reduce((total, moment) => {
                const key = `${jour}-${moment}`;
                const repas = planningHebdo[key];
                return total + (repas ? repas.calories : 0);
            }, 0);
        }

        function afficherRecettesPlanning() {
            const container = document.getElementById('recettes-planning-container');
            const recipesContainer = document.getElementById('recipes-planning');
            
            if (container.style.display === 'none') {
                let html = '';
                
                // Afficher UNIQUEMENT les REPAS SAUVEGARD√âS (recettes compl√®tes)
                if (repasSauvegardes.length > 0) {
                    html += repasSauvegardes.map(repas => {
                        return `
                            <div class="recipe-card" draggable="true" ondragstart="dragStartRepas(event)" data-repas='${JSON.stringify(repas).replace(/'/g, "&#39;")}'>
                                <div class="recipe-image" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">üçΩÔ∏è</div>
                                <div class="recipe-content">
                                    <div class="recipe-title">${repas.nom}</div>
                                    <span class="badge" style="background: #f093fb; color: white;">üìù Recette</span>
                                    <div class="recipe-info">
                                        <span class="recipe-calories">üî• ${Math.round(repas.totaux.calories)} cal</span>
                                    </div>
                                    <div style="font-size: 0.8em; color: #666; margin-top: 8px;">
                                        P:${repas.totaux.proteines.toFixed(1)}g | G:${repas.totaux.glucides.toFixed(1)}g | L:${repas.totaux.lipides.toFixed(1)}g
                                    </div>
                                    <div style="font-size: 0.75em; color: #999; margin-top: 8px;">
                                        ${repas.aliments.length} ingr√©dient(s)
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    html = `
                        <div style="text-align: center; padding: 60px 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px;">
                            <div style="font-size: 4em; margin-bottom: 20px;">üçΩÔ∏è</div>
                            <h3 style="color: #667eea; margin-bottom: 15px; font-size: 1.5em;">Aucune recette cr√©√©e</h3>
                            <p style="color: #666; margin-bottom: 20px; line-height: 1.8; max-width: 500px; margin-left: auto; margin-right: auto;">
                                Pour cr√©er des recettes, allez dans le <strong>Calculateur de Calories</strong>, 
                                ajoutez plusieurs aliments, puis cliquez sur <strong>"Sauvegarder ce repas"</strong>.
                            </p>
                            <button class="btn" onclick="showTab('calculateur')" style="width: auto; display: inline-block;">
                                üßÆ Aller au Calculateur
                            </button>
                        </div>
                    `;
                }
                
                recipesContainer.innerHTML = html;
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        let repasDrague = null;

        function dragStartRepas(event) {
            const repasJson = event.currentTarget.dataset.repas;
            repasDrague = JSON.parse(repasJson);
        }

        function dragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function dragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function drop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            // Uniquement les recettes compl√®tes
            if (!repasDrague) {
                return;
            }
            
            const jour = event.currentTarget.dataset.jour;
            const moment = event.currentTarget.dataset.moment;
            const key = `${jour}-${moment}`;
            
            planningHebdo[key] = {
                nom: repasDrague.nom,
                calories: repasDrague.totaux.calories,
                proteines: repasDrague.totaux.proteines,
                glucides: repasDrague.totaux.glucides,
                lipides: repasDrague.totaux.lipides,
                type: 'repas-complet',
                repasId: repasDrague.id,
                aliments: repasDrague.aliments
            };
            
            localStorage.setItem('planningHebdo', JSON.stringify(planningHebdo));
            afficherPlanning();
            afficherSyncIndicator('‚úÖ Recette ajout√©e au planning !');
        }

        function supprimerDuPlanning(key) {
            delete planningHebdo[key];
            localStorage.setItem('planningHebdo', JSON.stringify(planningHebdo));
            afficherPlanning();
        }

        function viderPlanning() {
            if (confirm('Voulez-vous vraiment vider tout le planning ?')) {
                planningHebdo = {};
                localStorage.setItem('planningHebdo', JSON.stringify(planningHebdo));
                afficherPlanning();
            }
        }

        // ==============================================
        // HISTORIQUE HEBDOMADAIRE
        // ==============================================
        
        function afficherHistoriqueHebdo() {
            const container = document.getElementById('history-container');
            const dates = Object.keys(historiqueRepasHebdo).sort().reverse().slice(0, 7);
            
            if (dates.length === 0) {
                container.innerHTML = '<div class="card"><p style="color: #999; text-align: center; padding: 20px;">Aucun historique disponible</p></div>';
                return;
            }
            
            const objectif = userData.calories || 2000;
            
            container.innerHTML = dates.map(date => {
                const jour = historiqueRepasHebdo[date];
                const dateObj = new Date(date);
                const dateFormatee = dateObj.toLocaleDateString('fr-FR', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                return `
                    <div class="weight-item" style="flex-direction: column; align-items: stretch; margin-bottom: 20px;">
                        <div style="font-weight: bold; font-size: 1.2em; color: #667eea; margin-bottom: 10px;">${dateFormatee}</div>
                        <div style="font-size: 2em; font-weight: bold; color: #667eea; margin-bottom: 5px;">${Math.round(jour.calories)} cal</div>
                        <div style="color: #666; margin-bottom: 15px;">sur ${objectif} objectif (${Math.round((jour.calories / objectif) * 100)}%)</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                            <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                <div style="font-size: 1.3em; font-weight: bold; color: #667eea;">${jour.proteines.toFixed(1)}g</div>
                                <div style="font-size: 0.85em; color: #666;">Prot√©ines</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                <div style="font-size: 1.3em; font-weight: bold; color: #667eea;">${jour.glucides.toFixed(1)}g</div>
                                <div style="font-size: 0.85em; color: #666;">Glucides</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                <div style="font-size: 1.3em; font-weight: bold; color: #667eea;">${jour.lipides.toFixed(1)}g</div>
                                <div style="font-size: 0.85em; color: #666;">Lipides</div>
                            </div>
                        </div>
                        <details>
                            <summary style="cursor: pointer; color: #667eea; font-weight: bold; margin-bottom: 10px;">Voir les repas</summary>
                            <div>
                                ${jour.repas.map(r => `
                                    <div style="padding: 10px; background: #f8f9fa; margin: 5px 0; border-radius: 5px;">
                                        <strong>${r.nom}</strong> - ${r.totaux.calories} cal
                                    </div>
                                `).join('')}
                            </div>
                        </details>
                    </div>
                `;
            }).join('');
        }

        // ==============================================
        // FONCTIONS DE PROFIL (simplifi√©es)
        // ==============================================
        
        function calculerProfil() {
            const nom = document.getElementById('nom').value;
            const sexe = document.getElementById('sexe').value;
            const age = parseFloat(document.getElementById('age').value);
            const taille = parseFloat(document.getElementById('taille').value);
            const poids = parseFloat(document.getElementById('poids').value);
            const objectif = parseFloat(document.getElementById('objectif').value);
            const activite = parseFloat(document.getElementById('activite').value);

            if (!nom || !age || !taille || !poids || !objectif) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            const imc = (poids / ((taille / 100) ** 2)).toFixed(1);
            
            let poidsIdeal;
            if (sexe === 'homme') {
                poidsIdeal = (taille - 100 - ((taille - 150) / 4)).toFixed(1);
            } else {
                poidsIdeal = (taille - 100 - ((taille - 150) / 2.5)).toFixed(1);
            }

            const aPerdre = Math.max(0, poids - objectif).toFixed(1);

            let bmr;
            if (sexe === 'homme') {
                bmr = 88.362 + (13.397 * poids) + (4.799 * taille) - (5.677 * age);
            } else {
                bmr = 447.593 + (9.247 * poids) + (3.098 * taille) - (4.330 * age);
            }
            const calories = Math.round((bmr * activite) - 500);

            let categorieIMC;
            if (imc < 18.5) {
                categorieIMC = "Insuffisance pond√©rale";
            } else if (imc < 25) {
                categorieIMC = "Poids normal - F√©licitations ! üéâ";
            } else if (imc < 30) {
                categorieIMC = "Surpoids - Vous √™tes sur la bonne voie ! üí™";
            } else {
                categorieIMC = "Ob√©sit√© - Courage, chaque pas compte ! üåü";
            }

            const semaines = Math.ceil(aPerdre / 0.5);
            const mois = (semaines / 4.33).toFixed(1);

            document.getElementById('imcValue').textContent = imc;
            document.getElementById('poidsIdealValue').textContent = poidsIdeal;
            document.getElementById('aPerdrValue').textContent = aPerdre;
            document.getElementById('caloriesValue').textContent = calories;
            document.getElementById('imcCategorie').innerHTML = `<strong>Cat√©gorie :</strong> ${categorieIMC}`;
            document.getElementById('dureeProgramme').innerHTML = `<strong>Dur√©e estim√©e :</strong> ${semaines} semaines (environ ${mois} mois) pour atteindre votre objectif de mani√®re saine.`;

            document.getElementById('resultatProfil').classList.add('show');

            userData = { nom, sexe, age, taille, poids, objectif, activite, imc, poidsIdeal, calories };
            localStorage.setItem('userData', JSON.stringify(userData));

            // Afficher et dessiner les graphiques de progression
            afficherGraphiquesProgression();
            
            // Scroller vers les graphiques apr√®s un court d√©lai
            setTimeout(() => {
                scrollToGraphiques();
            }, 500);
        }

        function afficherGraphiquesProgression() {
            if (!userData.poids || !userData.objectif) {
                return;
            }

            document.getElementById('graphiqueProgression').style.display = 'block';

            // Calculer les valeurs
            const poidsActuel = pesees.length > 0 ? pesees[pesees.length - 1].poids : userData.poids;
            const poidsDepart = userData.poids;
            const poidsObjectif = userData.objectif;
            const poidsPerdu = Math.max(0, poidsDepart - poidsActuel);
            const poidsRestant = Math.max(0, poidsActuel - poidsObjectif);
            
            const imcActuel = (poidsActuel / ((userData.taille / 100) ** 2)).toFixed(1);
            const imcObjectif = (poidsObjectif / ((userData.taille / 100) ** 2)).toFixed(1);

            // 1 kg de graisse = environ 7700 calories
            const caloriesTotales = Math.round((poidsDepart - poidsObjectif) * 7700);
            const caloriesPerduees = Math.round(poidsPerdu * 7700);
            const deficitJour = 500; // D√©ficit recommand√©

            // Mise √† jour des stats
            document.getElementById('progressPoidsActuel').textContent = poidsActuel.toFixed(1) + ' kg';
            document.getElementById('progressPoidsPerdu').textContent = poidsPerdu.toFixed(1) + ' kg';
            document.getElementById('progressPoidsRestant').textContent = poidsRestant.toFixed(1) + ' kg';
            document.getElementById('progressIMCActuel').textContent = imcActuel;

            document.getElementById('caloriesJournalieres').textContent = userData.calories;
            document.getElementById('deficitJour').textContent = deficitJour + ' kcal';
            document.getElementById('caloriesTotales').textContent = caloriesTotales.toLocaleString() + ' kcal';

            // Timeline
            const aujourdhui = new Date();
            const dateDebut = aujourdhui.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
            const semaines = Math.ceil((poidsDepart - poidsObjectif) / 0.5);
            const dateFin = new Date(aujourdhui.getTime() + semaines * 7 * 24 * 60 * 60 * 1000);
            const dateFinFormatee = dateFin.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });

            document.getElementById('timelineDebut').textContent = dateDebut;
            document.getElementById('timelineDuree').textContent = semaines + ' semaines';
            document.getElementById('timelineFin').textContent = dateFinFormatee;

            // Dessiner les graphiques
            dessinerGraphiqueCalories();
            dessinerGraphiqueProgressionPoids();
        }

        function scrollToGraphiques() {
            const element = document.getElementById('graphiqueProgression');
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function dessinerGraphiqueCalories() {
            const canvas = document.getElementById('graphiqueCalories');
            const ctx = canvas.getContext('2d');

            canvas.width = canvas.offsetWidth;
            canvas.height = 150;

            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height);

            const poidsDepart = userData.poids;
            const poidsObjectif = userData.objectif;
            const poidsActuel = pesees.length > 0 ? pesees[pesees.length - 1].poids : userData.poids;

            const caloriesTotales = Math.round((poidsDepart - poidsObjectif) * 7700);
            const caloriesPerduees = Math.round((poidsDepart - poidsActuel) * 7700);
            const caloriesRestantes = Math.max(0, caloriesTotales - caloriesPerduees);

            const pourcentage = caloriesTotales > 0 ? (caloriesPerduees / caloriesTotales) * 100 : 0;

            // Barre de progression
            const barHeight = 60;
            const barY = (height - barHeight) / 2;

            // Fond
            ctx.fillStyle = '#e0e0e0';
            ctx.fillRect(0, barY, width, barHeight);

            // Progression
            const progressWidth = (width * pourcentage) / 100;
            const gradient = ctx.createLinearGradient(0, 0, width, 0);
            gradient.addColorStop(0, '#4caf50');
            gradient.addColorStop(1, '#81c784');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, barY, progressWidth, barHeight);

            // Texte
            ctx.fillStyle = '#333';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`${pourcentage.toFixed(1)}% accompli`, width / 2, barY + barHeight / 2 + 7);

            // Labels
            ctx.font = '12px Arial';
            ctx.textAlign = 'left';
            ctx.fillStyle = '#666';
            ctx.fillText(`0 kcal`, 5, barY - 10);
            ctx.textAlign = 'right';
            ctx.fillText(`${caloriesTotales.toLocaleString()} kcal`, width - 5, barY - 10);
        }

        function dessinerGraphiqueProgressionPoids() {
            const canvas = document.getElementById('graphiqueProgressionPoids');
            const ctx = canvas.getContext('2d');

            canvas.width = canvas.offsetWidth;
            canvas.height = 200;

            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height);

            const poidsDepart = userData.poids;
            const poidsObjectif = userData.objectif;
            const poidsActuel = pesees.length > 0 ? pesees[pesees.length - 1].poids : userData.poids;

            const padding = 40;
            const graphHeight = height - 2 * padding;

            // Axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            // Ligne objectif
            const yObjectif = height - padding - 20;
            ctx.strokeStyle = '#4caf50';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(padding, yObjectif);
            ctx.lineTo(width - padding, yObjectif);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.fillStyle = '#4caf50';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`Objectif: ${poidsObjectif} kg`, padding + 10, yObjectif - 5);

            // Point d√©part
            const yDepart = padding + 20;
            ctx.fillStyle = '#667eea';
            ctx.beginPath();
            ctx.arc(padding + 50, yDepart, 8, 0, 2 * Math.PI);
            ctx.fill();
            ctx.fillStyle = '#333';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`D√©part: ${poidsDepart} kg`, padding + 50, yDepart - 15);

            // Point actuel
            const progression = poidsDepart > poidsObjectif ? (poidsDepart - poidsActuel) / (poidsDepart - poidsObjectif) : 0;
            const xActuel = padding + 50 + (width - padding - 100) * Math.min(progression, 1);
            const yActuel = yDepart + (yObjectif - yDepart) * Math.min(progression, 1);

            // Ligne de progression
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(padding + 50, yDepart);
            ctx.lineTo(xActuel, yActuel);
            ctx.stroke();

            // Point actuel
            ctx.fillStyle = '#f5576c';
            ctx.beginPath();
            ctx.arc(xActuel, yActuel, 10, 0, 2 * Math.PI);
            ctx.fill();
            ctx.fillStyle = '#333';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`Actuel: ${poidsActuel.toFixed(1)} kg`, xActuel, yActuel + 25);

            // Fl√®che vers objectif
            if (progression < 1) {
                ctx.strokeStyle = '#999';
                ctx.lineWidth = 2;
                ctx.setLineDash([3, 3]);
                ctx.beginPath();
                ctx.moveTo(xActuel, yActuel);
                ctx.lineTo(width - padding - 50, yObjectif);
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }

        function chargerProfil() {
            if (Object.keys(userData).length > 0) {
                document.getElementById('nom').value = userData.nom || '';
                document.getElementById('sexe').value = userData.sexe || 'femme';
                document.getElementById('age').value = userData.age || '';
                document.getElementById('taille').value = userData.taille || '';
                document.getElementById('poids').value = userData.poids || '';
                document.getElementById('objectif').value = userData.objectif || '';
                document.getElementById('activite').value = userData.activite || '1.2';

                // Si le profil existe, afficher les r√©sultats et graphiques
                if (userData.imc && userData.calories) {
                    document.getElementById('imcValue').textContent = userData.imc;
                    document.getElementById('poidsIdealValue').textContent = userData.poidsIdeal;
                    document.getElementById('aPerdrValue').textContent = Math.max(0, userData.poids - userData.objectif).toFixed(1);
                    document.getElementById('caloriesValue').textContent = userData.calories;

                    let categorieIMC;
                    const imc = parseFloat(userData.imc);
                    if (imc < 18.5) {
                        categorieIMC = "Insuffisance pond√©rale";
                    } else if (imc < 25) {
                        categorieIMC = "Poids normal - F√©licitations ! üéâ";
                    } else if (imc < 30) {
                        categorieIMC = "Surpoids - Vous √™tes sur la bonne voie ! üí™";
                    } else {
                        categorieIMC = "Ob√©sit√© - Courage, chaque pas compte ! üåü";
                    }

                    const aPerdre = Math.max(0, userData.poids - userData.objectif);
                    const semaines = Math.ceil(aPerdre / 0.5);
                    const mois = (semaines / 4.33).toFixed(1);

                    document.getElementById('imcCategorie').innerHTML = `<strong>Cat√©gorie :</strong> ${categorieIMC}`;
                    document.getElementById('dureeProgramme').innerHTML = `<strong>Dur√©e estim√©e :</strong> ${semaines} semaines (environ ${mois} mois) pour atteindre votre objectif de mani√®re saine.`;

                    document.getElementById('resultatProfil').classList.add('show');
                    
                    // Afficher les graphiques
                    setTimeout(() => {
                        afficherGraphiquesProgression();
                    }, 100);
                }
            }
        }

        // ==============================================
        // FONCTIONS DE SUIVI DU POIDS (simplifi√©es)
        // ==============================================
        
        function ajouterPesee() {
            const date = document.getElementById('datePesee').value;
            const poids = parseFloat(document.getElementById('poidsPesee').value);

            if (!date || !poids) {
                alert('Veuillez remplir la date et le poids');
                return;
            }

            const index = pesees.findIndex(p => p.date === date);
            if (index !== -1) {
                if (confirm('Une pes√©e existe d√©j√† pour cette date. Voulez-vous la remplacer ?')) {
                    pesees[index] = { date, poids };
                } else {
                    return;
                }
            } else {
                pesees.push({ date, poids });
            }

            pesees.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem('pesees', JSON.stringify(pesees));
            afficherPesees();
            dessinerGraphique();

            // Mettre √† jour les graphiques de progression si profil existe
            if (userData.poids && userData.objectif) {
                afficherGraphiquesProgression();
            }

            document.getElementById('poidsPesee').value = '';
            document.getElementById('datePesee').valueAsDate = new Date();

            afficherNotification('‚úÖ Pes√©e enregistr√©e !');
        }

        function afficherPesees() {
            const liste = document.getElementById('listePesees');
            liste.innerHTML = '';

            if (pesees.length === 0) {
                liste.innerHTML = '<p style="text-align: center; color: #999;">Aucune pes√©e enregistr√©e</p>';
                return;
            }

            afficherProgression();

            [...pesees].reverse().forEach((pesee, index) => {
                const realIndex = pesees.length - 1 - index;
                const div = document.createElement('div');
                div.className = 'weight-item';
                
                const dateFormatee = new Date(pesee.date + 'T00:00:00').toLocaleDateString('fr-FR', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                div.innerHTML = `
                    <span class="date">${dateFormatee}</span>
                    <span class="weight">${pesee.poids} kg</span>
                    <button class="delete" onclick="supprimerPesee(${realIndex})">Supprimer</button>
                `;
                liste.appendChild(div);
            });
        }

        function afficherProgression() {
            const progressionDiv = document.getElementById('progressionActuelle');
            
            if (pesees.length === 0 || !userData.objectif) {
                progressionDiv.innerHTML = '';
                return;
            }

            const poidsActuel = pesees[pesees.length - 1].poids;
            const poidsDepart = pesees[0].poids;
            const objectif = userData.objectif;

            const totalAPerdre = poidsDepart - objectif;
            const dejaPerdu = poidsDepart - poidsActuel;
            const resteAPerdre = poidsActuel - objectif;

            const pourcentage = Math.min(100, Math.max(0, (dejaPerdu / totalAPerdre) * 100));

            progressionDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3 style="color: white; margin-bottom: 10px;">üìä Votre progression</h3>
                    <div style="display: flex; justify-content: space-between; color: white; margin-bottom: 10px;">
                        <span>D√©part: ${poidsDepart} kg</span>
                        <span>Actuel: ${poidsActuel} kg</span>
                        <span>Objectif: ${objectif} kg</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${pourcentage}%">${pourcentage.toFixed(1)}%</div>
                    </div>
                    <div style="color: white; margin-top: 10px; text-align: center;">
                        <strong>Perdu: ${dejaPerdu.toFixed(1)} kg</strong> sur ${totalAPerdre.toFixed(1)} kg
                        ${resteAPerdre > 0 ? ` - Encore ${resteAPerdre.toFixed(1)} kg √† perdre !` : ' - Objectif atteint ! üéâ'}
                    </div>
                </div>
            `;
        }

        function supprimerPesee(index) {
            if (confirm('Voulez-vous vraiment supprimer cette pes√©e ?')) {
                pesees.splice(index, 1);
                localStorage.setItem('pesees', JSON.stringify(pesees));
                afficherPesees();
                dessinerGraphique();
                
                // Mettre √† jour les graphiques de progression
                if (userData.poids && userData.objectif) {
                    afficherGraphiquesProgression();
                }
            }
        }

        function dessinerGraphique() {
            const canvas = document.getElementById('graphiquePoids');
            const ctx = canvas.getContext('2d');

            canvas.width = canvas.offsetWidth;
            canvas.height = 300;

            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height);

            if (pesees.length === 0) {
                ctx.fillStyle = '#999';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Aucune donn√©e √† afficher', width / 2, height / 2);
                return;
            }

            const padding = 50;
            const graphWidth = width - 2 * padding;
            const graphHeight = height - 2 * padding;

            const poids = pesees.map(p => p.poids);
            const minPoids = Math.min(...poids, userData.objectif || Infinity) - 2;
            const maxPoids = Math.max(...poids) + 2;
            const rangePoids = maxPoids - minPoids;

            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            if (userData.objectif) {
                const yObjectif = height - padding - ((userData.objectif - minPoids) / rangePoids) * graphHeight;
                ctx.strokeStyle = '#ff4757';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(padding, yObjectif);
                ctx.lineTo(width - padding, yObjectif);
                ctx.stroke();
                ctx.setLineDash([]);

                ctx.fillStyle = '#ff4757';
                ctx.font = 'bold 12px Arial';
                ctx.fillText(`Objectif: ${userData.objectif} kg`, width - padding + 5, yObjectif + 5);
            }

            ctx.strokeStyle = '#667eea';
            ctx.fillStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.beginPath();

            pesees.forEach((pesee, index) => {
                const x = padding + (index / (pesees.length - 1 || 1)) * graphWidth;
                const y = height - padding - ((pesee.poids - minPoids) / rangePoids) * graphHeight;

                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }

                ctx.fillRect(x - 4, y - 4, 8, 8);

                ctx.fillStyle = '#333';
                ctx.font = '11px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${pesee.poids}`, x, y - 10);

                if (pesees.length <= 10 || index % Math.ceil(pesees.length / 10) === 0 || index === pesees.length - 1) {
                    const dateFormatee = new Date(pesee.date + 'T00:00:00').toLocaleDateString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit'
                    });
                    ctx.save();
                    ctx.translate(x, height - padding + 15);
                    ctx.rotate(-Math.PI / 4);
                    ctx.fillText(dateFormatee, 0, 0);
                    ctx.restore();
                }

                ctx.fillStyle = '#667eea';
            });

            ctx.stroke();
        }

        // ==============================================
        // FONCTIONS SCANNER
        // ==============================================
        
        function demarrerScanner() {
            document.getElementById('scanPlaceholder').style.display = 'none';
            document.getElementById('interactive').style.display = 'block';
            document.getElementById('startScanBtn').style.display = 'none';
            document.getElementById('stopScanBtn').style.display = 'inline-block';
            document.getElementById('resultatScanner').style.display = 'none';
            document.getElementById('erreurScanner').style.display = 'none';
            document.getElementById('erreurPermission').style.display = 'none';

            scannerActif = true;
            dernierCodeDetecte = null;

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: "environment" // Cam√©ra arri√®re sur mobile
                    }
                },
                decoder: {
                    readers: [
                        "ean_reader",
                        "ean_8_reader",
                        "code_128_reader",
                        "code_39_reader",
                        "upc_reader",
                        "upc_e_reader"
                    ]
                },
                locate: true,
                locator: {
                    patchSize: "medium",
                    halfSample: true
                }
            }, function(err) {
                if (err) {
                    console.error('Erreur Quagga:', err);
                    document.getElementById('erreurPermission').style.display = 'block';
                    document.getElementById('interactive').style.display = 'none';
                    document.getElementById('scanPlaceholder').style.display = 'block';
                    document.getElementById('startScanBtn').style.display = 'inline-block';
                    document.getElementById('stopScanBtn').style.display = 'none';
                    scannerActif = false;
                    return;
                }
                console.log("Scanner initialis√© avec succ√®s");
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                if (!scannerActif) return;

                const code = result.codeResult.code;
                
                if (dernierCodeDetecte === code) {
                    return;
                }

                if (timeoutDetection) {
                    clearTimeout(timeoutDetection);
                }

                timeoutDetection = setTimeout(function() {
                    dernierCodeDetecte = code;
                    console.log("Code-barres d√©tect√©:", code);
                    
                    const beep = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE=');
                    beep.play().catch(e => console.log('Beep non jou√©'));

                    arreterScanner();
                    rechercherProduitOpenFoodFacts(code);
                }, 500);
            });
        }

        function arreterScanner() {
            if (scannerActif) {
                Quagga.stop();
                scannerActif = false;
            }
            
            document.getElementById('interactive').style.display = 'none';
            document.getElementById('scanPlaceholder').style.display = 'block';
            document.getElementById('startScanBtn').style.display = 'inline-block';
            document.getElementById('stopScanBtn').style.display = 'none';
        }

        function rechercherCodeBarre() {
            const codebarre = document.getElementById('manualBarcode').value.trim();
            
            if (!codebarre) {
                alert('‚ö†Ô∏è Veuillez saisir un code-barres');
                return;
            }

            if (!/^\d{8,13}$/.test(codebarre)) {
                alert('‚ö†Ô∏è Le code-barres doit contenir entre 8 et 13 chiffres');
                return;
            }

            rechercherProduitOpenFoodFacts(codebarre);
        }

        async function rechercherProduitOpenFoodFacts(codebarre) {
            document.getElementById('loadingScanner').style.display = 'block';
            document.getElementById('resultatScanner').style.display = 'none';
            document.getElementById('erreurScanner').style.display = 'none';

            console.log('üîç Recherche du code-barres:', codebarre);

            // PRIORIT√â 1 : Chercher dans la base locale
            const produitLocal = baseProduitsCourants.find(p => p.barcode === codebarre);
            
            if (produitLocal) {
                console.log('‚úÖ Produit trouv√© dans la base locale');
                afficherProduit({
                    product_name: produitLocal.nom,
                    brands: produitLocal.marque,
                    quantity: '',
                    code: codebarre,
                    nutriments: {
                        'energy-kcal_100g': produitLocal.calories,
                        proteins_100g: produitLocal.proteines,
                        carbohydrates_100g: produitLocal.glucides,
                        fat_100g: produitLocal.lipides
                    },
                    image_url: produitLocal.image,
                    source: 'local'
                });
                document.getElementById('loadingScanner').style.display = 'none';
                afficherNotification('‚úÖ Produit trouv√© dans la base locale !', 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)');
                return;
            }

            // PRIORIT√â 2 : Chercher dans la base perso
            const produitPerso = produitsPerso.find(p => p.barcode === codebarre);
            
            if (produitPerso) {
                console.log('‚úÖ Produit trouv√© dans la base perso');
                afficherProduit({
                    product_name: produitPerso.nom,
                    brands: produitPerso.marque,
                    quantity: '',
                    code: codebarre,
                    nutriments: {
                        'energy-kcal_100g': produitPerso.calories,
                        proteins_100g: produitPerso.proteines,
                        carbohydrates_100g: produitPerso.glucides,
                        fat_100g: produitPerso.lipides
                    },
                    image_url: '',
                    source: 'perso'
                });
                document.getElementById('loadingScanner').style.display = 'none';
                afficherNotification('‚úÖ Produit trouv√© dans votre base perso !', 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)');
                return;
            }

            // PRIORIT√â 3 : Chercher dans la base communautaire
            const produitCommunautaire = rechercherDansBaseCommunautaire(codebarre);
            
            if (produitCommunautaire) {
                console.log('‚úÖ Produit trouv√© dans la base communautaire');
                afficherProduit({
                    product_name: produitCommunautaire.nom,
                    brands: produitCommunautaire.marque,
                    quantity: '',
                    code: codebarre,
                    nutriments: {
                        'energy-kcal_100g': produitCommunautaire.calories,
                        proteins_100g: produitCommunautaire.proteines,
                        carbohydrates_100g: produitCommunautaire.glucides,
                        fat_100g: produitCommunautaire.lipides
                    },
                    image_url: '',
                    source: 'communaute'
                });
                document.getElementById('loadingScanner').style.display = 'none';
                afficherNotification('üåç Produit trouv√© dans la base communautaire !', 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)');
                return;
            }

            // PRIORIT√â 4 : Chercher sur OpenFoodFacts
            console.log('üåê Recherche sur OpenFoodFacts...');
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${codebarre}.json`);
                const data = await response.json();

                document.getElementById('loadingScanner').style.display = 'none';

                if (data.status === 1 && data.product) {
                    console.log('‚úÖ Produit trouv√© sur OpenFoodFacts');
                    afficherProduit(data.product);
                    afficherNotification('‚úÖ Produit trouv√© sur OpenFoodFacts !', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');
                } else {
                    console.log('‚ùå Produit non trouv√©');
                    afficherErreurProduitNonTrouve(codebarre);
                }
            } catch (error) {
                console.error('‚ùå Erreur r√©seau:', error);
                document.getElementById('loadingScanner').style.display = 'none';
                afficherErreurConnexion();
            }
        }

        function afficherErreurProduitNonTrouve(codebarre) {
            document.getElementById('erreurScanner').style.display = 'block';
            document.getElementById('erreurScanner').innerHTML = `
                <h4 style="margin-bottom: 15px;">‚ùå Produit non trouv√©</h4>
                <p style="margin-bottom: 15px; line-height: 1.6;">
                    Le code-barres <strong>${codebarre}</strong> n'a pas √©t√© trouv√© dans nos bases de donn√©es.
                </p>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h5 style="color: #1565c0; margin-bottom: 10px;">üí° Solutions :</h5>
                    <ol style="line-height: 2; margin-left: 20px; color: #333;">
                        <li><strong>Ajoutez-le √† votre Base Perso</strong>
                            <p style="margin: 5px 0; font-size: 0.9em; color: #666;">
                                Allez dans l'onglet "üìù Ma Base Perso" et cr√©ez une fiche pour ce produit
                            </p>
                        </li>
                        <li><strong>V√©rifiez le code</strong>
                            <p style="margin: 5px 0; font-size: 0.9em; color: #666;">
                                Assurez-vous que tous les chiffres sont corrects
                            </p>
                        </li>
                        <li><strong>Essayez un autre produit</strong>
                            <p style="margin: 5px 0; font-size: 0.9em; color: #666;">
                                Certains produits locaux/artisanaux ne sont pas r√©f√©renc√©s
                            </p>
                        </li>
                    </ol>
                </div>

                <button class="btn" onclick="showTab('baseperso')" style="width: 100%; margin-top: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    üìù Aller dans Ma Base Perso
                </button>
            `;
            document.getElementById('manualBarcode').value = codebarre;
        }

        function afficherErreurConnexion() {
            document.getElementById('erreurScanner').style.display = 'block';
            document.getElementById('erreurScanner').innerHTML = `
                <h4 style="margin-bottom: 10px;">‚ùå Erreur de connexion</h4>
                <p>Impossible de se connecter √† la base de donn√©es OpenFoodFacts. V√©rifiez votre connexion internet et r√©essayez.</p>
            `;
        }

        function afficherProduit(product) {
            document.getElementById('resultatScanner').style.display = 'block';

            const nom = product.product_name || 'Produit inconnu';
            const marque = product.brands || 'Marque inconnue';
            const quantite = product.quantity || '';
            const codebarre = product.code;
            
            // Gestion de l'image avec fallback
            let image = product.image_url || product.image_front_url || '';
            if (!image || image === '') {
                image = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="150" height="150"%3E%3Crect width="150" height="150" fill="%23f0f0f0"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%23999" font-size="40"%3EüçΩÔ∏è%3C/text%3E%3C/svg%3E';
            }

            const nutriments = product.nutriments || {};
            const calories = nutriments['energy-kcal_100g'] || nutriments['energy-kcal'] || 0;
            const proteines = nutriments.proteins_100g || nutriments.proteins || 0;
            const glucides = nutriments.carbohydrates_100g || nutriments.carbohydrates || 0;
            const lipides = nutriments.fat_100g || nutriments.fat || 0;

            document.getElementById('productImage').src = image;
            document.getElementById('productImage').onerror = function() {
                this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="150" height="150"%3E%3Crect width="150" height="150" fill="%23f0f0f0"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%23999" font-size="40"%3EüçΩÔ∏è%3C/text%3E%3C/svg%3E';
            };
            
            document.getElementById('productName').textContent = nom;
            document.getElementById('productBrand').textContent = marque;
            document.getElementById('productQuantity').textContent = quantite;
            document.getElementById('productBarcode').textContent = `Code: ${codebarre}`;

            document.getElementById('productCalories').textContent = Math.round(calories);
            document.getElementById('productProteines').textContent = proteines.toFixed(1);
            document.getElementById('productGlucides').textContent = glucides.toFixed(1);
            document.getElementById('productLipides').textContent = lipides.toFixed(1);

            dernierProduit = {
                barcode: codebarre,
                nom: nom,
                marque: marque,
                quantite: quantite,
                image: image,
                calories: calories,
                proteines: proteines,
                glucides: glucides,
                lipides: lipides,
                source: product.source || 'openfoodfacts'
            };

            window.scrollTo({ top: document.getElementById('resultatScanner').offsetTop - 100, behavior: 'smooth' });
        }

        function ajouterProduitScanneAuCalculateur() {
            if (!dernierProduit) {
                alert('‚ùå Aucun produit scann√©');
                return;
            }

            // Ajouter √† la base totale si pas d√©j√† pr√©sent
            const baseTotale = obtenirBaseTotale();
            if (!baseTotale.find(a => a.nom === dernierProduit.nom)) {
                const nouveauProduit = {
                    nom: dernierProduit.nom,
                    categorie: "Produit scann√©",
                    calories: dernierProduit.calories,
                    proteines: dernierProduit.proteines,
                    glucides: dernierProduit.glucides,
                    lipides: dernierProduit.lipides,
                    source: 'scanne'
                };
                
                // Sauvegarder dans localStorage
                if (!produitsSauvegardes.find(p => p.barcode === dernierProduit.barcode)) {
                    produitsSauvegardes.unshift({
                        ...dernierProduit,
                        dateAjout: new Date().toISOString()
                    });
                    localStorage.setItem('produits', JSON.stringify(produitsSauvegardes));
                }
            }

            // Aller au calculateur
            showTab('calculateur');
            
            // Remplir le champ de recherche
            setTimeout(() => {
                document.getElementById('searchAliment').value = dernierProduit.nom;
                document.getElementById('quantiteAliment').value = '100';
                document.getElementById('quantiteAliment').focus();
                
                afficherNotification(`‚úÖ ${dernierProduit.nom} ajout√© √† vos aliments !`);
                afficherSyncIndicator('‚úÖ Produit synchronis√© !');
            }, 300);
        }

        function sauvegarderProduit() {
            if (!dernierProduit) {
                alert('‚ùå Aucun produit √† sauvegarder');
                return;
            }

            // V√©rifier si d√©j√† sauvegard√©
            const dejaExiste = produitsSauvegardes.find(p => p.barcode === dernierProduit.barcode);
            
            if (dejaExiste) {
                afficherNotification('‚ÑπÔ∏è Ce produit est d√©j√† sauvegard√©', 'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)');
                afficherListeProduits();
                return;
            }

            // Sauvegarder
            produitsSauvegardes.unshift({
                ...dernierProduit,
                dateAjout: new Date().toISOString()
            });
            localStorage.setItem('produits', JSON.stringify(produitsSauvegardes));

            afficherListeProduits();
            afficherNotification('‚úÖ Produit sauvegard√© avec succ√®s !');
            afficherSyncIndicator('‚úÖ Produit disponible partout !');
        }

        function afficherListeProduits() {
            const liste = document.getElementById('listeProduits');
            
            if (produitsSauvegardes.length === 0) {
                liste.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 3em; margin-bottom: 15px;">üì¶</div>
                        <p style="color: #999; font-size: 1.1em;">Aucun produit scann√©</p>
                    </div>
                `;
                return;
            }

            liste.innerHTML = produitsSauvegardes.map((produit, index) => `
                <div class="weight-item" style="flex-direction: column; align-items: stretch; margin-bottom: 15px;">
                    <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                        <img src="${produit.image}" alt="${produit.nom}" style="width: 80px; height: 80px; object-fit: contain; border-radius: 8px; background: #f8f9fa;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333; font-size: 1.1em; margin-bottom: 3px;">${produit.nom}</div>
                            <div style="color: #667eea; font-size: 0.9em; margin-bottom: 3px;">${produit.marque}</div>
                            <div style="color: #999; font-size: 0.85em;">${produit.quantite || ''}</div>
                        </div>
                        <button class="delete" onclick="supprimerProduitScanne(${index})">Supprimer</button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #667eea;">${Math.round(produit.calories)}</div>
                            <div style="font-size: 0.8em; color: #666;">kcal</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #f5576c;">${produit.proteines.toFixed(1)}g</div>
                            <div style="font-size: 0.8em; color: #666;">prot√©ines</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #00f2fe;">${produit.glucides.toFixed(1)}g</div>
                            <div style="font-size: 0.8em; color: #666;">glucides</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #38f9d7;">${produit.lipides.toFixed(1)}g</div>
                            <div style="font-size: 0.8em; color: #666;">lipides</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function supprimerProduitScanne(index) {
            const produit = produitsSauvegardes[index];
            
            if (confirm(`Voulez-vous vraiment supprimer "${produit.nom}" ?`)) {
                produitsSauvegardes.splice(index, 1);
                localStorage.setItem('produits', JSON.stringify(produitsSauvegardes));
                afficherListeProduits();
                afficherNotification('‚úÖ Produit supprim√©');
            }
        }

        // ==============================================
        // FONCTIONS PRODUITS PERSO (stubs)
        // ==============================================
        
        function ajouterProduitPerso() {
            const nom = document.getElementById('nomProduitPerso').value.trim();
            const marque = document.getElementById('marqueProduitPerso').value.trim();
            const codebarre = document.getElementById('codebarreProduitPerso').value.trim();
            const calories = parseFloat(document.getElementById('caloriesProduitPerso').value);
            const proteines = parseFloat(document.getElementById('proteinesProduitPerso').value);
            const glucides = parseFloat(document.getElementById('glucidesProduitPerso').value);
            const lipides = parseFloat(document.getElementById('lipidesProduitPerso').value);

            if (!nom) {
                alert('‚ö†Ô∏è Le nom du produit est obligatoire');
                return;
            }

            if (!codebarre || !/^\d{13}$/.test(codebarre)) {
                alert('‚ö†Ô∏è Le code-barres doit contenir exactement 13 chiffres');
                return;
            }

            if (isNaN(calories) || isNaN(proteines) || isNaN(glucides) || isNaN(lipides)) {
                alert('‚ö†Ô∏è Toutes les valeurs nutritionnelles doivent √™tre remplies');
                return;
            }

            const produit = {
                id: Date.now(),
                barcode: codebarre,
                nom: nom,
                marque: marque || 'Produit personnel',
                calories: calories,
                proteines: proteines,
                glucides: glucides,
                lipides: lipides,
                dateAjout: new Date().toISOString(),
                source: 'personnel'
            };

            produitsPerso.unshift(produit);
            localStorage.setItem('produitsPerso', JSON.stringify(produitsPerso));

            afficherProduitsPerso();

            document.getElementById('nomProduitPerso').value = '';
            document.getElementById('marqueProduitPerso').value = '';
            document.getElementById('codebarreProduitPerso').value = '';
            document.getElementById('caloriesProduitPerso').value = '';
            document.getElementById('proteinesProduitPerso').value = '';
            document.getElementById('glucidesProduitPerso').value = '';
            document.getElementById('lipidesProduitPerso').value = '';

            afficherNotification('‚úÖ Produit ajout√© √† votre base perso !');
            afficherSyncIndicator('‚úÖ Produit synchronis√© !');
        }

        function afficherProduitsPerso() {
            const liste = document.getElementById('listeProduitsPerso');
            const compteur = document.getElementById('compteurProduitsPerso');
            const compteurScanner = document.getElementById('compteurProduitsScannerPerso');

            compteur.textContent = produitsPerso.length;
            if (compteurScanner) compteurScanner.textContent = produitsPerso.length;
            
            // Mettre √† jour le compteur base communautaire
            const compteurCommunautaire = document.getElementById('compteurBaseCommunautaire');
            if (compteurCommunautaire) {
                compteurCommunautaire.textContent = baseCommunautaire.length.toLocaleString();
            }

            if (produitsPerso.length === 0) {
                liste.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 3em; margin-bottom: 15px;">üìù</div>
                        <p style="color: #999; font-size: 1.1em;">Aucun produit personnalis√©</p>
                    </div>
                `;
                return;
            }

            liste.innerHTML = produitsPerso.map((produit, index) => `
                <div class="weight-item" style="flex-direction: column; align-items: stretch; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333; font-size: 1.1em;">${produit.nom}</div>
                            <div style="color: #667eea; font-size: 0.9em;">${produit.marque}</div>
                            <div style="color: #999; font-size: 0.85em; margin-top: 5px;">Code: ${produit.barcode}</div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="partagerProduitCommunaute(produitsPerso[${index}])" style="margin: 0; padding: 8px 15px; font-size: 0.85em; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">
                                üåç Partager
                            </button>
                            <button class="delete" onclick="supprimerProduitPerso(${index})">Supprimer</button>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #667eea;">${Math.round(produit.calories)}</div>
                            <div style="font-size: 0.8em; color: #666;">kcal</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #f5576c;">${produit.proteines.toFixed(1)}g</div>
                            <div style="font-size: 0.8em; color: #666;">prot√©ines</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #00f2fe;">${produit.glucides.toFixed(1)}g</div>
                            <div style="font-size: 0.8em; color: #666;">glucides</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #38f9d7;">${produit.lipides.toFixed(1)}g</div>
                            <div style="font-size: 0.8em; color: #666;">lipides</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function supprimerProduitPerso(index) {
            const produit = produitsPerso[index];
            
            if (confirm(`Voulez-vous vraiment supprimer "${produit.nom}" de votre base personnelle ?`)) {
                produitsPerso.splice(index, 1);
                localStorage.setItem('produitsPerso', JSON.stringify(produitsPerso));
                afficherProduitsPerso();
                afficherSyncIndicator('‚úÖ Produit retir√© !');
            }
        }

        // ==============================================
        // FONCTIONS COACH IA (stub)
        // ==============================================
        
        function actualiserCoachIA() {
            document.getElementById('tableauBordIA').innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìä Votre tableau de bord</h3>
                    <p style="color: #666;">Continuez √† utiliser l'application pour voir vos statistiques !</p>
                </div>
            `;
        }

        // ==============================================
        // COACH IA - API GROQ GRATUITE
        // ==============================================

        let conversationIA = [];

        // Charger la cl√© API au d√©marrage
        function chargerCleAPI() {
            const cle = localStorage.getItem('cleAPIGroq');
            if (cle) {
                document.getElementById('cleAPIGroq').value = cle;
                activerChatIA();
                afficherStatutCle('‚úÖ Cl√© API configur√©e ! Vous pouvez poser vos questions.', '#4caf50');
            }
        }

        // Sauvegarder la cl√© API
        function sauvegarderCleAPI() {
            const cle = document.getElementById('cleAPIGroq').value.trim();
            
            if (!cle) {
                afficherStatutCle('‚ö†Ô∏è Veuillez entrer une cl√© API', '#ff9800');
                return;
            }
            
            if (!cle.startsWith('gsk_')) {
                afficherStatutCle('‚ö†Ô∏è La cl√© doit commencer par "gsk_"', '#ff9800');
                return;
            }
            
            localStorage.setItem('cleAPIGroq', cle);
            activerChatIA();
            afficherStatutCle('‚úÖ Cl√© sauvegard√©e avec succ√®s !', '#4caf50');
            afficherNotification('üîë Cl√© API configur√©e ! Vous pouvez maintenant discuter avec le Coach IA.', 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)');
        }

        // Tester la cl√© API
        async function testerCleAPI() {
            const cle = document.getElementById('cleAPIGroq').value.trim();
            
            if (!cle) {
                afficherStatutCle('‚ö†Ô∏è Veuillez entrer une cl√© API', '#ff9800');
                return;
            }
            
            afficherStatutCle('üîÑ Test en cours...', '#2196f3');
            
            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + cle
                    },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: [{ role: 'user', content: 'Dis juste "OK" si tu me re√ßois' }],
                        max_tokens: 10
                    })
                });
                
                if (response.ok) {
                    afficherStatutCle('‚úÖ Cl√© valide ! Tout fonctionne parfaitement.', '#4caf50');
                    localStorage.setItem('cleAPIGroq', cle);
                    activerChatIA();
                    afficherNotification('‚úÖ Test r√©ussi ! Votre cl√© fonctionne parfaitement.', 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)');
                } else {
                    afficherStatutCle('‚ùå Cl√© invalide. V√©rifiez que vous avez bien copi√© la cl√© compl√®te.', '#f44336');
                }
            } catch (error) {
                afficherStatutCle('‚ùå Erreur de connexion. V√©rifiez votre connexion internet.', '#f44336');
            }
        }

        // Afficher le statut de la cl√©
        function afficherStatutCle(message, couleur) {
            const statut = document.getElementById('statutCleAPI');
            statut.style.display = 'block';
            statut.style.background = couleur;
            statut.style.color = 'white';
            statut.innerHTML = message;
        }

        // Activer le chat IA
        function activerChatIA() {
            document.getElementById('questionIA').disabled = false;
            document.getElementById('btnEnvoyerIA').disabled = false;
            document.getElementById('questionIA').placeholder = 'Posez votre question ici...';
            
            // Mettre √† jour le message de bienvenue
            const chatIA = document.getElementById('chatIA');
            if (chatIA.querySelector('div[style*="text-align: center"]')) {
                chatIA.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #999;">
                        <div style="font-size: 3em; margin-bottom: 10px;">üí¨</div>
                        <p>Posez votre premi√®re question au Coach IA !</p>
                        <p style="font-size: 0.85em; margin-top: 10px;">Exemples : "Comment perdre du poids efficacement ?", "Quels aliments pour plus d'√©nergie ?", "Programme d'exercices pour d√©butant"</p>
                    </div>
                `;
            }
        }

        async function envoyerQuestionIA() {
            const cleAPI = localStorage.getItem('cleAPIGroq');
            
            if (!cleAPI) {
                afficherNotification('‚ö†Ô∏è Veuillez d\'abord configurer votre cl√© API Groq', 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)');
                return;
            }
            
            const questionInput = document.getElementById('questionIA');
            const question = questionInput.value.trim();

            if (!question) {
                afficherNotification('‚ö†Ô∏è Veuillez poser une question', 'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)');
                return;
            }

            // Trouver le bouton d'envoi
            const btn = document.getElementById('btnEnvoyerIA');
            if (btn) {
                btn.disabled = true;
                btn.textContent = '‚è≥ R√©flexion...';
            }

            // Afficher la question de l'utilisateur
            ajouterMessageChat('user', question);
            questionInput.value = '';

            // Cr√©er le contexte personnalis√© avec les donn√©es de l'utilisateur
            const contexte = `Tu es un coach sportif et nutritionniste professionnel et bienveillant.
            
Informations sur l'utilisateur :
- Nom : ${userData.nom || 'Utilisateur'}
- Objectif : ${userData.objectif || 'Non d√©fini'}
- Poids actuel : ${userData.poidsActuel || 'Non d√©fini'} kg
- Poids objectif : ${userData.poidsObjectif || 'Non d√©fini'} kg

R√©ponds de mani√®re personnalis√©e, encourageante et professionnelle. Donne des conseils concrets et applicables imm√©diatement.`;

            try {
                // Appel API Groq avec la cl√© de l'utilisateur
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + cleAPI
                    },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: [
                            {
                                role: 'system',
                                content: contexte
                            },
                            ...conversationIA,
                            {
                                role: 'user',
                                content: question
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error('Erreur API: ' + response.status);
                }

                const data = await response.json();
                const reponse = data.choices[0].message.content;

                // Sauvegarder dans l'historique
                conversationIA.push({
                    role: 'user',
                    content: question
                });
                conversationIA.push({
                    role: 'assistant',
                    content: reponse
                });

                // Afficher la r√©ponse
                ajouterMessageChat('assistant', reponse);

            } catch (error) {
                console.error('Erreur IA:', error);
                ajouterMessageChat('error', 'D√©sol√©, je n\'ai pas pu traiter votre question. Veuillez r√©essayer dans quelques instants.');
            } finally {
                // R√©activer le bouton
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'üì§ Envoyer';
                }
            }
        }

        function ajouterMessageChat(type, message) {
            const chatIA = document.getElementById('chatIA');
            
            // Supprimer le message de bienvenue si pr√©sent
            if (chatIA.querySelector('div[style*="text-align: center"]')) {
                chatIA.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'margin-bottom: 15px; animation: slideIn 0.3s ease;';

            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div style="display: flex; justify-content: flex-end;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 18px; border-radius: 18px 18px 4px 18px; max-width: 70%; word-wrap: break-word;">
                            <strong style="display: block; margin-bottom: 5px; font-size: 0.85em; opacity: 0.9;">Vous</strong>
                            ${message.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `;
            } else if (type === 'assistant') {
                messageDiv.innerHTML = `
                    <div style="display: flex; justify-content: flex-start;">
                        <div style="background: white; border: 2px solid #667eea; color: #333; padding: 12px 18px; border-radius: 18px 18px 18px 4px; max-width: 70%; word-wrap: break-word;">
                            <strong style="display: block; margin-bottom: 5px; color: #667eea; font-size: 0.85em;">ü§ñ Coach IA</strong>
                            ${message.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `;
            } else if (type === 'error') {
                messageDiv.innerHTML = `
                    <div style="text-align: center;">
                        <div style="background: #fee; border: 2px solid #fcc; color: #c00; padding: 12px 18px; border-radius: 10px; display: inline-block;">
                            ‚ö†Ô∏è ${message}
                        </div>
                    </div>
                `;
            }

            chatIA.appendChild(messageDiv);
            chatIA.scrollTop = chatIA.scrollHeight;
        }


        // ==============================================
        // FONCTIONS FRIGO & SUGGESTIONS RECETTES
        // ==============================================

        let scannerFrigoActif = false;
        let dernierCodeFrigo = null;
        let timeoutFrigo = null;

        function demarrerScannerFrigo() {
            document.getElementById('scanPlaceholderFrigo').style.display = 'none';
            document.getElementById('interactiveFrigo').style.display = 'block';
            document.getElementById('startScanBtnFrigo').style.display = 'none';
            document.getElementById('stopScanBtnFrigo').style.display = 'inline-block';
            document.getElementById('erreurPermissionFrigo').style.display = 'none';
            document.getElementById('produitScanneFrigo').style.display = 'none';

            scannerFrigoActif = true;
            dernierCodeFrigo = null;

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactiveFrigo'),
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: "environment"
                    }
                },
                decoder: {
                    readers: [
                        "ean_reader",
                        "ean_8_reader",
                        "code_128_reader",
                        "code_39_reader",
                        "upc_reader",
                        "upc_e_reader"
                    ]
                },
                locate: true,
                locator: {
                    patchSize: "medium",
                    halfSample: true
                }
            }, function(err) {
                if (err) {
                    console.error('Erreur Quagga Frigo:', err);
                    document.getElementById('erreurPermissionFrigo').style.display = 'block';
                    document.getElementById('interactiveFrigo').style.display = 'none';
                    document.getElementById('scanPlaceholderFrigo').style.display = 'flex';
                    document.getElementById('startScanBtnFrigo').style.display = 'inline-block';
                    document.getElementById('stopScanBtnFrigo').style.display = 'none';
                    scannerFrigoActif = false;
                    return;
                }
                console.log("Scanner frigo initialis√©");
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                if (!scannerFrigoActif) return;

                const code = result.codeResult.code;
                
                if (dernierCodeFrigo === code) {
                    return;
                }

                if (timeoutFrigo) {
                    clearTimeout(timeoutFrigo);
                }

                timeoutFrigo = setTimeout(function() {
                    dernierCodeFrigo = code;
                    console.log("Code-barres frigo d√©tect√©:", code);
                    
                    const beep = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE=');
                    beep.play().catch(e => console.log('Beep non jou√©'));

                    arreterScannerFrigo();
                    scannerPourFrigoAuto(code);
                }, 500);
            });
        }

        function arreterScannerFrigo() {
            if (scannerFrigoActif) {
                Quagga.stop();
                scannerFrigoActif = false;
            }
            
            document.getElementById('interactiveFrigo').style.display = 'none';
            document.getElementById('scanPlaceholderFrigo').style.display = 'flex';
            document.getElementById('startScanBtnFrigo').style.display = 'inline-block';
            document.getElementById('stopScanBtnFrigo').style.display = 'none';
        }

        async function scannerPourFrigoAuto(codebarre) {
            document.getElementById('loadingScannerFrigo').style.display = 'block';
            document.getElementById('produitScanneFrigo').style.display = 'none';

            // Chercher le produit
            let produit = null;

            // 1. Base locale
            produit = baseProduitsCourants.find(p => p.barcode === codebarre);
            if (produit) {
                afficherProduitScanneFrigo(produit);
                document.getElementById('loadingScannerFrigo').style.display = 'none';
                return;
            }

            // 2. Base perso
            produit = produitsPerso.find(p => p.barcode === codebarre);
            if (produit) {
                afficherProduitScanneFrigo(produit);
                document.getElementById('loadingScannerFrigo').style.display = 'none';
                return;
            }

            // 3. Produits scann√©s
            produit = produitsSauvegardes.find(p => p.barcode === codebarre);
            if (produit) {
                afficherProduitScanneFrigo(produit);
                document.getElementById('loadingScannerFrigo').style.display = 'none';
                return;
            }

            // 4. Base communautaire
            produit = rechercherDansBaseCommunautaire(codebarre);
            if (produit) {
                afficherProduitScanneFrigo(produit);
                document.getElementById('loadingScannerFrigo').style.display = 'none';
                afficherNotification('üåç Produit trouv√© dans la base communautaire !', 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)');
                return;
            }

            // 5. OpenFoodFacts
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${codebarre}.json`);
                const data = await response.json();

                if (data.status === 1 && data.product) {
                    const nutriments = data.product.nutriments || {};
                    const produitTrouve = {
                        barcode: codebarre,
                        nom: data.product.product_name || 'Produit inconnu',
                        marque: data.product.brands || '',
                        calories: nutriments['energy-kcal_100g'] || nutriments['energy-kcal'] || 0,
                        proteines: nutriments.proteins_100g || nutriments.proteins || 0,
                        glucides: nutriments.carbohydrates_100g || nutriments.carbohydrates || 0,
                        lipides: nutriments.fat_100g || nutriments.fat || 0
                    };
                    afficherProduitScanneFrigo(produitTrouve);
                } else {
                    afficherNotification('‚ùå Produit non trouv√©. Ajoutez-le dans "üìù Ma Base Perso"', 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)');
                }
            } catch (error) {
                afficherNotification('‚ùå Erreur de connexion', 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)');
            }

            document.getElementById('loadingScannerFrigo').style.display = 'none';
        }

        async function scannerPourFrigoManuel() {
            const codebarre = document.getElementById('scanFrigoManual').value.trim();
            
            if (!codebarre) {
                alert('‚ö†Ô∏è Veuillez saisir un code-barres');
                return;
            }

            if (!/^\d{8,13}$/.test(codebarre)) {
                alert('‚ö†Ô∏è Le code-barres doit contenir entre 8 et 13 chiffres');
                return;
            }

            scannerPourFrigoAuto(codebarre);
            document.getElementById('scanFrigoManual').value = '';
        }

        function afficherProduitScanneFrigo(produit, ajouterAutomatiquement = true) {
            // Cr√©er un modal de confirmation avec possibilit√© de correction
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 25px; max-width: 500px; width: 100%;">
                    <h3 style="color: #4caf50; margin-bottom: 20px; text-align: center;">üßä Produit d√©tect√© pour le frigo</h3>
                    
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="margin-bottom: 10px;"><strong>üì¶ Nom:</strong> <span id="modalFrigoNom">${produit.nom}</span></div>
                        <div style="margin-bottom: 10px;"><strong>üè∑Ô∏è Marque:</strong> <span id="modalFrigoMarque">${produit.marque || 'N/A'}</span></div>
                        <div style="margin-bottom: 10px;"><strong>üìä Code:</strong> ${produit.barcode}</div>
                        <div style="margin-bottom: 10px;"><strong>üî• Calories:</strong> <span id="modalFrigoCalories">${produit.calories}</span> kcal/100g</div>
                        <div style="margin-bottom: 10px;"><strong>üí™ Prot√©ines:</strong> <span id="modalFrigoProteines">${produit.proteines}</span>g/100g</div>
                        <div style="margin-bottom: 10px;"><strong>üçû Glucides:</strong> <span id="modalFrigoGlucides">${produit.glucides}</span>g/100g</div>
                        <div style="margin-bottom: 10px;"><strong>üßà Lipides:</strong> <span id="modalFrigoLipides">${produit.lipides}</span>g/100g</div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button onclick="confirmerProduitFrigo(${JSON.stringify(produit).replace(/"/g, '&quot;')})" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                            ‚úÖ Ajouter au frigo
                        </button>
                        <button onclick="corrigerProduitFrigo('${produit.barcode}')" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                            ‚úèÔ∏è Corriger
                        </button>
                    </div>

                    <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; padding: 10px; background: #ddd; color: #333; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        ‚ùå Annuler
                    </button>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function confirmerProduitFrigo(produit) {
            // R√©cup√©rer les valeurs modifi√©es si correction
            const nom = document.getElementById('modalFrigoNom').textContent;
            const marque = document.getElementById('modalFrigoMarque').textContent;
            const calories = parseFloat(document.getElementById('modalFrigoCalories').textContent);
            const proteines = parseFloat(document.getElementById('modalFrigoProteines').textContent);
            const glucides = parseFloat(document.getElementById('modalFrigoGlucides').textContent);
            const lipides = parseFloat(document.getElementById('modalFrigoLipides').textContent);

            const produitAjuste = {
                ...produit,
                nom: nom,
                marque: marque,
                calories: calories,
                proteines: proteines,
                glucides: glucides,
                lipides: lipides
            };

            ajouterAuFrigo(produitAjuste);
            
            // Fermer le modal
            document.querySelectorAll('body > div').forEach(el => {
                if (el.style.position === 'fixed' && el.style.zIndex === '10000') {
                    el.remove();
                }
            });
        }

        function corrigerProduitFrigo(codebarre) {
            // Passer en mode √©dition
            document.getElementById('modalFrigoNom').contentEditable = true;
            document.getElementById('modalFrigoNom').style.background = '#fff3cd';
            document.getElementById('modalFrigoNom').style.padding = '5px';
            document.getElementById('modalFrigoNom').style.border = '1px solid #ffc107';
            
            document.getElementById('modalFrigoMarque').contentEditable = true;
            document.getElementById('modalFrigoMarque').style.background = '#fff3cd';
            document.getElementById('modalFrigoMarque').style.padding = '5px';
            document.getElementById('modalFrigoMarque').style.border = '1px solid #ffc107';
            
            document.getElementById('modalFrigoCalories').contentEditable = true;
            document.getElementById('modalFrigoCalories').style.background = '#fff3cd';
            document.getElementById('modalFrigoCalories').style.padding = '5px';
            document.getElementById('modalFrigoCalories').style.border = '1px solid #ffc107';
            
            document.getElementById('modalFrigoProteines').contentEditable = true;
            document.getElementById('modalFrigoProteines').style.background = '#fff3cd';
            document.getElementById('modalFrigoProteines').style.padding = '5px';
            document.getElementById('modalFrigoProteines').style.border = '1px solid #ffc107';
            
            document.getElementById('modalFrigoGlucides').contentEditable = true;
            document.getElementById('modalFrigoGlucides').style.background = '#fff3cd';
            document.getElementById('modalFrigoGlucides').style.padding = '5px';
            document.getElementById('modalFrigoGlucides').style.border = '1px solid #ffc107';
            
            document.getElementById('modalFrigoLipides').contentEditable = true;
            document.getElementById('modalFrigoLipides').style.background = '#fff3cd';
            document.getElementById('modalFrigoLipides').style.padding = '5px';
            document.getElementById('modalFrigoLipides').style.border = '1px solid #ffc107';

            afficherNotification('‚úèÔ∏è Mode correction activ√© ! Cliquez sur les valeurs pour les modifier', 'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)');
        }

        // Fonctions photo pour frigo
        let streamPhotoFrigo = null;

        async function demarrerPhotoFrigo() {
            document.getElementById('photoFrigo').style.display = 'block';
            document.getElementById('scanPlaceholderFrigo').style.display = 'none';
            document.getElementById('interactiveFrigo').style.display = 'none';
            document.getElementById('startScanBtnFrigo').style.display = 'none';
            document.getElementById('stopScanBtnFrigo').style.display = 'inline-block';
            
            try {
                streamPhotoFrigo = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                document.getElementById('videoPhotoFrigo').srcObject = streamPhotoFrigo;
            } catch (error) {
                console.error('Erreur cam√©ra:', error);
                afficherNotification('‚ùå Impossible d\'acc√©der √† la cam√©ra', 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)');
                arreterPhotoFrigo();
            }
        }

        function arreterPhotoFrigo() {
            if (streamPhotoFrigo) {
                streamPhotoFrigo.getTracks().forEach(track => track.stop());
                streamPhotoFrigo = null;
            }
            document.getElementById('photoFrigo').style.display = 'none';
            document.getElementById('scanPlaceholderFrigo').style.display = 'flex';
            document.getElementById('startScanBtnFrigo').style.display = 'inline-block';
            document.getElementById('stopScanBtnFrigo').style.display = 'none';
        }

        async function capturerPhotoFrigo() {
            const video = document.getElementById('videoPhotoFrigo');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            arreterPhotoFrigo();
            
            afficherNotification('üîç Analyse de l\'image en cours...', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');
            
            const imageBase64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
            
            await analyserImageAliment(imageBase64, 'frigo');
        }

        function afficherModalConfirmationImageFrigo(produit) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;

            const confiance = produit.confiance || 'moyenne';
            const couleurConfiance = confiance === 'haute' ? '#4caf50' : confiance === 'moyenne' ? '#ff9800' : '#f44336';

            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 25px; max-width: 500px; width: 100%;">
                    <h3 style="color: #4caf50; margin-bottom: 20px; text-align: center;">üßä Aliment pour le frigo</h3>
                    
                    <div style="background: ${couleurConfiance}; color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                        <strong>Confiance: ${confiance}</strong>
                    </div>
                    
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="margin-bottom: 10px;"><strong>üì¶ Nom:</strong> <span id="modalImageFrigoNom">${produit.nom}</span></div>
                        <div style="margin-bottom: 10px;"><strong>üî• Calories:</strong> <span id="modalImageFrigoCalories">${produit.calories}</span> kcal/100g</div>
                        <div style="margin-bottom: 10px;"><strong>üí™ Prot√©ines:</strong> <span id="modalImageFrigoProteines">${produit.proteines}</span>g/100g</div>
                        <div style="margin-bottom: 10px;"><strong>üçû Glucides:</strong> <span id="modalImageFrigoGlucides">${produit.glucides}</span>g/100g</div>
                        <div style="margin-bottom: 10px;"><strong>üßà Lipides:</strong> <span id="modalImageFrigoLipides">${produit.lipides}</span>g/100g</div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button onclick="confirmerImageFrigo(${JSON.stringify(produit).replace(/"/g, '&quot;')})" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                            ‚úÖ Ajouter au frigo
                        </button>
                        <button onclick="corrigerImageFrigo()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                            ‚úèÔ∏è Corriger
                        </button>
                    </div>

                    <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; padding: 10px; background: #ddd; color: #333; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        ‚ùå Annuler
                    </button>
                </div>
            `;

            document.body.appendChild(modal);
            afficherNotification('‚úÖ Aliment identifi√© !', 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)');
        }

        function confirmerImageFrigo(produit) {
            const nom = document.getElementById('modalImageFrigoNom').textContent;
            const calories = parseFloat(document.getElementById('modalImageFrigoCalories').textContent);
            const proteines = parseFloat(document.getElementById('modalImageFrigoProteines').textContent);
            const glucides = parseFloat(document.getElementById('modalImageFrigoGlucides').textContent);
            const lipides = parseFloat(document.getElementById('modalImageFrigoLipides').textContent);

            const produitFrigo = {
                barcode: 'IMAGE_' + Date.now(),
                nom: nom,
                marque: 'D√©tect√© par photo',
                calories: calories,
                proteines: proteines,
                glucides: glucides,
                lipides: lipides
            };

            ajouterAuFrigo(produitFrigo);
            
            document.querySelectorAll('body > div').forEach(el => {
                if (el.style.position === 'fixed' && el.style.zIndex === '10000') {
                    el.remove();
                }
            });
        }

        function corrigerImageFrigo() {
            document.getElementById('modalImageFrigoNom').contentEditable = true;
            document.getElementById('modalImageFrigoNom').style.background = '#fff3cd';
            document.getElementById('modalImageFrigoNom').style.padding = '5px';
            document.getElementById('modalImageFrigoNom').style.border = '1px solid #ffc107';
            
            document.getElementById('modalImageFrigoCalories').contentEditable = true;
            document.getElementById('modalImageFrigoCalories').style.background = '#fff3cd';
            document.getElementById('modalImageFrigoCalories').style.padding = '5px';
            document.getElementById('modalImageFrigoCalories').style.border = '1px solid #ffc107';
            
            document.getElementById('modalImageFrigoProteines').contentEditable = true;
            document.getElementById('modalImageFrigoProteines').style.background = '#fff3cd';
            document.getElementById('modalImageFrigoProteines').style.padding = '5px';
            document.getElementById('modalImageFrigoProteines').style.border = '1px solid #ffc107';
            
            document.getElementById('modalImageFrigoGlucides').contentEditable = true;
            document.getElementById('modalImageFrigoGlucides').style.background = '#fff3cd';
            document.getElementById('modalImageFrigoGlucides').style.padding = '5px';
            document.getElementById('modalImageFrigoGlucides').style.border = '1px solid #ffc107';
            
            document.getElementById('modalImageFrigoLipides').contentEditable = true;
            document.getElementById('modalImageFrigoLipides').style.background = '#fff3cd';
            document.getElementById('modalImageFrigoLipides').style.padding = '5px';
            document.getElementById('modalImageFrigoLipides').style.border = '1px solid #ffc107';

            afficherNotification('‚úèÔ∏è Mode correction activ√© !', 'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)');
        }

        async function scannerPourFrigo() {
            const codebarre = document.getElementById('scanFrigoManual').value.trim();
            
            if (!codebarre) {
                alert('‚ö†Ô∏è Veuillez saisir un code-barres');
                return;
            }

            if (!/^\d{8,13}$/.test(codebarre)) {
                alert('‚ö†Ô∏è Le code-barres doit contenir entre 8 et 13 chiffres');
                return;
            }

            // Chercher le produit
            let produit = null;

            // 1. Base locale
            produit = baseProduitsCourants.find(p => p.barcode === codebarre);
            if (produit) {
                ajouterAuFrigo({
                    barcode: codebarre,
                    nom: produit.nom,
                    marque: produit.marque,
                    calories: produit.calories,
                    proteines: produit.proteines,
                    glucides: produit.glucides,
                    lipides: produit.lipides
                });
                return;
            }

            // 2. Base perso
            produit = produitsPerso.find(p => p.barcode === codebarre);
            if (produit) {
                ajouterAuFrigo(produit);
                return;
            }

            // 3. Produits scann√©s
            produit = produitsSauvegardes.find(p => p.barcode === codebarre);
            if (produit) {
                ajouterAuFrigo(produit);
                return;
            }

            // 4. OpenFoodFacts
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${codebarre}.json`);
                const data = await response.json();

                if (data.status === 1 && data.product) {
                    const nutriments = data.product.nutriments || {};
                    ajouterAuFrigo({
                        barcode: codebarre,
                        nom: data.product.product_name || 'Produit inconnu',
                        marque: data.product.brands || '',
                        calories: nutriments['energy-kcal_100g'] || nutriments['energy-kcal'] || 0,
                        proteines: nutriments.proteins_100g || nutriments.proteins || 0,
                        glucides: nutriments.carbohydrates_100g || nutriments.carbohydrates || 0,
                        lipides: nutriments.fat_100g || nutriments.fat || 0
                    });
                } else {
                    alert('‚ùå Produit non trouv√©. Ajoutez-le d\'abord dans "üìù Ma Base Perso"');
                }
            } catch (error) {
                alert('‚ùå Erreur de connexion. V√©rifiez votre internet.');
            }
        }

        function ajouterAuFrigo(produit) {
            // V√©rifier si d√©j√† dans le frigo
            if (produitsFrigo.find(p => p.barcode === produit.barcode)) {
                afficherNotification('‚ÑπÔ∏è Ce produit est d√©j√† dans votre frigo', 'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)');
                return;
            }

            produitsFrigo.push({
                ...produit,
                dateAjout: new Date().toISOString()
            });
            localStorage.setItem('produitsFrigo', JSON.stringify(produitsFrigo));

            document.getElementById('scanFrigoManual').value = '';
            afficherFrigo();
            afficherProduitsDisponiblesFrigo();
            afficherNotification(`‚úÖ ${produit.nom} ajout√© au frigo !`);
            afficherSyncIndicator('üßä Frigo mis √† jour !');
        }

        function ajouterAuFrigoRapide(index) {
            const produit = produitsSauvegardes[index];
            ajouterAuFrigo(produit);
        }

        function afficherFrigo() {
            const liste = document.getElementById('listeFrigo');
            const compteur = document.getElementById('compteurFrigo');

            compteur.textContent = produitsFrigo.length;

            if (produitsFrigo.length === 0) {
                liste.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; border: 2px dashed #ddd;">
                        <div style="font-size: 3em; margin-bottom: 15px;">üßä</div>
                        <p style="color: #999; font-size: 1.1em;">Votre frigo est vide</p>
                        <p style="color: #666; font-size: 0.9em; margin-top: 10px;">Scannez ou ajoutez des produits ci-dessus</p>
                    </div>
                `;
                return;
            }

            liste.innerHTML = produitsFrigo.map((produit, index) => `
                <div class="weight-item" style="flex-direction: row; align-items: center; margin-bottom: 10px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #333; font-size: 1em;">${produit.nom}</div>
                        <div style="color: #666; font-size: 0.85em;">${produit.marque || ''}</div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div style="text-align: center; padding: 5px 10px; background: white; border-radius: 5px;">
                            <div style="font-weight: bold; color: #4caf50; font-size: 0.9em;">${Math.round(produit.calories)}</div>
                            <div style="font-size: 0.7em; color: #666;">kcal</div>
                        </div>
                        <button class="delete" onclick="retirerDuFrigo(${index})" style="padding: 5px 10px;">√ó</button>
                    </div>
                </div>
            `).join('');
        }

        function retirerDuFrigo(index) {
            const produit = produitsFrigo[index];
            if (confirm(`Retirer "${produit.nom}" du frigo ?`)) {
                produitsFrigo.splice(index, 1);
                localStorage.setItem('produitsFrigo', JSON.stringify(produitsFrigo));
                afficherFrigo();
                afficherSyncIndicator('üßä Frigo mis √† jour !');
            }
        }

        function viderFrigo() {
            if (produitsFrigo.length === 0) {
                alert('Le frigo est d√©j√† vide !');
                return;
            }

            if (confirm(`Voulez-vous vraiment vider tout le frigo (${produitsFrigo.length} produits) ?`)) {
                produitsFrigo = [];
                localStorage.setItem('produitsFrigo', JSON.stringify(produitsFrigo));
                afficherFrigo();
                document.getElementById('suggestionRecettes').style.display = 'none';
                afficherNotification('üóëÔ∏è Frigo vid√© !');
            }
        }

        function afficherProduitsDisponiblesFrigo() {
            const container = document.getElementById('produitsDisponiblesFrigo');

            if (produitsSauvegardes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; background: #f8f9fa; border-radius: 10px;">
                        <p style="color: #999;">Aucun produit scann√© disponible</p>
                        <p style="color: #666; font-size: 0.9em; margin-top: 10px;">Allez dans "üì∑ Scanner Produit" pour ajouter des produits</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                    ${produitsSauvegardes.map((produit, index) => {
                        const dejaDansFrigo = produitsFrigo.find(p => p.barcode === produit.barcode);
                        return `
                            <div style="background: white; border: 2px solid ${dejaDansFrigo ? '#ddd' : '#4caf50'}; border-radius: 10px; padding: 15px; cursor: ${dejaDansFrigo ? 'not-allowed' : 'pointer'}; opacity: ${dejaDansFrigo ? '0.5' : '1'}; transition: all 0.3s;" ${dejaDansFrigo ? '' : `onclick="ajouterAuFrigoRapide(${index})"`}>
                                <div style="font-weight: bold; color: #333; margin-bottom: 5px; font-size: 0.95em;">${produit.nom}</div>
                                <div style="color: #666; font-size: 0.85em; margin-bottom: 10px;">${produit.marque}</div>
                                <div style="background: #f0f0f0; padding: 8px; border-radius: 5px; text-align: center;">
                                    <div style="font-weight: bold; color: #4caf50;">${Math.round(produit.calories)} kcal</div>
                                </div>
                                ${dejaDansFrigo ? '<div style="text-align: center; margin-top: 10px; color: #999; font-size: 0.85em;">‚úì Dans le frigo</div>' : '<div style="text-align: center; margin-top: 10px; color: #4caf50; font-weight: bold; font-size: 0.85em;">+ Ajouter</div>'}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function suggererRecettes() {
            if (produitsFrigo.length === 0) {
                alert('‚ùå Votre frigo est vide ! Ajoutez des produits d\'abord.');
                return;
            }

            // Extraire les mots-cl√©s des produits du frigo
            const motsClesFrigo = [];
            produitsFrigo.forEach(produit => {
                const mots = produit.nom.toLowerCase().split(' ');
                mots.forEach(mot => {
                    if (mot.length > 3 && !motsClesFrigo.includes(mot)) {
                        motsClesFrigo.push(mot);
                    }
                });
            });

            // Calculer le score de correspondance pour chaque recette
            const recettesAvecScore = baseRecettes.map(recette => {
                let score = 0;
                let ingredientsTrouves = [];

                recette.ingredients.forEach(ingredient => {
                    motsClesFrigo.forEach(mot => {
                        if (ingredient.toLowerCase().includes(mot) || mot.includes(ingredient.toLowerCase())) {
                            score++;
                            if (!ingredientsTrouves.includes(ingredient)) {
                                ingredientsTrouves.push(ingredient);
                            }
                        }
                    });
                });

                return {
                    ...recette,
                    score: score,
                    ingredientsTrouves: ingredientsTrouves,
                    tauxMatch: Math.round((score / recette.ingredients.length) * 100)
                };
            });

            // Trier par score d√©croissant
            const recettesSuggerees = recettesAvecScore
                .filter(r => r.score > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 6);

            afficherSuggestionsRecettes(recettesSuggerees);
        }

        function afficherSuggestionsRecettes(recettes) {
            const container = document.getElementById('suggestionRecettes');

            if (recettes.length === 0) {
                container.style.display = 'block';
                container.innerHTML = `
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 25px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 15px;">üòï</div>
                        <h3 style="color: #856404; margin-bottom: 10px;">Aucune recette trouv√©e</h3>
                        <p style="color: #856404;">
                            Nous n'avons pas trouv√© de recettes correspondant aux produits de votre frigo.
                            Essayez d'ajouter plus d'ingr√©dients de base (riz, p√¢tes, l√©gumes, viande, etc.)
                        </p>
                    </div>
                `;
                window.scrollTo({ top: container.offsetTop - 100, behavior: 'smooth' });
                return;
            }

            container.style.display = 'block';
            container.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; text-align: center;">
                    <h3 style="font-size: 1.8em; margin-bottom: 10px;">üéØ ${recettes.length} Recette${recettes.length > 1 ? 's' : ''} Sugg√©r√©e${recettes.length > 1 ? 's' : ''}</h3>
                    <p style="opacity: 0.95; font-size: 1.1em;">Bas√©es sur les ${produitsFrigo.length} produits de votre frigo</p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                    ${recettes.map(recette => `
                        <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border: 3px solid ${recette.tauxMatch >= 75 ? '#4caf50' : recette.tauxMatch >= 50 ? '#ff9800' : '#667eea'};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <h4 style="color: #333; font-size: 1.2em; margin: 0; flex: 1;">${recette.nom}</h4>
                                <div style="background: ${recette.tauxMatch >= 75 ? 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)' : recette.tauxMatch >= 50 ? 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}; color: white; padding: 8px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9em; white-space: nowrap; margin-left: 10px;">
                                    ${recette.tauxMatch}% match
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                                <div style="text-align: center;">
                                    <div style="font-weight: bold; color: #667eea; font-size: 1.1em;">${recette.calories}</div>
                                    <div style="font-size: 0.75em; color: #666;">kcal</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-weight: bold; color: #f5576c; font-size: 1.1em;">${recette.proteines}g</div>
                                    <div style="font-size: 0.75em; color: #666;">prot√©ines</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-weight: bold; color: #00f2fe; font-size: 1.1em;">${recette.glucides}g</div>
                                    <div style="font-size: 0.75em; color: #666;">glucides</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-weight: bold; color: #38f9d7; font-size: 1.1em;">${recette.lipides}g</div>
                                    <div style="font-size: 0.75em; color: #666;">lipides</div>
                                </div>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                                    <span style="color: #666; font-size: 0.9em;">‚è±Ô∏è ${recette.temps}</span>
                                    <span style="color: #666; font-size: 0.9em;">üìä ${recette.difficulte}</span>
                                </div>
                            </div>

                            <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="font-weight: bold; color: #4caf50; font-size: 0.9em; margin-bottom: 8px;">‚úÖ Vous avez (${recette.ingredientsTrouves.length}) :</div>
                                <div style="font-size: 0.85em; color: #555;">
                                    ${recette.ingredientsTrouves.join(', ')}
                                </div>
                            </div>

                            ${recette.tauxMatch < 100 ? `
                                <div style="background: #fff3cd; padding: 12px; border-radius: 8px;">
                                    <div style="font-weight: bold; color: #856404; font-size: 0.9em; margin-bottom: 8px;">üõí Il vous manque :</div>
                                    <div style="font-size: 0.85em; color: #856404;">
                                        ${recette.ingredients.filter(ing => !recette.ingredientsTrouves.includes(ing)).join(', ')}
                                    </div>
                                </div>
                            ` : `
                                <div style="background: #4caf50; color: white; padding: 12px; border-radius: 8px; text-align: center; font-weight: bold;">
                                    üéâ Vous avez tous les ingr√©dients !
                                </div>
                            `}
                        </div>
                    `).join('')}
                </div>

                <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 20px; border-radius: 10px; margin-top: 25px; text-align: center;">
                    <p style="color: #333; font-size: 1em; margin: 0;">
                        üí° <strong>Astuce :</strong> Les recettes avec un score √©lev√© n√©cessitent moins d'achats suppl√©mentaires !
                    </p>
                </div>
            `;

            window.scrollTo({ top: container.offsetTop - 100, behavior: 'smooth' });
        }

        // ==============================================
        // SCANNER CALCULATEUR
        // ==============================================

        let scannerCalculateurActif = false;

        function demarrerScannerCalculateur() {
            document.getElementById('scannerCalculateur').style.display = 'block';
            document.getElementById('photoCalculateur').style.display = 'none';
            scannerCalculateurActif = true;

            Quagga.init({
                inputStream: {
                    type: "LiveStream",
                    target: document.querySelector('#videoCalculateur'),
                    constraints: {
                        width: { min: 640 },
                        height: { min: 480 },
                        facingMode: "environment"
                    }
                },
                decoder: {
                    readers: ["ean_reader", "ean_8_reader", "upc_reader", "code_128_reader", "code_39_reader"]
                },
                locate: true
            }, function(err) {
                if (err) {
                    console.log(err);
                    afficherNotification('‚ùå Erreur cam√©ra: ' + err.message, 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)');
                    arreterScannerCalculateur();
                    return;
                }
                console.log('‚úÖ Scanner calculateur d√©marr√©');
                Quagga.start();
            });

            Quagga.onDetected(async function(result) {
                if (scannerCalculateurActif) {
                    const codebarre = result.codeResult.code;
                    console.log('üì∑ Code-barres d√©tect√© (Calculateur):', codebarre);
                    
                    // Arr√™ter le scanner
                    arreterScannerCalculateur();
                    
                    // Scanner le produit
                    await scannerPourCalculateur(codebarre);
                }
            });
        }

        function arreterScannerCalculateur() {
            if (scannerCalculateurActif) {
                Quagga.stop();
                scannerCalculateurActif = false;
            }
            document.getElementById('scannerCalculateur').style.display = 'none';
        }

        async function scannerPourCalculateur(codebarre) {
            afficherNotification('üîç Recherche du produit...', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');

            // Chercher le produit dans toutes les bases
            let produit = null;

            // 1. Base locale
            produit = baseProduitsCourants.find(p => p.barcode === codebarre);
            if (produit) {
                afficherProduitCalculateur(produit, codebarre);
                return;
            }

            // 2. Base perso
            produit = produitsPerso.find(p => p.barcode === codebarre);
            if (produit) {
                afficherProduitCalculateur(produit, codebarre);
                return;
            }

            // 3. Produits scann√©s
            produit = produitsSauvegardes.find(p => p.barcode === codebarre);
            if (produit) {
                afficherProduitCalculateur(produit, codebarre);
                return;
            }

            // 4. Base communautaire
            produit = rechercherDansBaseCommunautaire(codebarre);
            if (produit) {
                afficherNotification('üåç Produit trouv√© dans la base communautaire !', 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)');
                afficherProduitCalculateur(produit, codebarre);
                return;
            }

            // 5. OpenFoodFacts
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${codebarre}.json`);
                const data = await response.json();

                if (data.status === 1) {
                    const product = data.product;
                    const nutriments = product.nutriments;

                    produit = {
                        barcode: codebarre,
                        nom: product.product_name || 'Produit inconnu',
                        marque: product.brands || '',
                        calories: nutriments['energy-kcal_100g'] || 0,
                        proteines: nutriments.proteins_100g || 0,
                        glucides: nutriments.carbohydrates_100g || 0,
                        lipides: nutriments.fat_100g || 0
                    };

                    afficherNotification('‚úÖ Produit trouv√© dans OpenFoodFacts !', 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)');
                    afficherProduitCalculateur(produit, codebarre);
                } else {
                    afficherNotification('‚ùå Produit non trouv√©', 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)');
                    proposerSaisieManuelle(codebarre);
                }
            } catch (error) {
                console.error('Erreur API:', error);
                afficherNotification('‚ùå Erreur de connexion', 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)');
                proposerSaisieManuelle(codebarre);
            }
        }

        function afficherProduitCalculateur(produit, codebarre) {
            // Cr√©er un modal de confirmation avec possibilit√© de correction
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 25px; max-width: 500px; width: 100%;">
                    <h3 style="color: #667eea; margin-bottom: 20px; text-align: center;">üì¶ Produit d√©tect√©</h3>
                    
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="margin-bottom: 10px;"><strong>üì¶ Nom:</strong> <span id="modalNom">${produit.nom}</span></div>
                        <div style="margin-bottom: 10px;"><strong>üè∑Ô∏è Marque:</strong> <span id="modalMarque">${produit.marque || 'N/A'}</span></div>
                        <div style="margin-bottom: 10px;"><strong>üìä Code:</strong> ${codebarre}</div>
                        <div style="margin-bottom: 10px;"><strong>üî• Calories:</strong> <span id="modalCalories">${produit.calories}</span> kcal/100g</div>
                        <div style="margin-bottom: 10px;"><strong>üí™ Prot√©ines:</strong> <span id="modalProteines">${produit.proteines}</span>g/100g</div>
                        <div style="margin-bottom: 10px;"><strong>üçû Glucides:</strong> <span id="modalGlucides">${produit.glucides}</span>g/100g</div>
                        <div style="margin-bottom: 10px;"><strong>üßà Lipides:</strong> <span id="modalLipides">${produit.lipides}</span>g/100g</div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">‚öñÔ∏è Quantit√© (grammes):</label>
                        <input type="number" id="modalQuantite" value="100" min="1" style="width: 100%; padding: 10px; border: 2px solid #667eea; border-radius: 8px; font-size: 1em;">
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button onclick="confirmerProduitCalculateur(${JSON.stringify(produit).replace(/"/g, '&quot;')})" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                            ‚úÖ Ajouter au repas
                        </button>
                        <button onclick="corrigerProduitCalculateur('${codebarre}')" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                            ‚úèÔ∏è Corriger
                        </button>
                    </div>

                    <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; padding: 10px; background: #ddd; color: #333; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        ‚ùå Annuler
                    </button>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function confirmerProduitCalculateur(produit) {
            const quantite = parseInt(document.getElementById('modalQuantite').value) || 100;
            
            // R√©cup√©rer les valeurs modifi√©es si correction
            const nom = document.getElementById('modalNom').textContent;
            const marque = document.getElementById('modalMarque').textContent;
            const calories = parseFloat(document.getElementById('modalCalories').textContent);
            const proteines = parseFloat(document.getElementById('modalProteines').textContent);
            const glucides = parseFloat(document.getElementById('modalGlucides').textContent);
            const lipides = parseFloat(document.getElementById('modalLipides').textContent);

            const produitAjuste = {
                ...produit,
                nom: nom,
                marque: marque,
                calories: calories,
                proteines: proteines,
                glucides: glucides,
                lipides: lipides
            };

            // Ajouter au calculateur
            const aliment = {
                nom: produitAjuste.nom,
                quantite: quantite,
                calories: (produitAjuste.calories * quantite) / 100,
                proteines: (produitAjuste.proteines * quantite) / 100,
                glucides: (produitAjuste.glucides * quantite) / 100,
                lipides: (produitAjuste.lipides * quantite) / 100
            };

            repasActuel.push(aliment);
            afficherRepasActuel();
            
            // Fermer le modal
            document.querySelectorAll('body > div').forEach(el => {
                if (el.style.position === 'fixed' && el.style.zIndex === '10000') {
                    el.remove();
                }
            });

            afficherNotification('‚úÖ Produit ajout√© au repas !', 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)');
        }

        function corrigerProduitCalculateur(codebarre) {
            // Passer en mode √©dition
            document.getElementById('modalNom').contentEditable = true;
            document.getElementById('modalNom').style.background = '#fff3cd';
            document.getElementById('modalNom').style.padding = '5px';
            document.getElementById('modalNom').style.border = '1px solid #ffc107';
            
            document.getElementById('modalMarque').contentEditable = true;
            document.getElementById('modalMarque').style.background = '#fff3cd';
            document.getElementById('modalMarque').style.padding = '5px';
            document.getElementById('modalMarque').style.border = '1px solid #ffc107';
            
            document.getElementById('modalCalories').contentEditable = true;
            document.getElementById('modalCalories').style.background = '#fff3cd';
            document.getElementById('modalCalories').style.padding = '5px';
            document.getElementById('modalCalories').style.border = '1px solid #ffc107';
            
            document.getElementById('modalProteines').contentEditable = true;
            document.getElementById('modalProteines').style.background = '#fff3cd';
            document.getElementById('modalProteines').style.padding = '5px';
            document.getElementById('modalProteines').style.border = '1px solid #ffc107';
            
            document.getElementById('modalGlucides').contentEditable = true;
            document.getElementById('modalGlucides').style.background = '#fff3cd';
            document.getElementById('modalGlucides').style.padding = '5px';
            document.getElementById('modalGlucides').style.border = '1px solid #ffc107';
            
            document.getElementById('modalLipides').contentEditable = true;
            document.getElementById('modalLipides').style.background = '#fff3cd';
            document.getElementById('modalLipides').style.padding = '5px';
            document.getElementById('modalLipides').style.border = '1px solid #ffc107';

            afficherNotification('‚úèÔ∏è Mode correction activ√© ! Cliquez sur les valeurs pour les modifier', 'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)');
        }

        function proposerSaisieManuelle(codebarre) {
            if (confirm('Produit non trouv√©. Voulez-vous l\'ajouter manuellement ?')) {
                // Passer dans l'onglet Ma Base Perso et pr√©-remplir le code-barres
                showTab('mabase');
                document.getElementById('nouveauProduitBarcode').value = codebarre;
                afficherNotification('üìù Remplissez les informations du produit', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');
            }
        }

        // ==============================================
        // RECONNAISSANCE VISUELLE D'ALIMENTS
        // ==============================================

        let streamPhotoCalculateur = null;

        async function demarrerPhotoCalculateur() {
            document.getElementById('photoCalculateur').style.display = 'block';
            document.getElementById('scannerCalculateur').style.display = 'none';
            
            try {
                streamPhotoCalculateur = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                document.getElementById('videoPhotoCalculateur').srcObject = streamPhotoCalculateur;
            } catch (error) {
                console.error('Erreur cam√©ra:', error);
                afficherNotification('‚ùå Impossible d\'acc√©der √† la cam√©ra', 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)');
                arreterPhotoCalculateur();
            }
        }

        function arreterPhotoCalculateur() {
            if (streamPhotoCalculateur) {
                streamPhotoCalculateur.getTracks().forEach(track => track.stop());
                streamPhotoCalculateur = null;
            }
            document.getElementById('photoCalculateur').style.display = 'none';
        }

        async function capturerPhotoCalculateur() {
            const video = document.getElementById('videoPhotoCalculateur');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            arreterPhotoCalculateur();
            
            afficherNotification('üîç Analyse de l\'image en cours...', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');
            
            // Convertir en base64
            const imageBase64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
            
            await analyserImageAliment(imageBase64, 'calculateur');
        }

        async function analyserImageAliment(imageBase64, destination) {
            const cleAPI = localStorage.getItem('cleAPIGroq');
            
            if (!cleAPI) {
                afficherNotification('‚ö†Ô∏è Configurez votre cl√© API Groq dans Coach IA', 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)');
                return;
            }
            
            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + cleAPI
                    },
                    body: JSON.stringify({
                        model: 'llama-3.2-90b-vision-preview',
                        messages: [{
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: 'Identifie cet aliment et donne ses valeurs nutritionnelles moyennes pour 100g. R√©ponds UNIQUEMENT avec un JSON valide dans ce format exact (sans texte avant ou apr√®s) :\n{"nom":"Nom de l\'aliment","calories":XXX,"proteines":XX,"glucides":XX,"lipides":XX,"confiance":"haute/moyenne/basse"}'
                                },
                                {
                                    type: 'image_url',
                                    image_url: {
                                        url: `data:image/jpeg;base64,${imageBase64}`
                                    }
                                }
                            ]
                        }],
                        temperature: 0.2,
                        max_tokens: 200
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Erreur API: ' + response.status);
                }
                
                const data = await response.json();
                let reponse = data.choices[0].message.content.trim();
                
                // Nettoyer la r√©ponse (enlever markdown si pr√©sent)
                reponse = reponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                
                const produit = JSON.parse(reponse);
                
                // Afficher le modal de confirmation
                if (destination === 'calculateur') {
                    afficherModalConfirmationImageCalculateur(produit);
                } else if (destination === 'frigo') {
                    afficherModalConfirmationImageFrigo(produit);
                }
                
            } catch (error) {
                console.error('Erreur analyse image:', error);
                afficherNotification('‚ùå Impossible d\'identifier l\'aliment. Essayez avec une meilleure photo.', 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)');
            }
        }

        function afficherModalConfirmationImageCalculateur(produit) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;

            const confiance = produit.confiance || 'moyenne';
            const couleurConfiance = confiance === 'haute' ? '#4caf50' : confiance === 'moyenne' ? '#ff9800' : '#f44336';

            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 25px; max-width: 500px; width: 100%;">
                    <h3 style="color: #4caf50; margin-bottom: 20px; text-align: center;">üì∏ Aliment identifi√©</h3>
                    
                    <div style="background: ${couleurConfiance}; color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                        <strong>Confiance: ${confiance}</strong>
                    </div>
                    
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="margin-bottom: 10px;"><strong>üì¶ Nom:</strong> <span id="modalImageNom">${produit.nom}</span></div>
                        <div style="margin-bottom: 10px;"><strong>üî• Calories:</strong> <span id="modalImageCalories">${produit.calories}</span> kcal/100g</div>
                        <div style="margin-bottom: 10px;"><strong>üí™ Prot√©ines:</strong> <span id="modalImageProteines">${produit.proteines}</span>g/100g</div>
                        <div style="margin-bottom: 10px;"><strong>üçû Glucides:</strong> <span id="modalImageGlucides">${produit.glucides}</span>g/100g</div>
                        <div style="margin-bottom: 10px;"><strong>üßà Lipides:</strong> <span id="modalImageLipides">${produit.lipides}</span>g/100g</div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">‚öñÔ∏è Quantit√© (grammes):</label>
                        <input type="number" id="modalImageQuantite" value="100" min="1" style="width: 100%; padding: 10px; border: 2px solid #667eea; border-radius: 8px; font-size: 1em;">
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button onclick="confirmerImageCalculateur(${JSON.stringify(produit).replace(/"/g, '&quot;')})" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                            ‚úÖ Ajouter au repas
                        </button>
                        <button onclick="corrigerImageCalculateur()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                            ‚úèÔ∏è Corriger
                        </button>
                    </div>

                    <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; padding: 10px; background: #ddd; color: #333; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        ‚ùå Annuler
                    </button>
                </div>
            `;

            document.body.appendChild(modal);
            afficherNotification('‚úÖ Aliment identifi√© ! V√©rifiez les informations.', 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)');
        }

        function confirmerImageCalculateur(produit) {
            const quantite = parseInt(document.getElementById('modalImageQuantite').value) || 100;
            
            const nom = document.getElementById('modalImageNom').textContent;
            const calories = parseFloat(document.getElementById('modalImageCalories').textContent);
            const proteines = parseFloat(document.getElementById('modalImageProteines').textContent);
            const glucides = parseFloat(document.getElementById('modalImageGlucides').textContent);
            const lipides = parseFloat(document.getElementById('modalImageLipides').textContent);

            const aliment = {
                nom: nom,
                quantite: quantite,
                calories: (calories * quantite) / 100,
                proteines: (proteines * quantite) / 100,
                glucides: (glucides * quantite) / 100,
                lipides: (lipides * quantite) / 100
            };

            repasActuel.push(aliment);
            afficherRepasActuel();
            
            document.querySelectorAll('body > div').forEach(el => {
                if (el.style.position === 'fixed' && el.style.zIndex === '10000') {
                    el.remove();
                }
            });

            afficherNotification('‚úÖ Aliment ajout√© au repas !', 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)');
        }

        function corrigerImageCalculateur() {
            document.getElementById('modalImageNom').contentEditable = true;
            document.getElementById('modalImageNom').style.background = '#fff3cd';
            document.getElementById('modalImageNom').style.padding = '5px';
            document.getElementById('modalImageNom').style.border = '1px solid #ffc107';
            
            document.getElementById('modalImageCalories').contentEditable = true;
            document.getElementById('modalImageCalories').style.background = '#fff3cd';
            document.getElementById('modalImageCalories').style.padding = '5px';
            document.getElementById('modalImageCalories').style.border = '1px solid #ffc107';
            
            document.getElementById('modalImageProteines').contentEditable = true;
            document.getElementById('modalImageProteines').style.background = '#fff3cd';
            document.getElementById('modalImageProteines').style.padding = '5px';
            document.getElementById('modalImageProteines').style.border = '1px solid #ffc107';
            
            document.getElementById('modalImageGlucides').contentEditable = true;
            document.getElementById('modalImageGlucides').style.background = '#fff3cd';
            document.getElementById('modalImageGlucides').style.padding = '5px';
            document.getElementById('modalImageGlucides').style.border = '1px solid #ffc107';
            
            document.getElementById('modalImageLipides').contentEditable = true;
            document.getElementById('modalImageLipides').style.background = '#fff3cd';
            document.getElementById('modalImageLipides').style.padding = '5px';
            document.getElementById('modalImageLipides').style.border = '1px solid #ffc107';

            afficherNotification('‚úèÔ∏è Mode correction activ√© !', 'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)');
        }

        // ==============================================
        // FONCTIONS BASE COLLABORATIVE
        // ==============================================

        async function synchroniserBaseCommunautaire() {
            if (!firebaseInitialized) {
                console.log('‚ÑπÔ∏è Firebase non initialis√© - Chargement du cache local');
                const cached = localStorage.getItem('baseCommunautaire');
                if (cached) {
                    baseCommunautaire = JSON.parse(cached);
                    console.log('üì¶ Cache local:', baseCommunautaire.length, 'produits');
                }
                return;
            }

            try {
                console.log('üîÑ Synchronisation base communautaire...');

                const snapshot = await db.collection('produitsPartages').get();
                
                baseCommunautaire = [];
                snapshot.forEach(doc => {
                    baseCommunautaire.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                statsGlobales.totalProduits = baseCommunautaire.length;
                statsGlobales.derniereSync = new Date().toISOString();

                localStorage.setItem('baseCommunautaire', JSON.stringify(baseCommunautaire));
                localStorage.setItem('statsGlobales', JSON.stringify(statsGlobales));

                afficherNotification(`‚úÖ ${baseCommunautaire.length} produits synchronis√©s !`, 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)');
                afficherSyncIndicator('üåç Base communautaire √† jour !');

                console.log('‚úÖ Synchronisation r√©ussie -', baseCommunautaire.length, 'produits');

            } catch (error) {
                console.error('‚ùå Erreur synchronisation:', error);
                
                const cached = localStorage.getItem('baseCommunautaire');
                if (cached) {
                    baseCommunautaire = JSON.parse(cached);
                    afficherNotification('üì¶ Base locale charg√©e', 'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)');
                }
            }
        }

        async function partagerProduitCommunaute(produit) {
            if (!firebaseInitialized) {
                afficherNotification('‚ö†Ô∏è Base collaborative non disponible. V√©rifiez votre connexion internet.', 'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)');
                return;
            }

            if (!currentUser) {
                afficherNotification('üîê Connectez-vous pour partager des produits', 'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)');
                document.getElementById('authModal').classList.add('active');
                return;
            }

            const existe = baseCommunautaire.find(p => p.barcode === produit.barcode);
            if (existe) {
                afficherNotification('‚ÑπÔ∏è Ce produit est d√©j√† dans la base communautaire', 'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)');
                return;
            }

            if (!confirm(`Partager "${produit.nom}" avec la communaut√© ?\n\nCe produit sera visible par tous les utilisateurs de Mon Coach Minceur.`)) {
                return;
            }

            try {
                afficherNotification('üì§ Envoi en cours...', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');

                // Ajouter le produit √† la collection
                await db.collection('produitsPartages').add({
                    barcode: produit.barcode,
                    nom: produit.nom,
                    marque: produit.marque || '',
                    calories: produit.calories,
                    proteines: produit.proteines,
                    glucides: produit.glucides,
                    lipides: produit.lipides,
                    dateAjout: firebase.firestore.FieldValue.serverTimestamp(),
                    contributeur: currentUser.displayName || currentUser.email,
                    contributeurUid: currentUser.uid
                });

                // Mettre √† jour ou cr√©er le document utilisateur avec le compteur
                const userRef = db.collection('users').doc(currentUser.uid);
                const userDoc = await userRef.get();
                
                if (userDoc.exists) {
                    // Document existe, on incr√©mente
                    await userRef.update({
                        produitsPartages: firebase.firestore.FieldValue.increment(1)
                    });
                } else {
                    // Document n'existe pas, on le cr√©e
                    await userRef.set({
                        nom: currentUser.displayName || 'Utilisateur',
                        email: currentUser.email,
                        dateInscription: firebase.firestore.FieldValue.serverTimestamp(),
                        produitsPartages: 1
                    });
                }

                await synchroniserBaseCommunautaire();

                afficherNotification('üéâ Produit partag√© ! Merci de votre contribution !', 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)');

                // Notifier dans Telegram
                notifierTelegramNouveauProduit(produit);

            } catch (error) {
                console.error('‚ùå Erreur partage:', error);
                afficherNotification('‚ùå Erreur lors du partage: ' + error.message, 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)');
            }
        }

        async function notifierTelegramNouveauProduit(produit) {
            const BOT_TOKEN = '7937415810:AAGx_VCXf-uFbNDwxNmPAWU6DuZ3cCvSYsQ';
            const CHAT_ID = '-1002368960734';

            try {
                const contributeur = currentUser ? (currentUser.displayName || currentUser.email) : 'Anonyme';
                
                const message = `
üÜï Nouveau produit dans la base !

üì¶ <b>${produit.nom}</b>
üè∑Ô∏è ${produit.marque || 'Sans marque'}
üìä Code: <code>${produit.barcode}</code>

üî• ${Math.round(produit.calories)} kcal
üí™ ${produit.proteines}g prot√©ines
üçû ${produit.glucides}g glucides
üßà ${produit.lipides}g lipides

üë§ Ajout√© par: ${contributeur}
üìÖ ${new Date().toLocaleDateString('fr-FR')}
                `.trim();

                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: CHAT_ID,
                        text: message,
                        parse_mode: 'HTML'
                    })
                });

                console.log('‚úÖ Notification Telegram envoy√©e');
            } catch (error) {
                console.log('‚ö†Ô∏è Notification Telegram non envoy√©e');
            }
        }

        function rechercherDansBaseCommunautaire(codebarre) {
            return baseCommunautaire.find(p => p.barcode === codebarre);
        }

        // ==============================================
        // FONCTION G√âN√âRALE
        // ==============================================
        
        function showTab(tabName) {
            // Arr√™ter le scanner si actif et on change d'onglet
            if (scannerActif && tabName !== 'scanner') {
                arreterScanner();
            }
            // Arr√™ter le scanner frigo si actif et on change d'onglet
            if (scannerFrigoActif && tabName !== 'frigo') {
                arreterScannerFrigo();
            }

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.getAttribute('onclick').includes(tabName)) {
                    tab.classList.add('active');
                }
            });

            if (tabName === 'profil') {
                // Rafra√Æchir les graphiques si profil existe
                if (userData.poids && userData.objectif) {
                    setTimeout(() => {
                        afficherGraphiquesProgression();
                    }, 100);
                }
            } else if (tabName === 'suivi') {
                dessinerGraphique();
            } else if (tabName === 'coachai') {
                actualiserCoachIA();
            } else if (tabName === 'calculateur') {
                calculerCaloriesJour();
            } else if (tabName === 'planning') {
                afficherPlanning();
            } else if (tabName === 'historique') {
                afficherHistoriqueHebdo();
            } else if (tabName === 'scanner') {
                afficherListeProduits();
            } else if (tabName === 'frigo') {
                afficherFrigo();
                afficherProduitsDisponiblesFrigo();
            }

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function afficherCitationAleatoire() {
            const citation = citations[Math.floor(Math.random() * citations.length)];
            const citationElem = document.getElementById('citationJour');
            const auteurElem = document.getElementById('auteurCitation');
            
            if (citationElem) citationElem.textContent = `"${citation.texte}"`;
            if (auteurElem) auteurElem.textContent = `- ${citation.auteur}`;
        }

        // ==============================================
        // INITIALISATION
        // ==============================================
        
        // S'assurer que tous les scripts (y compris Firebase) sont charg√©s
        window.addEventListener('load', function() {
            console.log('üì¶ Tous les scripts charg√©s, initialisation Firebase...');
            initialiserFirebase();
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            
            chargerProfil();
            afficherCitationAleatoire();
            afficherPesees();
            afficherHistoriqueRepas();
            afficherProduitsPerso();
            afficherListeProduits();
            chargerCleAPI(); // Charger la cl√© API Groq si elle existe
            afficherPlanning();
            actualiserCoachIA();
            document.getElementById('datePesee').valueAsDate = new Date();
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#searchAliment') && !e.target.closest('#suggestionsAliments')) {
                    document.getElementById('suggestionsAliments').style.display = 'none';
                }
            });

            console.log('‚úÖ Application charg√©e avec synchronisation globale');
            console.log('üìä Base totale:', obtenirBaseTotale().length, 'aliments disponibles');
            console.log('üçΩÔ∏è Recettes sauvegard√©es:', repasSauvegardes.length);
            console.log('üì∑ Produits scann√©s:', produitsSauvegardes.length);
            console.log('üóÑÔ∏è Base locale:', baseProduitsCourants.length, 'produits fran√ßais');
            console.log('üìù Base perso:', produitsPerso.length, 'produits personnalis√©s');
            console.log('üßä Frigo:', produitsFrigo.length, 'produits');
            console.log('üç≥ Recettes disponibles:', baseRecettes.length, 'recettes');
            
            // Charger la base communautaire depuis le cache
            const cached = localStorage.getItem('baseCommunautaire');
            if (cached) {
                baseCommunautaire = JSON.parse(cached);
                console.log('üì¶ Base communautaire charg√©e:', baseCommunautaire.length, 'produits');
            }

            const cachedStats = localStorage.getItem('statsGlobales');
            if (cachedStats) {
                statsGlobales = JSON.parse(cachedStats);
            }
            
            // Initialiser le frigo
            afficherFrigo();
            afficherProduitsDisponiblesFrigo();
            
            // Message de bienvenue si pas de recettes
            if (repasSauvegardes.length === 0 && localStorage.getItem('premiereLancement') !== 'false') {
                setTimeout(() => {
                    afficherNotification('üëã Cr√©ez vos premi√®res recettes dans le Calculateur pour les utiliser dans votre planning !', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');
                    localStorage.setItem('premiereLancement', 'false');
                }, 1500);
            }
        });

        window.addEventListener('resize', () => {
            if (document.getElementById('suivi').classList.contains('active')) {
                dessinerGraphique();
            } else if (document.getElementById('profil').classList.contains('active')) {
                if (userData.poids && userData.objectif) {
                    afficherGraphiquesProgression();
                }
            }
        });

        // Arr√™ter le scanner si la page devient invisible
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (scannerActif) {
                    arreterScanner();
                }
                if (scannerFrigoActif) {
                    arreterScannerFrigo();
                }
            }
        });

        // Arr√™ter le scanner lors de la fermeture de la page
        window.addEventListener('beforeunload', () => {
            if (scannerActif) {
                arreterScanner();
            }
            if (scannerFrigoActif) {
                arreterScannerFrigo();
            }
        });
    </script>
</body>
</html>
