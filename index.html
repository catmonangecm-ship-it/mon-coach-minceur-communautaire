<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Coach Minceur Pro - V2.0</title>
    
    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- Quagga (Scanner) -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    
    <!-- Chart.js pour graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Confetti.js -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* ========================================
           VARIABLES CSS AM√âLIOR√âES
           ======================================== */
        
        :root {
            --primary-color: #667eea;
            --primary-dark: #5568d3;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f5576c;
            --info-color: #00bcd4;
            
            --text-dark: #1f2937;
            --text-medium: #6b7280;
            --text-light: #9ca3af;
            
            --bg-light: #f9fafb;
            --bg-white: #ffffff;
            --bg-dark: #1a1a2e;
            
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            
            --transition-fast: 0.15s;
            --transition-normal: 0.3s;
            --transition-slow: 0.5s;
        }

        /* Mode Sombre */
        .dark-mode {
            --bg-light: #1a1a2e;
            --bg-white: #16213e;
            --bg-dark: #0f0f1e;
            --text-dark: #ffffff;
            --text-medium: #e0e0e0;
            --text-light: #b0b0b0;
            --border-color: #333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-light);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.6;
            transition: background var(--transition-normal), color var(--transition-normal);
        }

        /* ========================================
           HEADER AVEC PROFIL UTILISATEUR
           ======================================== */
        
        .app-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            padding: 15px 20px;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid white;
            background: linear-gradient(135deg, var(--accent-color), var(--warning-color));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: transform var(--transition-fast);
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        .user-stats {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 700;
            font-size: 1.1em;
        }

        .user-level {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            opacity: 0.95;
        }

        .xp-bar {
            width: 120px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            border-radius: 10px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .icon-btn.active {
            background: var(--accent-color);
            box-shadow: 0 0 15px var(--accent-color);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        /* ========================================
           SYST√àME DE GAMIFICATION
           ======================================== */
        
        .gamification-panel {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-color) 100%);
            border-radius: var(--radius-xl);
            padding: 25px;
            margin: 20px;
            color: white;
            box-shadow: var(--shadow-xl);
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .achievement-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            padding: 15px;
            text-align: center;
            transition: all var(--transition-normal);
            cursor: pointer;
            border: 2px solid transparent;
        }

        .achievement-card:hover {
            transform: translateY(-5px);
            border-color: white;
            background: rgba(255, 255, 255, 0.25);
        }

        .achievement-card.locked {
            opacity: 0.5;
            filter: grayscale(100%);
        }

        .achievement-icon {
            font-size: 3em;
            margin-bottom: 10px;
            display: block;
        }

        .achievement-name {
            font-size: 0.9em;
            font-weight: 600;
        }

        .achievement-progress {
            font-size: 0.75em;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* D√©fis Quotidiens */
        .daily-challenges {
            background: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            margin: 20px;
            box-shadow: var(--shadow-md);
        }

        .challenge-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            margin-bottom: 12px;
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .challenge-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-sm);
        }

        .challenge-icon {
            font-size: 2em;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: var(--radius-md);
            color: white;
        }

        .challenge-info {
            flex: 1;
        }

        .challenge-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .challenge-progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 8px;
        }

        .challenge-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), var(--info-color));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .challenge-reward {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 700;
            color: #333;
            white-space: nowrap;
        }

        /* Streak (Jours Cons√©cutifs) */
        .streak-container {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin: 20px;
            color: white;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .streak-number {
            font-size: 4em;
            font-weight: 900;
            line-height: 1;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
        }

        .streak-fire {
            font-size: 3em;
            display: inline-block;
            animation: fire-flicker 1s infinite;
        }

        @keyframes fire-flicker {
            0%, 100% { transform: scale(1) rotate(-5deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }

        /* ========================================
           LEADERBOARD (Classement)
           ======================================== */
        
        .leaderboard {
            background: white;
            border-radius: var(--radius-xl);
            padding: 25px;
            margin: 20px;
            box-shadow: var(--shadow-lg);
        }

        .leaderboard-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .leaderboard-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: all var(--transition-fast);
        }

        .leaderboard-tab.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 15px;
            margin: 30px 0;
            height: 200px;
        }

        .podium-place {
            flex: 1;
            max-width: 150px;
            text-align: center;
            transition: transform var(--transition-normal);
        }

        .podium-place:hover {
            transform: translateY(-10px);
        }

        .podium-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 10px;
            border: 4px solid;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: white;
            font-weight: bold;
        }

        .podium-1 {
            height: 180px;
        }

        .podium-1 .podium-avatar {
            width: 100px;
            height: 100px;
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .podium-2 {
            height: 140px;
        }

        .podium-2 .podium-avatar {
            border-color: #c0c0c0;
        }

        .podium-3 {
            height: 100px;
        }

        .podium-3 .podium-avatar {
            border-color: #cd7f32;
        }

        .podium-rank {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .rank-list {
            margin-top: 25px;
        }

        .rank-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            transition: all var(--transition-fast);
        }

        .rank-item:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(246, 211, 101, 0.1));
            transform: translateX(5px);
        }

        .rank-item.me {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: 600;
        }

        .rank-position {
            font-size: 1.2em;
            font-weight: 700;
            width: 40px;
            text-align: center;
        }

        .rank-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-color), var(--warning-color));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
            font-weight: bold;
        }

        .rank-info {
            flex: 1;
        }

        .rank-name {
            font-weight: 600;
            font-size: 1.05em;
        }

        .rank-level {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .rank-xp {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1em;
        }

        .rank-item.me .rank-xp {
            color: #ffd700;
        }

        /* ========================================
           FEED SOCIAL
           ======================================== */
        
        .social-feed {
            margin: 20px;
        }

        .feed-post {
            background: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-fast);
        }

        .feed-post:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .post-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            color: white;
            font-weight: bold;
        }

        .post-author {
            flex: 1;
        }

        .post-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .verified-badge {
            color: var(--info-color);
            font-size: 0.9em;
        }

        .post-time {
            font-size: 0.85em;
            color: var(--text-medium);
        }

        .post-content {
            margin: 15px 0;
            line-height: 1.6;
        }

        .post-image {
            width: 100%;
            border-radius: var(--radius-md);
            margin: 15px 0;
            max-height: 400px;
            object-fit: cover;
        }

        .post-stats {
            display: flex;
            gap: 20px;
            padding: 12px 0;
            border-top: 1px solid var(--border-color);
            margin-top: 15px;
            font-size: 0.9em;
            color: var(--text-medium);
        }

        .post-actions {
            display: flex;
            gap: 10px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .post-action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .post-action-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .post-action-btn.active {
            background: var(--primary-color);
            color: white;
        }

        /* ========================================
           STORIES
           ======================================== */
        
        .stories-container {
            display: flex;
            gap: 15px;
            padding: 20px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .stories-container::-webkit-scrollbar {
            display: none;
        }

        .story-item {
            flex-shrink: 0;
            text-align: center;
            cursor: pointer;
        }

        .story-ring {
            width: 75px;
            height: 75px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--accent-color), var(--warning-color));
            padding: 3px;
            margin-bottom: 8px;
            transition: transform var(--transition-fast);
        }

        .story-item:hover .story-ring {
            transform: scale(1.1);
        }

        .story-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid white;
            background: var(--bg-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            overflow: hidden;
        }

        .story-label {
            font-size: 0.85em;
            color: var(--text-dark);
            font-weight: 500;
        }

        /* Story Viewer */
        .story-viewer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: black;
            z-index: 9999;
            display: none;
        }

        .story-viewer.active {
            display: flex;
            flex-direction: column;
        }

        .story-progress {
            display: flex;
            gap: 5px;
            padding: 10px;
        }

        .story-progress-bar {
            flex: 1;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }

        .story-progress-fill {
            height: 100%;
            background: white;
            border-radius: 10px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .story-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .story-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .story-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
        }

        /* ========================================
           ROUE DE LA FORTUNE
           ======================================== */
        
        .wheel-container {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: var(--radius-xl);
            padding: 30px;
            margin: 20px;
            text-align: center;
            color: white;
            box-shadow: var(--shadow-xl);
        }

        .wheel-canvas {
            margin: 30px auto;
            max-width: 350px;
        }

        .spin-button {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            border: none;
            padding: 20px 50px;
            border-radius: 50px;
            font-size: 1.5em;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
            transition: all var(--transition-normal);
            margin-top: 20px;
        }

        .spin-button:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 30px rgba(255, 215, 0, 0.6);
        }

        .spin-button:active {
            transform: scale(0.95);
        }

        .spin-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .wheel-prizes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 30px;
        }

        .wheel-prize {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: var(--radius-md);
            font-size: 0.9em;
        }

        /* ========================================
           MOOD TRACKER
           ======================================== */
        
        .mood-tracker {
            background: white;
            border-radius: var(--radius-lg);
            padding: 25px;
            margin: 20px;
            box-shadow: var(--shadow-md);
        }

        .mood-options {
            display: flex;
            justify-content: space-around;
            margin: 25px 0;
        }

        .mood-btn {
            font-size: 3em;
            background: none;
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            filter: grayscale(100%);
            opacity: 0.5;
        }

        .mood-btn:hover,
        .mood-btn.selected {
            filter: grayscale(0%);
            opacity: 1;
            transform: scale(1.2);
        }

        .mood-chart {
            margin-top: 30px;
            max-height: 200px;
        }

        /* ========================================
           ANIMATIONS
           ======================================== */
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes shake {
            0%, 100% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-10px);
            }
            75% {
                transform: translateX(10px);
            }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 5px var(--primary-color);
            }
            50% {
                box-shadow: 0 0 20px var(--primary-color), 0 0 30px var(--accent-color);
            }
        }

        .animate-slideInUp {
            animation: slideInUp 0.5s ease-out;
        }

        .animate-slideInRight {
            animation: slideInRight 0.5s ease-out;
        }

        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }

        .animate-bounce {
            animation: bounce 1s infinite;
        }

        .animate-shake {
            animation: shake 0.5s;
        }

        .animate-glow {
            animation: glow 2s infinite;
        }

        /* ========================================
           LEVEL UP MODAL
           ======================================== */
        
        .level-up-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .level-up-overlay.active {
            display: flex;
            animation: fadeIn 0.5s;
        }

        .level-up-content {
            text-align: center;
            color: white;
            animation: slideInUp 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .level-up-number {
            font-size: 8em;
            font-weight: 900;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            margin: 20px 0;
        }

        .level-up-badge {
            font-size: 6em;
            margin: 30px 0;
            animation: bounce 1s infinite;
        }

        .level-up-message {
            font-size: 1.5em;
            margin: 20px 0;
        }

        /* Confettis */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f00;
            animation: confetti-fall 3s linear;
            pointer-events: none;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* ========================================
           RESPONSIVE
           ======================================== */
        
        @media (max-width: 768px) {
            .app-header {
                padding: 10px 15px;
            }

            .user-avatar {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            .xp-bar {
                width: 80px;
            }

            .icon-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            .gamification-panel,
            .daily-challenges,
            .leaderboard,
            .social-feed,
            .wheel-container {
                margin: 15px;
                padding: 20px;
            }

            .achievement-grid {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            }

            .podium {
                height: 150px;
            }

            .podium-1 {
                height: 130px;
            }

            .podium-1 .podium-avatar {
                width: 70px;
                height: 70px;
            }

            .podium-2 {
                height: 100px;
            }

            .podium-3 {
                height: 70px;
            }

            .podium-avatar {
                width: 60px;
                height: 60px;
                font-size: 1.5em;
            }

            .level-up-number {
                font-size: 5em;
            }

            .level-up-badge {
                font-size: 4em;
            }
        }

        /* ========================================
           STYLES EXISTANTS (√Ä CONSERVER)
           ======================================== */
        
        /* Gardez tous vos styles existants ici */
        /* ... (le reste de votre CSS actuel) ... */
        
    </style>
</head>
<body>

    <!-- Header Am√©lior√© -->
    <div class="app-header">
        <div class="user-profile">
            <div class="user-avatar" id="userAvatarBtn" onclick="toggleProfileMenu()">
                <span id="userAvatarInitial">?</span>
            </div>
            <div class="user-stats">
                <div class="user-name" id="userName">Utilisateur</div>
                <div class="user-level">
                    <span>Niveau <strong id="userLevelDisplay">1</strong></span>
                    <div class="xp-bar">
                        <div class="xp-fill" id="xpBarFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="header-actions">
            <button class="icon-btn" id="darkModeToggle" onclick="toggleDarkMode()" title="Mode sombre">
                üåô
            </button>
            <button class="icon-btn" onclick="showTab('notifications')" title="Notifications">
                üîî
                <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
            </button>
            <button class="icon-btn" onclick="showTab('classement')" title="Classement">
                üèÜ
            </button>
        </div>
    </div>

    <div class="container">
        
        <!-- Barre de Streak -->
        <div class="streak-container" id="streakContainer">
            <div class="streak-fire">üî•</div>
            <div class="streak-number" id="streakNumber">0</div>
            <div style="font-size: 1.2em; margin-top: 10px;">Jours Cons√©cutifs</div>
            <div style="font-size: 0.9em; opacity: 0.9; margin-top: 5px;">
                Continue comme √ßa ! üí™
            </div>
        </div>

        <!-- Stories -->
        <div class="stories-container" id="storiesContainer">
            <div class="story-item" onclick="viewStory('nutrition')">
                <div class="story-ring">
                    <div class="story-avatar">ü•ó</div>
                </div>
                <div class="story-label">Conseils</div>
            </div>
            
            <div class="story-item" onclick="viewStory('recettes')">
                <div class="story-ring">
                    <div class="story-avatar">üë®‚Äçüç≥</div>
                </div>
                <div class="story-label">Recettes</div>
            </div>
            
            <div class="story-item" onclick="viewStory('motivation')">
                <div class="story-ring">
                    <div class="story-avatar">üí™</div>
                </div>
                <div class="story-label">Motivation</div>
            </div>
            
            <div class="story-item" onclick="viewStory('defis')">
                <div class="story-ring">
                    <div class="story-avatar">üéØ</div>
                </div>
                <div class="story-label">D√©fis</div>
            </div>
        </div>

        <!-- Tabs Navigation (vos onglets existants) -->
        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="showTab('dashboard')">üè† Accueil</button>
                <button class="tab" onclick="showTab('profil')">üìä Profil</button>
                <button class="tab" onclick="showTab('defis')">üéØ D√©fis</button>
                <button class="tab" onclick="showTab('classement')">üèÜ Classement</button>
                <button class="tab" onclick="showTab('social')">üë• Social</button>
                <button class="tab" onclick="showTab('roue')">üé∞ Roue</button>
                <!-- Gardez vos autres onglets existants -->
            </div>

            <!-- Tab: Dashboard -->
            <div id="dashboard" class="tab-content active">
                <h2>üè† Tableau de Bord</h2>
                
                <!-- Panel de Gamification -->
                <div class="gamification-panel">
                    <h3 style="margin-bottom: 20px;">üéÆ Tes Achievements</h3>
                    <div class="achievement-grid" id="achievementGrid">
                        <!-- Badges g√©n√©r√©s dynamiquement -->
                    </div>
                </div>

                <!-- D√©fis Quotidiens -->
                <div class="daily-challenges">
                    <h3 style="margin-bottom: 20px;">üéØ D√©fis du Jour</h3>
                    <div id="dailyChallengesContainer">
                        <!-- D√©fis g√©n√©r√©s dynamiquement -->
                    </div>
                </div>

                <!-- Mood Tracker -->
                <div class="mood-tracker">
                    <h3 style="text-align: center; margin-bottom: 20px;">
                        Comment te sens-tu aujourd'hui ?
                    </h3>
                    <div class="mood-options">
                        <button class="mood-btn" onclick="selectMood('excellent')" data-mood="excellent">üòÑ</button>
                        <button class="mood-btn" onclick="selectMood('bien')" data-mood="bien">üôÇ</button>
                        <button class="mood-btn" onclick="selectMood('moyen')" data-mood="moyen">üòê</button>
                        <button class="mood-btn" onclick="selectMood('fatigue')" data-mood="fatigue">üòì</button>
                        <button class="mood-btn" onclick="selectMood('difficile')" data-mood="difficile">üò¢</button>
                    </div>
                    <canvas id="moodChart" class="mood-chart"></canvas>
                </div>
            </div>

            <!-- Tab: Classement -->
            <div id="classement" class="tab-content">
                <div class="leaderboard">
                    <h2 style="text-align: center; margin-bottom: 25px;">
                        üèÜ Classement de la Semaine
                    </h2>
                    
                    <div class="leaderboard-tabs">
                        <button class="leaderboard-tab active" onclick="switchLeaderboard('amis')">
                            üë• Amis
                        </button>
                        <button class="leaderboard-tab" onclick="switchLeaderboard('global')">
                            üåç Global
                        </button>
                    </div>

                    <!-- Podium -->
                    <div class="podium" id="podiumContainer">
                        <!-- G√©n√©r√© dynamiquement -->
                    </div>

                    <!-- Liste des Rangs -->
                    <div class="rank-list" id="rankList">
                        <!-- G√©n√©r√© dynamiquement -->
                    </div>

                    <button class="btn" onclick="inviteMonFriends()" style="width: 100%; margin-top: 20px;">
                        ‚ûï Inviter des Amis
                    </button>
                </div>
            </div>

            <!-- Tab: Social Feed -->
            <div id="social" class="tab-content">
                <h2 style="padding: 0 20px;">üì∞ Fil d'Actualit√©</h2>
                
                <div class="social-feed" id="socialFeed">
                    <!-- Posts g√©n√©r√©s dynamiquement -->
                </div>

                <button class="btn" onclick="createPost()" style="position: fixed; bottom: 80px; right: 20px; border-radius: 50%; width: 60px; height: 60px; font-size: 2em; box-shadow: var(--shadow-xl); z-index: 100;">
                    ‚ûï
                </button>
            </div>

            <!-- Tab: Roue de la Fortune -->
            <div id="roue" class="tab-content">
                <div class="wheel-container">
                    <h2 style="margin-bottom: 10px;">üé∞ Roue Quotidienne</h2>
                    <p style="opacity: 0.9; margin-bottom: 30px;">
                        Tourne la roue une fois par jour !
                    </p>
                    
                    <canvas id="wheelCanvas" class="wheel-canvas" width="350" height="350"></canvas>
                    
                    <button class="spin-button" id="spinButton" onclick="spinWheel()">
                        TOURNER
                    </button>
                    
                    <div class="wheel-prizes">
                        <div class="wheel-prize">‚≠ê +50 XP</div>
                        <div class="wheel-prize">üèÖ Badge Rare</div>
                        <div class="wheel-prize">üìñ Recette Premium</div>
                        <div class="wheel-prize">üí° Conseil Perso</div>
                        <div class="wheel-prize">üéÅ Surprise</div>
                        <div class="wheel-prize">üî• +1 Jour Streak</div>
                    </div>
                    
                    <p id="wheelTimer" style="margin-top: 20px; font-size: 0.9em; opacity: 0.8;"></p>
                </div>
            </div>

            <!-- Gardez tous vos autres onglets existants ici -->
            <!-- profil, suivi, calculateur, planning, etc. -->
            
        </div>
    </div>

    <!-- Story Viewer -->
    <div class="story-viewer" id="storyViewer">
        <div class="story-progress" id="storyProgressContainer">
            <!-- Barres de progression g√©n√©r√©es dynamiquement -->
        </div>
        <div class="story-content" id="storyContent">
            <button class="story-close" onclick="closeStory()">√ó</button>
        </div>
    </div>

    <!-- Level Up Modal -->
    <div class="level-up-overlay" id="levelUpOverlay">
        <div class="level-up-content">
            <div style="font-size: 2em; margin-bottom: 20px;">üéâ LEVEL UP! üéâ</div>
            <div class="level-up-number" id="levelUpNumber">2</div>
            <div class="level-up-badge" id="levelUpBadge">üèÜ</div>
            <div class="level-up-message" id="levelUpMessage">
                Nouveau badge d√©bloqu√© !
            </div>
            <button class="btn" onclick="closeLevelUp()" style="margin-top: 30px; padding: 15px 40px; font-size: 1.2em;">
                Continuer
            </button>
        </div>
    </div>

    <!-- VOTRE CODE JAVASCRIPT EXISTANT + NOUVEAU CODE -->
    <script>
        // ========================================
        // CONFIGURATION FIREBASE (Gardez votre config)
        // ========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyAVsE39uVXpYQy_aehNS8f_bo94U-NWI28",
            authDomain: "moncoachminceurcatjer.firebaseapp.com",
            projectId: "moncoachminceurcatjer",
            storageBucket: "moncoachminceurcatjer.firebasestorage.app",
            messagingSenderId: "441403074242",
            appId: "1:441403074242:web:b38009005e7fa4e012bd5b",
            measurementId: "G-M2JY1PDKQW"
        };

        let db = null;
        let auth = null;
        let firebaseInitialized = false;
        let currentUser = null;

        // ========================================
        // SYST√àME DE GAMIFICATION
        // ========================================
        
        let userProgress = JSON.parse(localStorage.getItem('userProgress')) || {
            niveau: 1,
            xp: 0,
            xpRequis: 100,
            streak: 0,
            derniereConnexion: null,
            badges: [],
            defis: [],
            totalXP: 0
        };

        // D√©finition des badges
        const BADGES = {
            'first_login': { 
                nom: 'üéâ Bienvenue', 
                description: 'Premi√®re connexion',
                xp: 10,
                icone: 'üéâ'
            },
            'first_scan': { 
                nom: 'üì∑ Premier Scan', 
                description: 'Scanner ton premier produit',
                xp: 10,
                icone: 'üì∑'
            },
            'week_streak': { 
                nom: 'üî• Une Semaine', 
                description: '7 jours cons√©cutifs',
                xp: 50,
                icone: 'üî•'
            },
            'month_streak': { 
                nom: '‚≠ê Un Mois', 
                description: '30 jours cons√©cutifs',
                xp: 200,
                icone: '‚≠ê'
            },
            'objectif_atteint': { 
                nom: 'üéØ Objectif Atteint', 
                description: 'Atteindre ton objectif de poids',
                xp: 500,
                icone: 'üéØ'
            },
            'partageur': { 
                nom: 'üåç Partageur', 
                description: 'Partager 10 produits',
                xp: 75,
                icone: 'üåç'
            },
            'chef': { 
                nom: 'üë®‚Äçüç≥ Chef', 
                description: 'Cr√©er 20 recettes',
                xp: 60,
                icone: 'üë®‚Äçüç≥'
            },
            'social': { 
                nom: 'üë• Sociable', 
                description: 'Inviter 5 amis',
                xp: 100,
                icone: 'üë•'
            },
            'centurion': { 
                nom: 'üíØ Centurion', 
                description: 'Atteindre le niveau 100',
                xp: 1000,
                icone: 'üíØ'
            },
            'marathonien': { 
                nom: 'üèÉ Marathonien', 
                description: 'Enregistrer 100 repas',
                xp: 150,
                icone: 'üèÉ'
            }
        };

        // G√©n√©rer les d√©fis quotidiens
        function genererDefisQuotidiens() {
            const today = new Date().toDateString();
            
            // V√©rifier si on a d√©j√† les d√©fis du jour
            const savedDefis = JSON.parse(localStorage.getItem('defisQuotidiens'));
            if (savedDefis && savedDefis.date === today) {
                return savedDefis.defis;
            }
            
            // Cr√©er nouveaux d√©fis
            const defis = [
                {
                    id: 'scan_3',
                    titre: 'üì∑ Scanner 3 produits',
                    description: 'Scanne 3 produits diff√©rents aujourd\'hui',
                    progression: 0,
                    objectif: 3,
                    recompense: 30,
                    icone: 'üì¶',
                    type: 'scan'
                },
                {
                    id: 'calories_objectif',
                    titre: 'üéØ Respecter tes calories',
                    description: 'Reste dans ton objectif calorique',
                    progression: 0,
                    objectif: 1,
                    recompense: 50,
                    icone: 'üî•',
                    type: 'calories'
                },
                {
                    id: 'eau_2L',
                    titre: 'üíß Boire 2L d\'eau',
                    description: 'Bois 8 verres d\'eau (250ml chacun)',
                    progression: 0,
                    objectif: 8,
                    recompense: 25,
                    icone: 'ü•§',
                    type: 'eau'
                },
                {
                    id: 'pesee',
                    titre: '‚öñÔ∏è Te peser',
                    description: 'Enregistre ton poids aujourd\'hui',
                    progression: 0,
                    objectif: 1,
                    recompense: 20,
                    icone: '‚öñÔ∏è',
                    type: 'pesee'
                },
                {
                    id: 'partage',
                    titre: 'üåç Partager un produit',
                    description: 'Partage un produit avec la communaut√©',
                    progression: 0,
                    objectif: 1,
                    recompense: 40,
                    icone: 'üåç',
                    type: 'partage'
                }
            ];
            
            // Sauvegarder
            localStorage.setItem('defisQuotidiens', JSON.stringify({
                date: today,
                defis: defis
            }));
            
            return defis;
        }

        // Mettre √† jour la progression d'un d√©fi
        function updateDefiProgress(type, amount = 1) {
            const savedDefis = JSON.parse(localStorage.getItem('defisQuotidiens'));
            if (!savedDefis) return;
            
            let updated = false;
            savedDefis.defis.forEach(defi => {
                if (defi.type === type && defi.progression < defi.objectif) {
                    defi.progression += amount;
                    if (defi.progression >= defi.objectif) {
                        // D√©fi compl√©t√©!
                        gagnerXP('defi', defi.recompense);
                        afficherNotification(
                            `üéâ D√©fi compl√©t√© ! +${defi.recompense} XP`,
                            'linear-gradient(135deg, #4caf50 0%, #45a049 100%)'
                        );
                        playSound('achievement');
                    }
                    updated = true;
                }
            });
            
            if (updated) {
                localStorage.setItem('defisQuotidiens', JSON.stringify(savedDefis));
                afficherDefis();
            }
        }

        // Afficher les d√©fis
        function afficherDefis() {
            const defis = genererDefisQuotidiens();
            const container = document.getElementById('dailyChallengesContainer');
            
            container.innerHTML = defis.map(defi => {
                const percent = (defi.progression / defi.objectif) * 100;
                const completed = defi.progression >= defi.objectif;
                
                return `
                    <div class="challenge-item ${completed ? 'completed' : ''}">
                        <div class="challenge-icon">${defi.icone}</div>
                        <div class="challenge-info">
                            <div class="challenge-title">${defi.titre}</div>
                            <div style="font-size: 0.85em; color: var(--text-medium); margin: 5px 0;">
                                ${defi.description}
                            </div>
                            <div class="challenge-progress-bar">
                                <div class="challenge-progress-fill" style="width: ${percent}%"></div>
                            </div>
                            <div style="font-size: 0.85em; margin-top: 5px; color: var(--text-medium);">
                                ${defi.progression}/${defi.objectif} ${completed ? '‚úì' : ''}
                            </div>
                        </div>
                        <div class="challenge-reward">
                            ${completed ? '‚úì' : `+${defi.recompense} XP`}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Gagner de l'XP
        function gagnerXP(action, points) {
            userProgress.xp += points;
            userProgress.totalXP += points;
            
            const animations = {
                'pesee': '‚öñÔ∏è',
                'repas': 'üçΩÔ∏è',
                'scan': 'üì∑',
                'objectif': 'üéØ',
                'defi': 'üéØ',
                'partage': 'üåç'
            };
            
            // Animation XP
            createXPAnimation(points, animations[action] || '‚≠ê');
            
            // V√©rifier mont√©e de niveau
            while (userProgress.xp >= userProgress.xpRequis) {
                userProgress.xp -= userProgress.xpRequis;
                monterDeNiveau();
            }
            
            sauvegarderProgress();
            updateUI();
        }

        // Monter de niveau
        function monterDeNiveau() {
            userProgress.niveau++;
            userProgress.xpRequis = Math.floor(userProgress.niveau * 100 * 1.2);
            
            // Animation de level up
            showLevelUp();
            
            // Confettis!
            launchConfetti();
            
            // Son
            playSound('levelup');
            
            // Vibration
            vibrate([200, 100, 200]);
            
            sauvegarderProgress();
        }

        // Afficher modal de level up
        function showLevelUp() {
            const modal = document.getElementById('levelUpOverlay');
            const levelNumber = document.getElementById('levelUpNumber');
            const badge = document.getElementById('levelUpBadge');
            const message = document.getElementById('levelUpMessage');
            
            levelNumber.textContent = userProgress.niveau;
            
            // Badge selon le niveau
            if (userProgress.niveau % 50 === 0) {
                badge.textContent = 'üëë';
                message.textContent = 'Niveau L√©gendaire Atteint !';
            } else if (userProgress.niveau % 25 === 0) {
                badge.textContent = 'üíé';
                message.textContent = 'Niveau √âpique Atteint !';
            } else if (userProgress.niveau % 10 === 0) {
                badge.textContent = 'üèÜ';
                message.textContent = 'Niveau Rare Atteint !';
            } else {
                badge.textContent = '‚≠ê';
                message.textContent = 'Nouveau Niveau D√©bloqu√© !';
            }
            
            modal.classList.add('active');
        }

        function closeLevelUp() {
            document.getElementById('levelUpOverlay').classList.remove('active');
        }

        // Cr√©er animation XP
        function createXPAnimation(points, icon) {
            const xpAnim = document.createElement('div');
            xpAnim.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 3em;
                font-weight: bold;
                color: #ffd700;
                z-index: 9999;
                pointer-events: none;
                animation: xpFloat 1.5s ease-out forwards;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            `;
            xpAnim.textContent = `${icon} +${points} XP`;
            document.body.appendChild(xpAnim);
            
            // Ajouter l'animation CSS
            if (!document.getElementById('xp-animation-style')) {
                const style = document.createElement('style');
                style.id = 'xp-animation-style';
                style.textContent = `
                    @keyframes xpFloat {
                        0% {
                            opacity: 1;
                            transform: translate(-50%, -50%) scale(0.5);
                        }
                        50% {
                            transform: translate(-50%, -80%) scale(1.2);
                        }
                        100% {
                            opacity: 0;
                            transform: translate(-50%, -150%) scale(1);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            setTimeout(() => xpAnim.remove(), 1500);
        }

        // Lancer confettis
        function launchConfetti() {
            if (typeof confetti === 'undefined') return;
            
            const count = 200;
            const defaults = {
                origin: { y: 0.7 }
            };

            function fire(particleRatio, opts) {
                confetti(Object.assign({}, defaults, opts, {
                    particleCount: Math.floor(count * particleRatio)
                }));
            }

            fire(0.25, {
                spread: 26,
                startVelocity: 55,
            });

            fire(0.2, {
                spread: 60,
            });

            fire(0.35, {
                spread: 100,
                decay: 0.91,
                scalar: 0.8
            });

            fire(0.1, {
                spread: 120,
                startVelocity: 25,
                decay: 0.92,
                scalar: 1.2
            });

            fire(0.1, {
                spread: 120,
                startVelocity: 45,
            });
        }

        // Jouer un son
        function playSound(soundName) {
            // Sons via Web Audio API (simple beep)
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            if (soundName === 'levelup') {
                oscillator.frequency.value = 800;
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } else if (soundName === 'achievement') {
                oscillator.frequency.value = 600;
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
            }
        }

        // Vibration
        function vibrate(pattern = [50]) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        // Sauvegarder progression
        function sauvegarderProgress() {
            localStorage.setItem('userProgress', JSON.stringify(userProgress));
        }

        // Afficher les badges
        function afficherBadges() {
            const grid = document.getElementById('achievementGrid');
            
            grid.innerHTML = Object.entries(BADGES).map(([key, badge]) => {
                const unlocked = userProgress.badges.includes(key);
                
                return `
                    <div class="achievement-card ${unlocked ? '' : 'locked'}" 
                         onclick="showBadgeDetail('${key}')"
                         title="${badge.description}">
                        <span class="achievement-icon">${badge.icone}</span>
                        <div class="achievement-name">${badge.nom}</div>
                        ${unlocked ? '<div class="achievement-progress">‚úì D√©bloqu√©</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function showBadgeDetail(badgeKey) {
            const badge = BADGES[badgeKey];
            const unlocked = userProgress.badges.includes(badgeKey);
            
            afficherNotification(
                `${badge.icone} ${badge.nom}\n${badge.description}\n${unlocked ? '‚úì D√©bloqu√©' : 'üîí Verrouill√©'}`,
                unlocked ? 'linear-gradient(135deg, #4caf50, #45a049)' : 'linear-gradient(135deg, #999, #666)'
            );
        }

        // D√©bloquer un badge
        function debloquerBadge(badgeKey) {
            if (userProgress.badges.includes(badgeKey)) return;
            
            userProgress.badges.push(badgeKey);
            const badge = BADGES[badgeKey];
            
            gagnerXP('badge', badge.xp);
            afficherNotification(
                `üèÜ Badge D√©bloqu√© !\n${badge.icone} ${badge.nom}\n+${badge.xp} XP`,
                'linear-gradient(135deg, #ffd700, #ffed4e)'
            );
            
            playSound('achievement');
            vibrate([100, 50, 100]);
            
            sauvegarderProgress();
            afficherBadges();
        }

        // V√©rifier la streak
        function verifierStreak() {
            const today = new Date().toDateString();
            const derniereConnexion = userProgress.derniereConnexion;
            
            if (!derniereConnexion) {
                // Premi√®re connexion
                userProgress.streak = 1;
                userProgress.derniereConnexion = today;
                debloquerBadge('first_login');
            } else if (derniereConnexion !== today) {
                const lastDate = new Date(derniereConnexion);
                const currentDate = new Date(today);
                const diffTime = currentDate - lastDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 1) {
                    // Jour cons√©cutif
                    userProgress.streak++;
                    gagnerXP('streak', 10);
                    
                    // Badges de streak
                    if (userProgress.streak === 7) {
                        debloquerBadge('week_streak');
                    } else if (userProgress.streak === 30) {
                        debloquerBadge('month_streak');
                    }
                } else {
                    // Streak perdue
                    if (userProgress.streak > 3) {
                        afficherNotification(
                            `üò¢ Streak perdue ! Tu avais ${userProgress.streak} jours.`,
                            'linear-gradient(135deg, #f5576c, #f093fb)'
                        );
                    }
                    userProgress.streak = 1;
                }
                
                userProgress.derniereConnexion = today;
            }
            
            sauvegarderProgress();
            afficherStreak();
        }

        function afficherStreak() {
            document.getElementById('streakNumber').textContent = userProgress.streak;
        }

        // ========================================
        // CLASSEMENT (LEADERBOARD)
        // ========================================
        
        let leaderboardData = [];
        let currentLeaderboardType = 'amis';

        async function chargerClassement() {
            if (!firebaseInitialized || !currentUser) {
                // Mode local/d√©mo
                leaderboardData = genererClassementDemo();
            } else {
                try {
                    const snapshot = await db.collection('users')
                        .orderBy('totalXP', 'desc')
                        .limit(50)
                        .get();
                    
                    leaderboardData = [];
                    snapshot.forEach(doc => {
                        leaderboardData.push({
                            uid: doc.id,
                            ...doc.data()
                        });
                    });
                } catch (error) {
                    console.error('Erreur chargement classement:', error);
                    leaderboardData = genererClassementDemo();
                }
            }
            
            afficherClassement();
        }

        function genererClassementDemo() {
            const noms = ['Marie', 'Thomas', 'Sophie', 'Lucas', 'Emma', 'Antoine', 'Chlo√©', 'Alexandre', 'L√©a', 'Maxime'];
            const users = noms.map((nom, i) => ({
                uid: 'demo' + i,
                nom: nom,
                niveau: Math.floor(Math.random() * 50) + 1,
                totalXP: Math.floor(Math.random() * 5000) + 500,
                avatar: nom.charAt(0)
            }));
            
            // Ajouter l'utilisateur actuel
            if (currentUser) {
                users.push({
                    uid: currentUser.uid,
                    nom: currentUser.displayName || 'Moi',
                    niveau: userProgress.niveau,
                    totalXP: userProgress.totalXP,
                    avatar: (currentUser.displayName || 'M').charAt(0)
                });
            }
            
            return users.sort((a, b) => b.totalXP - a.totalXP);
        }

        function switchLeaderboard(type) {
            currentLeaderboardType = type;
            
            document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            afficherClassement();
        }

        function afficherClassement() {
            const podiumContainer = document.getElementById('podiumContainer');
            const rankList = document.getElementById('rankList');
            
            const top3 = leaderboardData.slice(0, 3);
            const reste = leaderboardData.slice(3);
            
            // Afficher le podium (2√®me, 1er, 3√®me)
            if (top3.length >= 3) {
                podiumContainer.innerHTML = `
                    <div class="podium-place podium-2">
                        <div class="podium-rank">ü•à</div>
                        <div class="podium-avatar">${top3[1].avatar}</div>
                        <div style="font-weight: 600;">${top3[1].nom}</div>
                        <div style="font-size: 0.9em; color: var(--text-medium);">
                            Niveau ${top3[1].niveau}
                        </div>
                        <div style="font-weight: 700; color: var(--primary-color); margin-top: 5px;">
                            ${top3[1].totalXP} XP
                        </div>
                    </div>
                    
                    <div class="podium-place podium-1">
                        <div class="podium-rank">üëë</div>
                        <div class="podium-avatar">${top3[0].avatar}</div>
                        <div style="font-weight: 600; font-size: 1.1em;">${top3[0].nom}</div>
                        <div style="font-size: 0.9em; color: var(--text-medium);">
                            Niveau ${top3[0].niveau}
                        </div>
                        <div style="font-weight: 700; color: #ffd700; margin-top: 5px;">
                            ${top3[0].totalXP} XP
                        </div>
                    </div>
                    
                    <div class="podium-place podium-3">
                        <div class="podium-rank">ü•â</div>
                        <div class="podium-avatar">${top3[2].avatar}</div>
                        <div style="font-weight: 600;">${top3[2].nom}</div>
                        <div style="font-size: 0.9em; color: var(--text-medium);">
                            Niveau ${top3[2].niveau}
                        </div>
                        <div style="font-weight: 700; color: var(--primary-color); margin-top: 5px;">
                            ${top3[2].totalXP} XP
                        </div>
                    </div>
                `;
            }
            
            // Afficher le reste
            rankList.innerHTML = reste.map((user, index) => {
                const position = index + 4;
                const isMe = currentUser && user.uid === currentUser.uid;
                
                return `
                    <div class="rank-item ${isMe ? 'me' : ''}">
                        <div class="rank-position">#${position}</div>
                        <div class="rank-avatar">${user.avatar}</div>
                        <div class="rank-info">
                            <div class="rank-name">${user.nom} ${isMe ? '(Toi)' : ''}</div>
                            <div class="rank-level">Niveau ${user.niveau}</div>
                        </div>
                        <div class="rank-xp">${user.totalXP} XP</div>
                    </div>
                `;
            }).join('');
        }

        function inviterAmis() {
            const shareText = `Rejoins-moi sur Mon Coach Minceur ! üí™\nNiveau ${userProgress.niveau} ‚Ä¢ ${userProgress.totalXP} XP`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Mon Coach Minceur',
                    text: shareText,
                    url: window.location.href
                }).catch(() => {});
            } else {
                // Fallback: copier dans le presse-papiers
                navigator.clipboard.writeText(shareText + '\n' + window.location.href);
                afficherNotification('üìã Lien copi√© !', 'linear-gradient(135deg, #4caf50, #45a049)');
            }
        }

        // ========================================
        // FEED SOCIAL
        // ========================================
        
        let socialPosts = [];

        function chargerFeedSocial() {
            // En production, charger depuis Firebase
            // Pour la d√©mo, utiliser des posts g√©n√©r√©s
            socialPosts = genererPostsDemo();
            afficherFeedSocial();
        }

        function genererPostsDemo() {
            return [
                {
                    id: 1,
                    auteur: 'Marie',
                    avatar: 'M',
                    date: '2h',
                    contenu: 'Objectif atteint ! -5kg en 2 mois üéâ',
                    image: null,
                    likes: 23,
                    comments: 8,
                    userLiked: false
                },
                {
                    id: 2,
                    auteur: 'Thomas',
                    avatar: 'T',
                    date: '5h',
                    contenu: 'Nouvelle recette healthy partag√©e ! P√¢tes carbonara light 320 kcal üçù',
                    image: null,
                    likes: 15,
                    comments: 4,
                    userLiked: false
                },
                {
                    id: 3,
                    auteur: 'Sophie',
                    avatar: 'S',
                    date: '1j',
                    contenu: '30 jours de streak ! üî• Je me sens tellement mieux !',
                    image: null,
                    likes: 42,
                    comments: 12,
                    userLiked: true
                }
            ];
        }

        function afficherFeedSocial() {
            const feed = document.getElementById('socialFeed');
            
            feed.innerHTML = socialPosts.map(post => `
                <div class="feed-post">
                    <div class="post-header">
                        <div class="post-avatar">${post.avatar}</div>
                        <div class="post-author">
                            <div class="post-name">
                                ${post.auteur}
                                ${Math.random() > 0.7 ? '<span class="verified-badge">‚úì</span>' : ''}
                            </div>
                            <div class="post-time">${post.date}</div>
                        </div>
                    </div>
                    
                    <div class="post-content">${post.contenu}</div>
                    
                    ${post.image ? `<img src="${post.image}" class="post-image">` : ''}
                    
                    <div class="post-stats">
                        <span>${post.likes} j'aime</span>
                        <span>${post.comments} commentaires</span>
                    </div>
                    
                    <div class="post-actions">
                        <button class="post-action-btn ${post.userLiked ? 'active' : ''}" 
                                onclick="likePost(${post.id})">
                            üëç J'aime
                        </button>
                        <button class="post-action-btn" onclick="commentPost(${post.id})">
                            üí¨ Commenter
                        </button>
                        <button class="post-action-btn" onclick="sharePost(${post.id})">
                            üì§ Partager
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function likePost(postId) {
            const post = socialPosts.find(p => p.id === postId);
            if (post) {
                post.userLiked = !post.userLiked;
                post.likes += post.userLiked ? 1 : -1;
                afficherFeedSocial();
                
                if (post.userLiked) {
                    vibrate([30]);
                }
            }
        }

        function commentPost(postId) {
            afficherNotification('üí¨ Fonctionnalit√© en d√©veloppement', 'linear-gradient(135deg, #667eea, #764ba2)');
        }

        function sharePost(postId) {
            afficherNotification('üì§ Post partag√© !', 'linear-gradient(135deg, #4caf50, #45a049)');
        }

        function createPost() {
            afficherNotification('‚úçÔ∏è Fonctionnalit√© en d√©veloppement', 'linear-gradient(135deg, #667eea, #764ba2)');
        }

        // ========================================
        // STORIES
        // ========================================
        
        const STORIES = {
            nutrition: [
                {
                    type: 'text',
                    content: 'ü•ó Conseil du Jour',
                    subtitle: 'Mange des prot√©ines √† chaque repas pour rester rassasi√© plus longtemps !',
                    background: 'linear-gradient(135deg, #667eea, #764ba2)'
                },
                {
                    type: 'text',
                    content: 'üíß Hydratation',
                    subtitle: 'Bois un verre d\'eau d√®s le r√©veil pour r√©veiller ton m√©tabolisme !',
                    background: 'linear-gradient(135deg, #00c6ff, #0072ff)'
                }
            ],
            recettes: [
                {
                    type: 'text',
                    content: 'üçù P√¢tes Carbonara Light',
                    subtitle: '320 kcal ‚Ä¢ 25g prot√©ines\nRemplace la cr√®me par du fromage blanc !',
                    background: 'linear-gradient(135deg, #f093fb, #f5576c)'
                },
                {
                    type: 'text',
                    content: 'ü•ó Salade C√©sar Healthy',
                    subtitle: '280 kcal ‚Ä¢ 30g prot√©ines\nParmesan + Poulet grill√© !',
                    background: 'linear-gradient(135deg, #4facfe, #00f2fe)'
                }
            ],
            motivation: [
                {
                    type: 'text',
                    content: 'üí™ Tu es capable',
                    subtitle: 'Chaque jour est une nouvelle opportunit√© de progresser !',
                    background: 'linear-gradient(135deg, #fa709a, #fee140)'
                },
                {
                    type: 'text',
                    content: 'üéØ Reste focus',
                    subtitle: 'Le succ√®s, c\'est la somme de petits efforts r√©p√©t√©s !',
                    background: 'linear-gradient(135deg, #30cfd0, #330867)'
                }
            ],
            defis: [
                {
                    type: 'text',
                    content: 'üéØ D√©fi du Jour',
                    subtitle: 'Fais 10 000 pas aujourd\'hui !',
                    background: 'linear-gradient(135deg, #ff6b6b, #ee5a6f)'
                }
            ]
        };

        let currentStory = null;
        let currentStoryIndex = 0;
        let storyTimer = null;

        function viewStory(type) {
            currentStory = STORIES[type];
            currentStoryIndex = 0;
            
            const viewer = document.getElementById('storyViewer');
            viewer.classList.add('active');
            
            showStorySlide();
        }

        function showStorySlide() {
            if (!currentStory || currentStoryIndex >= currentStory.length) {
                closeStory();
                return;
            }
            
            const story = currentStory[currentStoryIndex];
            const content = document.getElementById('storyContent');
            const progressContainer = document.getElementById('storyProgressContainer');
            
            // Cr√©er les barres de progression
            progressContainer.innerHTML = currentStory.map((_, index) => `
                <div class="story-progress-bar">
                    <div class="story-progress-fill" 
                         style="width: ${index < currentStoryIndex ? '100%' : index === currentStoryIndex ? '0%' : '0%'}">
                    </div>
                </div>
            `).join('');
            
            // Afficher le contenu
            content.innerHTML = `
                <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: ${story.background}; color: white; padding: 40px; text-align: center;">
                    <div style="font-size: 3em; margin-bottom: 20px;">${story.content}</div>
                    <div style="font-size: 1.3em; line-height: 1.6; opacity: 0.95;">${story.subtitle}</div>
                </div>
                <button class="story-close" onclick="closeStory()">√ó</button>
            `;
            
            // Animer la barre de progression
            const currentBar = progressContainer.children[currentStoryIndex].children[0];
            setTimeout(() => {
                currentBar.style.width = '100%';
                currentBar.style.transition = 'width 5s linear';
            }, 50);
            
            // Timer pour la prochaine story
            storyTimer = setTimeout(() => {
                currentStoryIndex++;
                showStorySlide();
            }, 5000);
        }

        function closeStory() {
            clearTimeout(storyTimer);
            document.getElementById('storyViewer').classList.remove('active');
            currentStory = null;
            currentStoryIndex = 0;
        }

        // ========================================
        // ROUE DE LA FORTUNE
        // ========================================
        
        let wheelCanvas, wheelCtx;
        let wheelAngle = 0;
        let wheelSpinning = false;
        const wheelPrizes = [
            { text: '+50 XP', color: '#667eea', value: 50 },
            { text: 'Badge Rare', color: '#f093fb', value: 'badge' },
            { text: '+100 XP', color: '#4facfe', value: 100 },
            { text: 'Recette', color: '#fa709a', value: 'recette' },
            { text: '+25 XP', color: '#fee140', value: 25 },
            { text: '+1 Streak', color: '#30cfd0', value: 'streak' }
        ];

        function initWheel() {
            wheelCanvas = document.getElementById('wheelCanvas');
            if (!wheelCanvas) return;
            
            wheelCtx = wheelCanvas.getContext('2d');
            drawWheel();
            checkWheelAvailability();
        }

        function drawWheel() {
            const centerX = wheelCanvas.width / 2;
            const centerY = wheelCanvas.height / 2;
            const radius = 150;
            const sliceAngle = (2 * Math.PI) / wheelPrizes.length;
            
            wheelCtx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
            
            wheelPrizes.forEach((prize, index) => {
                const startAngle = wheelAngle + index * sliceAngle;
                const endAngle = wheelAngle + (index + 1) * sliceAngle;
                
                // Dessiner la section
                wheelCtx.beginPath();
                wheelCtx.arc(centerX, centerY, radius, startAngle, endAngle);
                wheelCtx.lineTo(centerX, centerY);
                wheelCtx.fillStyle = prize.color;
                wheelCtx.fill();
                
                // Bordure
                wheelCtx.strokeStyle = '#fff';
                wheelCtx.lineWidth = 3;
                wheelCtx.stroke();
                
                // Texte
                wheelCtx.save();
                wheelCtx.translate(centerX, centerY);
                wheelCtx.rotate(startAngle + sliceAngle / 2);
                wheelCtx.fillStyle = '#fff';
                wheelCtx.font = 'bold 16px Arial';
                wheelCtx.textAlign = 'center';
                wheelCtx.fillText(prize.text, radius * 0.7, 5);
                wheelCtx.restore();
            });
            
            // Centre de la roue
            wheelCtx.beginPath();
            wheelCtx.arc(centerX, centerY, 20, 0, 2 * Math.PI);
            wheelCtx.fillStyle = '#fff';
            wheelCtx.fill();
            wheelCtx.strokeStyle = '#333';
            wheelCtx.lineWidth = 3;
            wheelCtx.stroke();
            
            // Pointeur
            wheelCtx.save();
            wheelCtx.translate(centerX, 20);
            wheelCtx.beginPath();
            wheelCtx.moveTo(-15, 0);
            wheelCtx.lineTo(15, 0);
            wheelCtx.lineTo(0, 30);
            wheelCtx.closePath();
            wheelCtx.fillStyle = '#ffd700';
            wheelCtx.fill();
            wheelCtx.strokeStyle = '#333';
            wheelCtx.lineWidth = 2;
            wheelCtx.stroke();
            wheelCtx.restore();
        }

        function spinWheel() {
            if (wheelSpinning) return;
            
            const lastSpin = localStorage.getItem('lastWheelSpin');
            const today = new Date().toDateString();
            
            if (lastSpin === today) {
                afficherNotification('‚è∞ Reviens demain !', 'linear-gradient(135deg, #ff9800, #f57c00)');
                return;
            }
            
            wheelSpinning = true;
            document.getElementById('spinButton').disabled = true;
            
            const spinDuration = 4000;
            const minSpins = 5;
            const totalRotation = minSpins * 360 + Math.random() * 360;
            const startTime = Date.now();
            
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / spinDuration, 1);
                
                // Easing
                const easeOut = 1 - Math.pow(1 - progress, 3);
                wheelAngle = (totalRotation * easeOut * Math.PI) / 180;
                
                drawWheel();
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    // Roue arr√™t√©e
                    const normalizedAngle = (wheelAngle % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);
                    const sliceAngle = (2 * Math.PI) / wheelPrizes.length;
                    const winningIndex = Math.floor((2 * Math.PI - normalizedAngle + sliceAngle / 2) / sliceAngle) % wheelPrizes.length;
                    const prize = wheelPrizes[winningIndex];
                    
                    setTimeout(() => {
                        handleWheelPrize(prize);
                        wheelSpinning = false;
                        localStorage.setItem('lastWheelSpin', today);
                        checkWheelAvailability();
                    }, 500);
                }
            }
            
            animate();
            playSound('spin');
        }

        function handleWheelPrize(prize) {
            launchConfetti();
            
            if (typeof prize.value === 'number') {
                gagnerXP('roue', prize.value);
                afficherNotification(
                    `üéâ Tu as gagn√© ${prize.value} XP !`,
                    'linear-gradient(135deg, #ffd700, #ffed4e)'
                );
            } else if (prize.value === 'badge') {
                // D√©bloquer un badge al√©atoire non d√©bloqu√©
                const lockedBadges = Object.keys(BADGES).filter(key => !userProgress.badges.includes(key));
                if (lockedBadges.length > 0) {
                    const randomBadge = lockedBadges[Math.floor(Math.random() * lockedBadges.length)];
                    debloquerBadge(randomBadge);
                } else {
                    gagnerXP('roue', 100);
                    afficherNotification('üéÅ Tous les badges d√©bloqu√©s ! +100 XP', 'linear-gradient(135deg, #4caf50, #45a049)');
                }
            } else if (prize.value === 'recette') {
                afficherNotification('üìñ Recette Premium D√©bloqu√©e !', 'linear-gradient(135deg, #f093fb, #f5576c)');
            } else if (prize.value === 'streak') {
                userProgress.streak++;
                sauvegarderProgress();
                afficherStreak();
                afficherNotification('üî• +1 Jour de Streak !', 'linear-gradient(135deg, #ff6b6b, #ee5a6f)');
            }
        }

        function checkWheelAvailability() {
            const lastSpin = localStorage.getItem('lastWheelSpin');
            const today = new Date().toDateString();
            const button = document.getElementById('spinButton');
            const timer = document.getElementById('wheelTimer');
            
            if (lastSpin === today) {
                button.disabled = true;
                button.textContent = 'D√âJ√Ä TOURN√â';
                
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                const timeLeft = tomorrow - new Date();
                const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                
                timer.textContent = `‚è∞ Prochaine rotation dans ${hoursLeft}h ${minutesLeft}m`;
            } else {
                button.disabled = false;
                button.textContent = 'TOURNER';
                timer.textContent = 'üé∞ Tourne la roue maintenant !';
            }
        }

        // ========================================
        // MOOD TRACKER
        // ========================================
        
        let moodChart = null;
        let moodHistory = JSON.parse(localStorage.getItem('moodHistory')) || [];

        function selectMood(mood) {
            // Mettre √† jour l'UI
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            // Sauvegarder
            const today = new Date().toDateString();
            moodHistory = moodHistory.filter(m => m.date !== today);
            moodHistory.push({ date: today, mood: mood });
            
            // Garder seulement les 30 derniers jours
            if (moodHistory.length > 30) {
                moodHistory = moodHistory.slice(-30);
            }
            
            localStorage.setItem('moodHistory', JSON.stringify(moodHistory));
            
            // Afficher le graphique
            afficherMoodChart();
            
            // Notification
            const messages = {
                'excellent': 'üòÑ Super ! Continue comme √ßa !',
                'bien': 'üôÇ Bien ! Garde le cap !',
                'moyen': 'üòê Courage, √ßa va aller mieux !',
                'fatigue': 'üòì Repose-toi un peu...',
                'difficile': 'üò¢ Tiens bon ! Demain sera meilleur !'
            };
            
            afficherNotification(messages[mood], 'linear-gradient(135deg, #667eea, #764ba2)');
            vibrate([50]);
        }

        function afficherMoodChart() {
            const canvas = document.getElementById('moodChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // D√©truire le graphique pr√©c√©dent
            if (moodChart) {
                moodChart.destroy();
            }
            
            const moodValues = {
                'excellent': 5,
                'bien': 4,
                'moyen': 3,
                'fatigue': 2,
                'difficile': 1
            };
            
            const last7Days = moodHistory.slice(-7);
            const labels = last7Days.map(m => {
                const date = new Date(m.date);
                return date.toLocaleDateString('fr-FR', { weekday: 'short' });
            });
            const data = last7Days.map(m => moodValues[m.mood]);
            
            moodChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Humeur',
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales:scales: {
                        y: {
                            min: 0,
                            max: 5,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    const labels = ['', 'üò¢', 'üòì', 'üòê', 'üôÇ', 'üòÑ'];
                                    return labels[value];
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // ========================================
        // MODE SOMBRE
        // ========================================
        
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            
            localStorage.setItem('darkMode', isDark);
            
            const btn = document.getElementById('darkModeToggle');
            btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            
            afficherNotification(
                isDark ? 'üåô Mode sombre activ√©' : '‚òÄÔ∏è Mode clair activ√©',
                'linear-gradient(135deg, #667eea, #764ba2)'
            );
        }

        function loadDarkModePreference() {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').textContent = '‚òÄÔ∏è';
            }
        }

        // ========================================
        // NOTIFICATIONS SYST√àME
        // ========================================
        
        function afficherNotification(message, background = 'linear-gradient(135deg, #667eea, #764ba2)') {
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${background};
                color: white;
                padding: 20px 25px;
                border-radius: 16px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                z-index: 10001;
                font-weight: 600;
                max-width: 350px;
                animation: slideInRight 0.4s ease-out, fadeOut 0.4s ease-out 2.6s;
                white-space: pre-line;
                text-align: center;
            `;
            notif.textContent = message;
            
            document.body.appendChild(notif);
            
            setTimeout(() => notif.remove(), 3000);
        }

        // ========================================
        // SYST√àME D'ONGLETS
        // ========================================
        
        function showTab(tabName) {
            // Masquer tous les contenus
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // D√©sactiver tous les onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activer l'onglet s√©lectionn√©
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Activer le bouton correspondant
            event?.target?.classList?.add('active');
            
            // Actions sp√©cifiques par onglet
            if (tabName === 'classement') {
                chargerClassement();
            } else if (tabName === 'social') {
                chargerFeedSocial();
            } else if (tabName === 'roue') {
                initWheel();
            } else if (tabName === 'dashboard') {
                afficherDefis();
                afficherBadges();
                afficherMoodChart();
            }
        }

        // ========================================
        // MISE √Ä JOUR DE L'UI
        // ========================================
        
        function updateUI() {
            // Nom utilisateur
            const userName = document.getElementById('userName');
            const userAvatarInitial = document.getElementById('userAvatarInitial');
            
            if (currentUser) {
                const displayName = currentUser.displayName || currentUser.email?.split('@')[0] || 'Utilisateur';
                userName.textContent = displayName;
                userAvatarInitial.textContent = displayName.charAt(0).toUpperCase();
            } else {
                userName.textContent = 'Utilisateur';
                userAvatarInitial.textContent = 'U';
            }
            
            // Niveau et XP
            document.getElementById('userLevelDisplay').textContent = userProgress.niveau;
            
            const xpPercent = (userProgress.xp / userProgress.xpRequis) * 100;
            document.getElementById('xpBarFill').style.width = xpPercent + '%';
            
            // Streak
            afficherStreak();
            
            // Badges
            afficherBadges();
            
            // D√©fis
            afficherDefis();
        }

        // ========================================
        // INT√âGRATION AVEC L'APPLICATION EXISTANTE
        // ========================================
        
        // Wrapper pour les actions existantes pour ajouter la gamification
        
        // Quand l'utilisateur scanne un produit
        const originalScanSuccess = window.onCodeScanned || function() {};
        window.onCodeScanned = function(code) {
            originalScanSuccess(code);
            
            // Gamification
            gagnerXP('scan', 5);
            updateDefiProgress('scan', 1);
            
            // Premier scan ?
            const scanCount = parseInt(localStorage.getItem('scanCount') || '0') + 1;
            localStorage.setItem('scanCount', scanCount);
            
            if (scanCount === 1) {
                debloquerBadge('first_scan');
            }
        };
        
        // Quand l'utilisateur enregistre un repas
        const originalSaveRepas = window.sauvegarderRepas || function() {};
        window.sauvegarderRepas = function() {
            originalSaveRepas();
            
            // Gamification
            gagnerXP('repas', 15);
            updateDefiProgress('calories', 1);
            
            const repasCount = parseInt(localStorage.getItem('repasCount') || '0') + 1;
            localStorage.setItem('repasCount', repasCount);
            
            if (repasCount === 100) {
                debloquerBadge('marathonien');
            }
        };
        
        // Quand l'utilisateur se p√®se
        const originalSavePesee = window.ajouterPesee || function() {};
        window.ajouterPesee = function(poids) {
            originalSavePesee(poids);
            
            // Gamification
            gagnerXP('pesee', 10);
            updateDefiProgress('pesee', 1);
        };
        
        // Quand l'utilisateur partage un produit
        const originalPartagerProduit = window.partagerProduit || function() {};
        window.partagerProduit = function(produit) {
            originalPartagerProduit(produit);
            
            // Gamification
            gagnerXP('partage', 20);
            updateDefiProgress('partage', 1);
            
            const partageCount = parseInt(localStorage.getItem('partageCount') || '0') + 1;
            localStorage.setItem('partageCount', partageCount);
            
            if (partageCount === 10) {
                debloquerBadge('partageur');
            }
        };

        // ========================================
        // SERVICE WORKER (PWA)
        // ========================================
        
        function initPWA() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration);
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            }
            
            // Prompt d'installation
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Afficher un bouton d'installation
                setTimeout(() => {
                    if (confirm('üì± Installer l\'application sur ton √©cran d\'accueil ?')) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('PWA install√©e');
                            }
                            deferredPrompt = null;
                        });
                    }
                }, 5000);
            });
        }

        // ========================================
        // GESTION DES RAPPELS
        // ========================================
        
        function setupReminders() {
            if ('Notification' in window) {
                if (Notification.permission === 'default') {
                    setTimeout(() => {
                        if (confirm('üîî Activer les rappels quotidiens ?')) {
                            Notification.requestPermission();
                        }
                    }, 10000);
                }
            }
            
            // V√©rifier toutes les heures si on doit envoyer un rappel
            setInterval(checkReminders, 60 * 60 * 1000);
        }

        function checkReminders() {
            if (Notification.permission !== 'granted') return;
            
            const now = new Date();
            const hour = now.getHours();
            
            const reminders = {
                8: { title: 'üåÖ Bon matin !', body: 'N\'oublie pas ton petit-d√©jeuner !' },
                12: { title: 'üçΩÔ∏è C\'est l\'heure !', body: 'Pense √† d√©jeuner √©quilibr√©' },
                15: { title: 'üíß Hydratation', body: 'As-tu bu assez d\'eau ?' },
                19: { title: 'ü•ó D√Æner', body: 'Qu\'est-ce que tu manges ce soir ?' },
                22: { title: 'üìä Bilan', body: 'Enregistre ta journ√©e !' }
            };
            
            const lastReminder = localStorage.getItem('lastReminder');
            const todayKey = now.toDateString() + '-' + hour;
            
            if (reminders[hour] && lastReminder !== todayKey) {
                new Notification(reminders[hour].title, {
                    body: reminders[hour].body,
                    icon: '/icon-192.png',
                    badge: '/badge-72.png',
                    vibrate: [200, 100, 200]
                });
                
                localStorage.setItem('lastReminder', todayKey);
            }
        }

        // ========================================
        // GESTION DES ERREURS
        // ========================================
        
        window.addEventListener('error', (event) => {
            console.error('Erreur captur√©e:', event.error);
            // Ne pas afficher de notification pour √©viter de spammer l'utilisateur
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Promise rejet√©e:', event.reason);
        });

        // ========================================
        // ANALYTICS & STATISTIQUES
        // ========================================
        
        function trackEvent(eventName, data = {}) {
            // En production, envoyer √† Firebase Analytics ou autre
            console.log('Event:', eventName, data);
            
            // Stocker localement pour stats
            const events = JSON.parse(localStorage.getItem('appEvents') || '[]');
            events.push({
                name: eventName,
                data: data,
                timestamp: new Date().toISOString()
            });
            
            // Garder seulement les 1000 derniers √©v√©nements
            if (events.length > 1000) {
                events.splice(0, events.length - 1000);
            }
            
            localStorage.setItem('appEvents', JSON.stringify(events));
        }

        // ========================================
        // FONCTIONS UTILITAIRES
        // ========================================
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function throttle(func, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // ========================================
        // INITIALISATION AU CHARGEMENT
        // ========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Application d√©marr√©e');
            
            // Initialiser Firebase
            if (typeof firebase !== 'undefined') {
                try {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    auth = firebase.auth();
                    firebaseInitialized = true;
                    
                    // √âcouter les changements d'authentification
                    auth.onAuthStateChanged(user => {
                        currentUser = user;
                        if (user) {
                            console.log('Utilisateur connect√©:', user.uid);
                            syncUserProgress();
                        }
                        updateUI();
                    });
                } catch (error) {
                    console.error('Erreur init Firebase:', error);
                }
            }
            
            // Charger les pr√©f√©rences
            loadDarkModePreference();
            
            // V√©rifier la streak
            verifierStreak();
            
            // Mettre √† jour l'UI
            updateUI();
            
            // Afficher les d√©fis
            afficherDefis();
            
            // Afficher les badges
            afficherBadges();
            
            // Charger le mood chart
            afficherMoodChart();
            
            // Initialiser la roue
            initWheel();
            
            // Initialiser PWA
            initPWA();
            
            // Setup rappels
            setupReminders();
            
            // Track l'ouverture de l'app
            trackEvent('app_opened');
            
            // Afficher message de bienvenue
            setTimeout(() => {
                afficherNotification(
                    `üëã Salut ! Niveau ${userProgress.niveau} ‚Ä¢ ${userProgress.streak} üî•`,
                    'linear-gradient(135deg, #667eea, #764ba2)'
                );
            }, 1000);
            
            console.log('‚úÖ Initialisation termin√©e');
        });

        // Synchroniser la progression avec Firebase
        async function syncUserProgress() {
            if (!firebaseInitialized || !currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    // Charger depuis Firebase
                    const serverData = userDoc.data();
                    if (serverData.totalXP > userProgress.totalXP) {
                        userProgress = serverData;
                        sauvegarderProgress();
                        updateUI();
                    }
                } else {
                    // Premi√®re connexion, sauvegarder sur Firebase
                    await db.collection('users').doc(currentUser.uid).set({
                        ...userProgress,
                        email: currentUser.email,
                        displayName: currentUser.displayName,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                }
                
                // Mettre √† jour p√©riodiquement
                setInterval(async () => {
                    await db.collection('users').doc(currentUser.uid).update({
                        ...userProgress,
                        updatedAt: new Date()
                    });
                }, 60000); // Toutes les minutes
                
            } catch (error) {
                console.error('Erreur sync:', error);
            }
        }

        // ========================================
        // GESTION DU RESIZE
        // ========================================
        
        const handleResize = debounce(() => {
            // Redessiner les graphiques si n√©cessaire
            if (moodChart) {
                moodChart.resize();
            }
            
            // Redessiner la roue
            if (wheelCanvas) {
                drawWheel();
            }
        }, 250);

        window.addEventListener('resize', handleResize);

        // ========================================
        // GESTION DE LA VISIBILIT√â DE LA PAGE
        // ========================================
        
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // L'utilisateur revient sur l'app
                verifierStreak();
                checkWheelAvailability();
                afficherDefis();
                trackEvent('app_resumed');
            }
        });

        // ========================================
        // GESTION DES GESTES TACTILES
        // ========================================
        
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchEndX - touchStartX;
            
            if (Math.abs(diff) > swipeThreshold) {
                const tabs = ['dashboard', 'profil', 'defis', 'classement', 'social', 'roue'];
                const currentIndex = tabs.findIndex(tab => 
                    document.getElementById(tab)?.classList.contains('active')
                );
                
                if (currentIndex !== -1) {
                    let newIndex;
                    if (diff > 0) {
                        // Swipe vers la droite
                        newIndex = currentIndex > 0 ? currentIndex - 1 : tabs.length - 1;
                    } else {
                        // Swipe vers la gauche
                        newIndex = currentIndex < tabs.length - 1 ? currentIndex + 1 : 0;
                    }
                    
                    showTab(tabs[newIndex]);
                }
            }
        }

        // ========================================
        // EASTER EGGS ü•ö
        // ========================================
        
        let konamiCode = [];
        const konamiSequence = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];

        document.addEventListener('keydown', (e) => {
            konamiCode.push(e.key);
            konamiCode = konamiCode.slice(-10);
            
            if (konamiCode.join(',') === konamiSequence.join(',')) {
                // Easter egg activ√© !
                gagnerXP('secret', 1000);
                launchConfetti();
                afficherNotification(
                    'üéÆ KONAMI CODE !\n+1000 XP Bonus !',
                    'linear-gradient(135deg, #ffd700, #ffed4e)'
                );
                konamiCode = [];
            }
        });

        // Triple clic sur le logo
        let logoClickCount = 0;
        let logoClickTimer = null;

        document.getElementById('userAvatarBtn')?.addEventListener('click', () => {
            logoClickCount++;
            
            clearTimeout(logoClickTimer);
            logoClickTimer = setTimeout(() => {
                if (logoClickCount === 3) {
                    // Triple clic d√©tect√©
                    gagnerXP('secret', 500);
                    afficherNotification(
                        'üîÆ Secret d√©couvert !\n+500 XP Bonus !',
                        'linear-gradient(135deg, #667eea, #764ba2)'
                    );
                    vibrate([50, 50, 50]);
                }
                logoClickCount = 0;
            }, 500);
        });

        // ========================================
        // FONCTIONS GLOBALES EXPORT√âES
        // ========================================
        
        window.MonCoachMinceur = {
            gagnerXP,
            debloquerBadge,
            updateDefiProgress,
            afficherNotification,
            launchConfetti,
            playSound,
            vibrate,
            trackEvent
        };

        console.log('üí™ Mon Coach Minceur V2.0 - Pr√™t !');
        
    </script>
</body>
</html>
